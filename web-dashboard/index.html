<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levante Translation & Audio Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .controls-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            min-width: 120px;
        }

        .search-container {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .voice-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .voice-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .voice-group label {
            font-size: 14px;
            color: #666;
            min-width: auto;
        }

        .voice-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .ssml-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            margin-top: 10px;
        }

        .tabs {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: #f8f9fa;
            color: #666;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .data-table th {
            background: #4facfe;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.3s;
            vertical-align: top;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: #e3f2fd;
        }

        .data-table .text-cell {
            max-width: 200px;
            word-wrap: break-word;
            font-size: 12px;
            line-height: 1.4;
        }

        .data-table .audio-path {
            font-size: 10px;
            color: #6c757d;
            max-width: 180px;
            word-break: break-all;
            font-family: monospace;
        }

        .data-table td:first-child {
            font-weight: bold;
            color: #007bff;
            min-width: 100px;
        }

        .data-table td:nth-child(2) {
            color: #28a745;
            font-weight: 500;
            min-width: 120px;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            z-index: 1000;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .credential-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .form-group {
            margin: 10px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .help-text a {
            color: #4facfe;
            text-decoration: none;
        }

        .help-text a:hover {
            text-decoration: underline;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .security-note {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            margin-top: 20px;
        }

        .security-note p {
            margin: 0;
            font-size: 12px;
            color: #155724;
        }

        .credentials-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .voice-controls {
                flex-direction: column;
            }
            
            .tab-buttons {
                flex-wrap: wrap;
            }

            .modal-actions {
                flex-direction: column;
            }

            .credentials-button {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1><i class="fas fa-microphone"></i> Levante Translation & Audio Dashboard</h1>
            <p>Compare and generate TTS audio across multiple languages and services</p>
            <button onclick="showCredentialsSetup()" class="btn btn-info credentials-button">
                <i class="fas fa-key"></i> API Keys
            </button>
        </div>

        <div class="main-content">
            <!-- Search Section -->
            <div class="controls-section">
                <div class="control-group">
                    <label for="searchInput"><i class="fas fa-search"></i> Search Items:</label>
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by item ID or text content...">
                    </div>
                </div>
            </div>

            <!-- Voice Comparison Section -->
            <div class="controls-section">
                <div class="control-group">
                    <label><i class="fas fa-volume-up"></i> Voice Comparison:</label>
                    <div class="voice-controls">
                        <div class="voice-group">
                            <label for="playhtVoice">PlayHT Voice:</label>
                            <select id="playhtVoice" class="voice-select">
                                <option value="">Select PlayHT Voice...</option>
                            </select>
                        </div>
                        <div class="voice-group">
                            <label for="elevenlabsVoice">ElevenLabs Voice:</label>
                            <select id="elevenlabsVoice" class="voice-select">
                                <option value="">Select ElevenLabs Voice...</option>
                            </select>
                        </div>
                        <button id="refreshVoices" class="btn btn-info">
                            <i class="fas fa-sync-alt"></i> Refresh Voices
                        </button>
                    </div>
                </div>
            </div>

            <!-- SSML Editor Section -->
            <div class="controls-section">
                <div class="control-group">
                    <label for="ssmlEditor"><i class="fas fa-code"></i> SSML Editor:</label>
                    <button id="playSSML" class="btn btn-success">
                        <i class="fas fa-play"></i> Play SSML
                    </button>
                    <button onclick="showCredentialsSetup()" class="btn btn-info">
                        <i class="fas fa-key"></i> Manage API Keys
                    </button>
                    <button id="debugVoices" class="btn btn-secondary">
                        <i class="fas fa-bug"></i> Debug Voices
                    </button>
                    <button onclick="window.dashboard?.testFunction()" class="btn btn-warning">
                        <i class="fas fa-test-tube"></i> Test JS
                    </button>
                </div>
                <textarea id="ssmlEditor" class="ssml-textarea" placeholder="Enter text or SSML here..."></textarea>
            </div>

            <!-- Language Tabs -->
            <div class="tabs">
                <div class="tab-buttons" id="tabButtons">
                    <!-- Tabs will be populated by JavaScript -->
                </div>
            </div>

            <!-- Tab Content -->
            <div id="tabContent">
                <!-- Tab content will be populated by JavaScript -->
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Processing audio...</p>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            Ready
        </div>
    </div>

    <!-- Load comprehensive voices -->
    <script src="comprehensive-voices.js"></script>
    
    <script>
        // Embedded JavaScript to avoid serving issues
        class AudioDashboard {
            constructor() {
                this.languages = {
                    'English': { lang_code: 'en', service: 'ElevenLabs', voice: 'Alexandra - Conversational and Real' },
                    'Spanish': { lang_code: 'es-CO', service: 'ElevenLabs', voice: 'Ana María - Calm & natural neutral Spanish' },
                    'German': { lang_code: 'de', service: 'PlayHT', voice: 'German_Anke Narrative' },
                    'French': { lang_code: 'fr-CA', service: 'ElevenLabs', voice: 'Caroline - Top France - Narrative, warm, sweet' },
                    'Dutch': { lang_code: 'nl', service: 'ElevenLabs', voice: 'Emma - Natural conversations in Dutch' }
                };

                this.data = [];
                this.currentLanguage = 'English';
                this.selectedRow = null;

                // Initialize voices object
                this.voices = {
                    playht: [],
                    elevenlabs: []
                };

                // Initialize API credentials
                this.apiCredentials = this.loadStoredCredentials();

                this.init();
            }

            async init() {
                console.log('Initializing Audio Dashboard...');
                this.setStatus('Loading dashboard...');
                
                try {
                    // Load data first
                    console.log('Loading data...');
                    await this.loadData();
                    console.log('Data loaded successfully');
                    
                    // Create tabs after data is loaded
                    console.log('Creating tabs...');
                    this.createTabs();
                    console.log('Tabs created successfully');
                    
                    // Setup event listeners
                    console.log('Setting up event listeners...');
                    this.setupEventListeners();
                    console.log('Event listeners set up successfully');
                    
                    // Always load comprehensive voices first (they don't need credentials)
                    console.log('Loading comprehensive voices...');
                    await this.loadComprehensiveVoices();
                    console.log('Comprehensive voices loaded successfully');
                    
                    // Then load API voices if we have credentials
                    const credentials = this.loadCredentials();
                    if ((credentials.playht.apiKey && credentials.playht.userId) || credentials.elevenlabs.apiKey) {
                        console.log('Loading API voices...');
                        await this.loadVoices();
                        console.log('API voices loaded successfully');
                    }
                    
                    // Check if credentials are needed and prompt if missing (after everything is loaded)
                    console.log('Checking credentials...');
                    await this.checkAndPromptCredentials();
                    console.log('Credentials check complete');
                    
                    this.setStatus('Dashboard ready!');
                    console.log('Dashboard initialization complete');
                } catch (error) {
                    console.error('Error during dashboard initialization:', error);
                    this.setStatus(`Error: ${error.message}`);
                    throw error;
                }
            }

            loadCredentials() {
                return {
                    playht: {
                        apiKey: localStorage.getItem('playht_api_key') || '',
                        userId: localStorage.getItem('playht_user_id') || ''
                    },
                    elevenlabs: {
                        apiKey: localStorage.getItem('elevenlabs_api_key') || ''
                    }
                };
            }

            loadStoredCredentials() {
                return this.loadCredentials();
            }

            saveCredentials(credentials) {
                if (credentials.playht) {
                    if (credentials.playht.apiKey) {
                        localStorage.setItem('playht_api_key', credentials.playht.apiKey);
                    }
                    if (credentials.playht.userId) {
                        localStorage.setItem('playht_user_id', credentials.playht.userId);
                    }
                }
                if (credentials.elevenlabs && credentials.elevenlabs.apiKey) {
                    localStorage.setItem('elevenlabs_api_key', credentials.elevenlabs.apiKey);
                }
                this.apiCredentials = this.loadStoredCredentials();
            }

            clearCredentials() {
                localStorage.removeItem('playht_api_key');
                localStorage.removeItem('playht_user_id');
                localStorage.removeItem('elevenlabs_api_key');
                this.apiCredentials = this.loadStoredCredentials();
            }

            async checkAndPromptCredentials() {
                const needsPlayHT = !this.apiCredentials.playht.apiKey || !this.apiCredentials.playht.userId;
                const needsElevenLabs = !this.apiCredentials.elevenlabs.apiKey;

                console.log('Checking credentials:', { needsPlayHT, needsElevenLabs });
                console.log('Current credentials:', this.apiCredentials);

                if (needsPlayHT || needsElevenLabs) {
                    console.log('Credentials missing, but not showing modal automatically');
                    this.setStatus('💡 Click "API Keys" to add credentials for voice generation');
                } else {
                    console.log('Credentials found, loading voices');
                    await this.loadVoices();
                }
            }

            showCredentialsModal(needsPlayHT = true, needsElevenLabs = true) {
                console.log('Creating credentials modal');
                
                // Remove existing modal if present
                const existingModal = document.getElementById('credentialsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create modal HTML
                const modalHTML = `
                    <div id="credentialsModal" class="modal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
                        <div class="modal-content" style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; position: relative;">
                            <span class="close" onclick="closeCredentialsModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                            <h2>🔐 API Credentials Setup</h2>
                            <p>To use the voice generation features, please enter your API credentials. These will be stored securely in your browser's local storage.</p>
                            
                            ${needsPlayHT ? `
                            <div class="credential-section">
                                <h3>PlayHT Credentials</h3>
                                <div class="form-group">
                                    <label for="playhtApiKey">PlayHT API Key:</label>
                                    <input type="password" id="playhtApiKey" placeholder="Enter your PlayHT API key" value="${this.apiCredentials.playht.apiKey}">
                                </div>
                                <div class="form-group">
                                    <label for="playhtUserId">PlayHT User ID:</label>
                                    <input type="text" id="playhtUserId" placeholder="Enter your PlayHT User ID" value="${this.apiCredentials.playht.userId}">
                                </div>
                                <p class="help-text">Get your credentials at: <a href="https://play.ht/studio/api-access" target="_blank">PlayHT API Access</a></p>
                            </div>
                            ` : ''}
                            
                            ${needsElevenLabs ? `
                            <div class="credential-section">
                                <h3>ElevenLabs Credentials</h3>
                                <div class="form-group">
                                    <label for="elevenlabsApiKey">ElevenLabs API Key:</label>
                                    <input type="password" id="elevenlabsApiKey" placeholder="Enter your ElevenLabs API key" value="${this.apiCredentials.elevenlabs.apiKey}">
                                </div>
                                <p class="help-text">Get your API key at: <a href="https://elevenlabs.io/speech-synthesis" target="_blank">ElevenLabs Dashboard</a></p>
                            </div>
                            ` : ''}
                            
                            <div class="modal-actions">
                                <button onclick="saveCredentialsFromModal()" class="btn btn-primary">Save Credentials</button>
                                <button onclick="clearAllCredentials()" class="btn btn-secondary">Clear All</button>
                                <button onclick="closeCredentialsModal()" class="btn btn-secondary">Skip for Now</button>
                            </div>
                            
                            <div class="security-note">
                                <p><strong>🔒 Security Note:</strong> Your credentials are stored only in your browser's local storage and are never sent to our servers. They are used only for direct API calls to PlayHT and ElevenLabs.</p>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                console.log('Credentials modal added to page');
            }

            async loadData() {
                try {
                    console.log('Attempting to load real translation data from GitHub...');
                    this.data = await this.loadTranslationData();
                    console.log(`Successfully loaded ${this.data.length} real translation items`);
                    this.setStatus(`✅ Loaded ${this.data.length} real translation items from GitHub`);
                } catch (error) {
                    console.error('Error loading real data, falling back to sample data:', error);
                    console.log('Loading sample translation data...');
                    this.data = await this.loadSampleData();
                    console.log(`Loaded ${this.data.length} sample translation items`);
                    this.setStatus(`⚠️ Using sample data (${this.data.length} items) - could not load from GitHub`);
                }
            }

            async loadComprehensiveVoices() {
                console.log('Loading comprehensive voices...');
                this.setStatus('Loading comprehensive voices...');
                
                // Load comprehensive voices without requiring API credentials
                try {
                    await this.loadPlayHTVoicesFromComprehensive();
                    await this.loadElevenLabsVoicesFromComprehensive();
                    console.log('Comprehensive voices loaded successfully');
                    this.populateVoiceDropdowns();
                    this.setStatus('✅ Comprehensive voices loaded successfully');
                } catch (error) {
                    console.error('Error loading comprehensive voices:', error);
                    this.setStatus('⚠️ Error loading comprehensive voices');
                }
            }

            async loadVoices() {
                console.log('Loading API voices...');
                this.setStatus('Loading API voices...');
                
                const credentials = this.loadCredentials();
                
                // Load PlayHT voices if credentials available
                if (credentials.playht.apiKey && credentials.playht.userId) {
                    try {
                        await this.loadPlayHTVoices(credentials.playht);
                        console.log('PlayHT voices loaded successfully');
                    } catch (error) {
                        console.error('Error loading PlayHT voices:', error);
                    }
                }
                
                // Load ElevenLabs voices if credentials available
                if (credentials.elevenlabs.apiKey) {
                    try {
                        await this.loadElevenLabsVoices(credentials.elevenlabs);
                        console.log('ElevenLabs voices loaded successfully');
                    } catch (error) {
                        console.error('Error loading ElevenLabs voices:', error);
                    }
                }
                
                this.populateVoiceDropdowns();
                this.setStatus('✅ Voices loaded successfully');
            }

            async loadPlayHTVoicesFromComprehensive() {
                console.log('Loading PlayHT voices from comprehensive data...');
                
                // Use comprehensive voices from the generated JavaScript file
                if (typeof COMPREHENSIVE_VOICES !== 'undefined' && COMPREHENSIVE_VOICES.playht) {
                    // Convert comprehensive voices format to dashboard format
                    this.voices.playht = [];
                    
                    // Load voices from all languages
                    for (const [langCode, voices] of Object.entries(COMPREHENSIVE_VOICES.playht)) {
                        for (const voice of voices) {
                            this.voices.playht.push({
                                voice_id: voice.voice_id, // Keep the comprehensive format
                                id: voice.voice_id, // Also add id for backward compatibility
                                name: voice.name,
                                labels: voice.labels, // Keep the comprehensive format
                                language: voice.labels.language, // Also add for backward compatibility
                                gender: voice.labels.gender,
                                category: voice.category,
                                description: voice.description,
                                sample_url: voice.sample_url
                            });
                        }
                    }
                    
                    console.log(`Loaded ${this.voices.playht.length} PlayHT voices from comprehensive data`);
                    return true;
                } else {
                    console.warn('Comprehensive voices not available');
                    return false;
                }
            }

            async loadPlayHTVoices(credentials) {
                console.log('Loading PlayHT voices via API...');
                
                // If comprehensive voices are already loaded, don't override them
                if (this.voices.playht.length > 0) {
                    console.log('PlayHT voices already loaded from comprehensive data');
                    return;
                }
                
                // Fallback to API loading or basic voices
                console.warn('Loading fallback voices');
                    
                    // Fallback to basic voices if comprehensive voices aren't available
                    this.voices.playht = [
                    // English voices (female only)
                    { id: 's3://voice-cloning-zero-shot/f6c4ed76-1b55-4cd9-8896-31f7535f6cdb/original/manifest.json', name: 'Aaliyah', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/80ba8839-a6e6-470c-8f68-7c1e5d3ee2ff/abigailsaad/manifest.json', name: 'Abigail', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/abigail_vo_6661b91f-4012-44e3-ad12-589fbdee9948/voices/speaker/manifest.json', name: 'Abigail (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/f9bf96ae-19ef-491f-ae69-644448800566/original/manifest.json', name: 'Adelaide', language: 'en', gender: 'female' },
                    { id: 'alphonso', name: 'Alphonso', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/34eaa933-62cb-4e32-adb8-c1723ef85097/original/manifest.json', name: 'Amelia', language: 'en', gender: 'female' },
                    { id: 'anny', name: 'Anny', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/9a5deeda-3025-49c5-831a-ac98f86f2a37/aprilsaad/manifest.json', name: 'April', language: 'en', gender: 'female' },
                    { id: 'spencer', name: 'April (Spencer)', language: 'en', gender: 'female' },
                    { id: 'victor', name: 'Ariana', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/f2863f63-5334-4f65-9d30-438feb79c2ec/arianasaad2/manifest.json', name: 'Ariana (Videos)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/42c41808-0ddb-4674-8965-024a52ad6c8e/original/manifest.json', name: 'Arista', language: 'en', gender: 'female' },
                    { id: 'hipolito', name: 'Audrey', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/8ceaa707-4141-46c0-a610-4a2014d7ea97/audreysaad/manifest.json', name: 'Audrey (Narrative)', language: 'en', gender: 'female' },
                    { id: 'aurora', name: 'Aurora', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/5b81dc4c-bf98-469d-96b4-8f09836fb500/aurorasaad/manifest.json', name: 'Aurora (Training)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/ff414883-0e32-4a92-a688-d7875922120d/original/manifest.json', name: 'Autumn', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/ayla_vo_expressive_16095e08-b9e8-429b-947c-47a75e41053b/voices/speaker/manifest.json', name: 'Ayla (Expressive)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/ayla_vo_meditation_d11dd9da-b5f1-4709-95a6-e6d5dc77614a/voices/speaker/manifest.json', name: 'Ayla (Meditation)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/ayla_vo_narrative_d8199dfd-b50f-40c7-9d99-e203ba5f4152/voices/speaker/manifest.json', name: 'Ayla (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/ayla_vo_training_e6751ca5-e47c-4c4b-ad05-d3a194417600/voices/speaker/manifest.json', name: 'Ayla (Training)', language: 'en', gender: 'female' },
                    { id: 'bret', name: 'Bret', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/24507c14-c743-4943-80db-a1e16248309a/original/manifest.json', name: 'Celeste', language: 'en', gender: 'female' },
                    { id: 'charlotte', name: 'Charlotte', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/b2f5441d-354f-4c2f-8f32-390aaaabf42d/charlottesaad/manifest.json', name: 'Charlotte (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/charlotte meditation 2 parrot saad/manifest.json', name: 'Charlotte (Meditation)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/charlotte_vo_narrative_9290be17-ccea-4700-a7fd-a8fe5c49fb20/voices/speaker/manifest.json', name: 'Charlotte (Narrative V2)', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/charlotte_training_parrot_saad/manifest.json', name: 'Charlotte (Training)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/ae86f8a3-76bf-4ded-a5fd-bea9d1c8ea1a/original/manifest.json', name: 'Cheyenne', language: 'en', gender: 'female' },
                    { id: 'daisy', name: 'Daisy', language: 'en', gender: 'female' },
                    { id: 'ignacio', name: 'Delilah', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/1afba232-fae0-4b69-9675-7f1aac69349f/delilahsaad/manifest.json', name: 'Delilah (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/donna_meditation_saad/manifest.json', name: 'Donna (Meditation)', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/donna_parrot_saad/manifest.json', name: 'Donna (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/eileen_vo_5d7b2bcc-d635-4301-97e8-d97c13768514/voices/speaker/manifest.json', name: 'Eileen', language: 'en', gender: 'female' },
                    { id: 'ellie', name: 'Ellie', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/evelyn 2 saad parrot/manifest.json', name: 'Evelyn', language: 'en', gender: 'female' },
                    { id: 'bill', name: 'Harper', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/adb83b67-8d75-48ff-ad4d-a0840d231ef1/original/manifest.json', name: 'Inara', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/97580643-b568-4198-aaa4-3e07e4a06c47/original/manifest.json', name: 'Indigo', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/a0fa25cc-5f42-4dd0-8a78-a950dd5297cd/original/manifest.json', name: 'Isabella', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/801a663f-efd0-4254-98d0-5c175514c3e8/jennifer/manifest.json', name: 'Jennifer', language: 'en', gender: 'female' },
                    { id: 'lillian', name: 'Lillian', language: 'en', gender: 'female' },
                    { id: 'lottie', name: 'Lottie', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/640a6636-dc16-4911-b75a-1549daae2c71/original/manifest.json', name: 'Lumi', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/f43cc4b4-b193-4a13-a903-e6b125c3d572/original/manifest.json', name: 'Luna', language: 'en', gender: 'female' },
                    { id: 'mickey', name: 'Madelyn', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/0a11e4f0-1656-48c9-bc4c-affcd718c414/madelynsaad/manifest.json', name: 'Madelyn (Videos)', language: 'en', gender: 'female' },
                    { id: 'florencio', name: 'Madison', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/473c81b1-93ea-4662-9e63-7d65392e5f9b/madisonsaad/manifest.json', name: 'Madison (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/mel21/manifest.json', name: 'Melissa', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/ef6c757b-181e-472d-84c4-af52f502aee6/original/manifest.json', name: 'Mia', language: 'en', gender: 'female' },
                    { id: 'micah', name: 'Micah', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/a5cc7dd9-069c-4fe8-9ae7-0c4bae4779c5/micahsaad/manifest.json', name: 'Micah (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/e5df2eb3-5153-40fa-9f6e-6e27bbb7a38e/original/manifest.json', name: 'Navya', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/831bd330-85c6-4333-b2b4-10c476ea3491/original/manifest.json', name: 'Nia', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/928ed0a0-2271-4710-a7c9-1711d36b9897/original/manifest.json', name: 'Niamh', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/7c38b588-14e8-42b9-bacd-e03d1d673c3c/nicole/manifest.json', name: 'Nicole', language: 'en', gender: 'female' },
                    { id: 'nova', name: 'Nova', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/2a7ddfc5-d16a-423a-9441-5b13290998b8/novasaad/manifest.json', name: 'Nova (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://peregrine-voices/olivia_ads3_parrot_saad/manifest.json', name: 'Olivia (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/olivia_vo_training_4376204f-a411-4e5d-a5c0-ce6cc3908052/voices/speaker/manifest.json', name: 'Olivia (Training)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/2a7ddfc5-d16a-423a-9441-5b13290998b8/novasaad/manifest.json', name: 'Paloma', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/d901eb2c-a2f1-4d67-9110-2f90817234a6/original/manifest.json', name: 'Pearl', language: 'en', gender: 'female' },
                    { id: 'phoebe', name: 'Phoebe', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/0c4c229f-7f99-4ed9-b904-223c701672b9/phoebesaad/manifest.json', name: 'Phoebe (Videos)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/74f59ea4-f07b-4d10-88d1-ca174adac3f3/original/manifest.json', name: 'Pia', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/d9ff78ba-d016-47f6-b0ef-dd630f59414e/female-cs/manifest.json', name: 'Ruby', language: 'en', gender: 'female' },
                    { id: 'gabriel', name: 'Samantha', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/0b423fde-02e2-4bea-91ce-c932162e4428/samanthasaad/manifest.json', name: 'Samantha (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/90217770-a480-4a91-b1ea-df00f4d4c29d/original/manifest.json', name: 'Samara', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/820da3d2-3a3b-42e7-844d-e68db835a206/sarah/manifest.json', name: 'Sarah', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/32b943f6-87cf-4e15-8e7a-d4cb848e3689/original/manifest.json', name: 'Scarlett', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/30884451-1eff-4fd8-9a24-d1ee3353b215/original/manifest.json', name: 'Siobhán', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/1f44b3e7-22ea-4c2e-87d0-b4d9c8f1d47d/sophia/manifest.json', name: 'Sophia', language: 'en', gender: 'female' },
                    { id: 'stella', name: 'Stella', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/f3c22a65-87e8-441f-aea5-10a1c201e522/original/manifest.json', name: 'Sumita', language: 'en', gender: 'female' },
                    { id: 'susan', name: 'Susan', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/65e66dc8-9273-43c8-889a-83e858bf2bb8/susansaad/manifest.json', name: 'Susan (Videos)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/susan_vo_narrative_73051c90-460b-4e54-adab-9235f45c5e5f/voices/speaker/manifest.json', name: 'Susan (Narrative)', language: 'en', gender: 'female' },
                    { id: 's3://mockingbird-prod/susan_vo_training_46ffcc60-d630-42f6-acfe-4affd003ae7a/voices/speaker/manifest.json', name: 'Susan (Training)', language: 'en', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/e8032164-b736-4a75-93f4-824632ddc1ac/original/manifest.json', name: 'Zoe', language: 'en', gender: 'female' },
                    
                    // French voices (female only)
                    { id: 's3://voice-cloning-zero-shot/09993052-0db5-4f9d-9eb4-30da05282f44/original/manifest.json', name: 'Ange Conversational', language: 'fr', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/067f8a04-9138-440b-971d-5cce69f4c271/original/manifest.json', name: 'Ange Narrative', language: 'fr', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/7101ecc1-8071-47c8-a7d2-ffef2000616c/original/manifest.json', name: 'Gaelle Conversational', language: 'fr', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/19561064-851a-4740-95fa-34d4bf16fa4f/original/manifest.json', name: 'Gaelle Narrative', language: 'fr', gender: 'female' },
                    
                    // German voices (female only)
                    { id: 's3://voice-cloning-zero-shot/c1cb7f62-4a59-4593-b6c6-6b430892541d/original/manifest.json', name: 'Anke Conversational', language: 'de', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/2f91566e-215a-4234-96e2-60acf07fed5e/original/manifest.json', name: 'Anke Narrative', language: 'de', gender: 'female' },
                    
                    // Spanish voices (female only)
                    { id: 's3://voice-cloning-zero-shot/e0bf73c2-2b50-455a-8524-cc29de4360d1/original/manifest.json', name: 'Patricia Conversational', language: 'es', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/5694d5e5-2dfe-4440-8cc8-e2a69c3e7560/original/manifest.json', name: 'Patricia Narrative', language: 'es', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/4289181f-48fc-4c52-911f-6e769086eb98/original/manifest.json', name: 'Violeta Conversational', language: 'es', gender: 'female' },
                    { id: 's3://voice-cloning-zero-shot/326c3793-b5b1-4ce3-a8ec-22c95d8553f0/original/manifest.json', name: 'Violeta Narrative', language: 'es', gender: 'female' }
                    ];
                    
                    console.log(`Loaded ${this.voices.playht.length} PlayHT fallback voices`);
                    this.setStatus(`⚠️ PlayHT voices loaded: ${this.voices.playht.length} fallback voices`);
                }
            }

            async loadElevenLabsVoicesFromComprehensive() {
                console.log('Loading ElevenLabs voices from comprehensive data...');
                
                // Use comprehensive voices from the generated JavaScript file
                if (typeof COMPREHENSIVE_VOICES !== 'undefined' && COMPREHENSIVE_VOICES.elevenlabs) {
                    // Convert comprehensive voices format to dashboard format
                    this.voices.elevenlabs = [];
                    
                    // Load voices from all languages
                    for (const [langCode, voices] of Object.entries(COMPREHENSIVE_VOICES.elevenlabs)) {
                        for (const voice of voices) {
                            this.voices.elevenlabs.push({
                                voice_id: voice.voice_id,
                                name: voice.name,
                                labels: voice.labels,
                                category: voice.category,
                                description: voice.description,
                                sample_url: voice.sample_url
                            });
                        }
                    }
                    
                    console.log(`Loaded ${this.voices.elevenlabs.length} ElevenLabs voices from comprehensive data`);
                    return true;
                } else {
                    console.warn('Comprehensive voices not available');
                    return false;
                }
            }

            async loadElevenLabsVoices(credentials) {
                console.log('Loading ElevenLabs voices via API...');
                
                // If comprehensive voices are already loaded, don't override them
                if (this.voices.elevenlabs.length > 0) {
                    console.log('ElevenLabs voices already loaded from comprehensive data');
                    return;
                }
                
                // Fallback to API loading or basic voices
                console.warn('Loading fallback voices');
                    
                // Fallback to basic voices if comprehensive voices aren't available
                this.voices.elevenlabs = [
                    { voice_id: 'kdmDKE6EkgrWrrykO9Qt', name: 'Alexandra - Conversational and Real', labels: { language: 'en', gender: 'female' }, category: 'professional' },
                    { voice_id: 'yu4eXTP5aod8KAQzTI3T', name: 'Claudia - Credible, Competent & Authentic', labels: { language: 'en', gender: 'female' }, category: 'professional' },
                    { voice_id: 'aMSt68OGf4xUZAnLpTU8', name: 'Juniper', labels: { language: 'en', gender: 'female' }, category: 'professional' }
                ];
                
                console.log(`Loaded ${this.voices.elevenlabs.length} ElevenLabs fallback voices`);
                this.setStatus(`⚠️ ElevenLabs voices loaded: ${this.voices.elevenlabs.length} fallback voices`);
            }

            isFemaleVoice(voiceName) {
                const femaleNames = [
                    'alexandra', 'charlotte', 'susan', 'olivia', 'emma', 'sophia', 'isabella',
                    'ava', 'mia', 'abigail', 'emily', 'harper', 'amelia', 'evelyn', 'elizabeth',
                    'sofia', 'madison', 'avery', 'ella', 'scarlett', 'grace', 'chloe', 'victoria',
                    'riley', 'aria', 'hailey', 'hannah', 'aaliyah', 'addison', 'mackenzie',
                    'violeta', 'anke', 'ange', 'yasmine', 'claudia', 'zuri', 'nia', 'juniper',
                    'jessica', 'fenna', 'xander' // Note: Xander is actually male but used for Dutch
                ];
                
                const name = voiceName.toLowerCase();
                return femaleNames.some(femaleName => name.includes(femaleName));
            }

            populateVoiceDropdowns() {
                const playhtSelect = document.getElementById('playhtVoice');
                const elevenlabsSelect = document.getElementById('elevenlabsVoice');
                
                if (!playhtSelect || !elevenlabsSelect) {
                    console.error('Voice dropdown elements not found');
                    return;
                }
                
                // Clear existing options
                playhtSelect.innerHTML = '<option value="">🎤 Choose a PlayHT voice...</option>';
                elevenlabsSelect.innerHTML = '<option value="">🎤 Choose an ElevenLabs voice...</option>';
                
                // Check if we have voices to populate
                if (this.voices.playht.length === 0 && this.voices.elevenlabs.length === 0) {
                    playhtSelect.innerHTML = '<option value="">⚠️ No voices - Click "Manage API Keys" first</option>';
                    elevenlabsSelect.innerHTML = '<option value="">⚠️ No voices - Click "Manage API Keys" first</option>';
                    return;
                }
                
                // Get current language and map to language codes
                const currentLang = this.getCurrentLanguage();
                const currentLangCode = this.languages[currentLang]?.lang_code || 'en';
                
                // Map complex codes to simple codes for comprehensive voice filtering
                const simpleCodeMap = {
                    'en': 'en',
                    'es-CO': 'es',
                    'de': 'de', 
                    'fr-CA': 'fr',
                    'nl': 'nl'
                };
                
                const simpleLangCode = simpleCodeMap[currentLangCode] || currentLangCode;
                
                // Filter PlayHT voices for current language
                const filteredPlayHTVoices = this.voices.playht.filter(voice => {
                    // Check both voice.language (fallback format) and voice.labels.language (comprehensive format)
                    const voiceLangSource = voice.labels?.language || voice.language;
                    if (!voiceLangSource) return false;
                    const voiceLang = voiceLangSource.toLowerCase();
                    
                    // Match against both simple and complex language codes
                    return voiceLang === simpleLangCode.toLowerCase() || 
                           voiceLang === currentLangCode.toLowerCase() ||
                           voiceLang.startsWith(simpleLangCode.toLowerCase());
                });
                
                // Populate PlayHT voices (filtered by current language)
                filteredPlayHTVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voice_id || voice.id; // Use voice_id from comprehensive format, fallback to id
                    option.textContent = voice.name;
                    playhtSelect.appendChild(option);
                });
                
                // Filter ElevenLabs voices for current language
                const filteredElevenLabsVoices = this.voices.elevenlabs.filter(voice => {
                    if (!voice.labels || !voice.labels.language) return false; // Don't show if no language info
                    const voiceLang = voice.labels.language.toLowerCase();
                    
                    // Match against both simple and complex language codes
                    return voiceLang === simpleLangCode.toLowerCase() || 
                           voiceLang === currentLangCode.toLowerCase() ||
                           voiceLang.startsWith(simpleLangCode.toLowerCase());
                });
                
                // Populate ElevenLabs voices (filtered by current language)
                filteredElevenLabsVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voice_id;
                    option.textContent = voice.name;
                    elevenlabsSelect.appendChild(option);
                });
                
                console.log(`Voice dropdowns populated for ${currentLang}: ${filteredPlayHTVoices.length} PlayHT, ${filteredElevenLabsVoices.length} ElevenLabs`);
            }

            async loadTranslationData() {
                // Use the same URL as the Python version from config.py
                const csvUrl = 'https://raw.githubusercontent.com/levante-framework/levante_translations/l10n_pending/text/translated_prompts.csv';
                
                try {
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    return this.parseCSV(csvText);
                } catch (error) {
                    console.warn('Could not load from GitHub:', error);
                    throw new Error('Could not load translation data from GitHub');
                }
            }

            parseCSV(csvText) {
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = this.parseCSVLine(lines[i]);
                        if (values.length >= headers.length) {
                            const row = {};
                            headers.forEach((header, index) => {
                                // Map CSV columns to our expected format
                                if (header === 'identifier') {
                                    row.item_id = values[index];
                                } else if (header === 'text') {
                                    row.en = values[index];
                                } else if (header === 'es-CO') {
                                    row['es-CO'] = values[index];  // Keep es-CO as is
                                } else if (header === 'fr-CA') {
                                    row['fr-CA'] = values[index];  // Keep fr-CA as is
                                } else if (header === 'nl-NL') {
                                    row.nl = values[index];  // Map nl-NL to nl since config uses nl
                                } else {
                                    row[header] = values[index];
                                }
                            });
                            data.push(row);
                        }
                    }
                }
                
                console.log(`Parsed ${data.length} translation items from CSV`);
                return data;
            }

            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result;
            }

            async loadSampleData() {
                return [
                    {
                        item_id: 'general_welcome',
                        labels: 'general',
                        en: 'Welcome to the audio dashboard',
                        es: 'Bienvenido al panel de audio',
                        de: 'Willkommen im Audio-Dashboard',
                        fr: 'Bienvenue dans le tableau de bord audio',
                        nl: 'Welkom bij het audio-dashboard'
                    },
                    {
                        item_id: 'general_instructions',
                        labels: 'general',
                        en: 'Please follow the instructions carefully',
                        es: 'Por favor sigue las instrucciones cuidadosamente',
                        de: 'Bitte befolgen Sie die Anweisungen sorgfältig',
                        fr: 'Veuillez suivre attentivement les instructions',
                        nl: 'Volg de instructies zorgvuldig op'
                    },
                    {
                        item_id: 'math_problem_01',
                        labels: 'math',
                        en: 'Please solve this math problem',
                        es: 'Por favor resuelve este problema de matemáticas',
                        de: 'Bitte lösen Sie dieses Matheproblem',
                        fr: 'Veuillez résoudre ce problème de mathématiques',
                        nl: 'Los dit wiskundeprobleem op'
                    },
                    {
                        item_id: 'math_addition_01',
                        labels: 'math, addition',
                        en: 'What is 5 plus 3?',
                        es: '¿Cuánto es 5 más 3?',
                        de: 'Was ist 5 plus 3?',
                        fr: 'Combien font 5 plus 3?',
                        nl: 'Hoeveel is 5 plus 3?'
                    },
                    {
                        item_id: 'vocab_cat',
                        labels: 'vocab',
                        en: 'The cat sits on the mat',
                        es: 'El gato se sienta en la alfombra',
                        de: 'Die Katze sitzt auf der Matte',
                        fr: 'Le chat est assis sur le tapis',
                        nl: 'De kat zit op de mat'
                    },
                    {
                        item_id: 'vocab_dog',
                        labels: 'vocab',
                        en: 'The dog runs in the park',
                        es: 'El perro corre en el parque',
                        de: 'Der Hund läuft im Park',
                        fr: 'Le chien court dans le parc',
                        nl: 'De hond rent in het park'
                    },
                    {
                        item_id: 'hearts_flowers_01',
                        labels: 'hearts-and-flowers',
                        en: 'Choose the correct pattern',
                        es: 'Elige el patrón correcto',
                        de: 'Wählen Sie das richtige Muster',
                        fr: 'Choisissez le bon motif',
                        nl: 'Kies het juiste patroon'
                    },
                    {
                        item_id: 'hostile_attribution_01',
                        labels: 'hostile-attribution',
                        en: 'What do you think happened?',
                        es: '¿Qué crees que pasó?',
                        de: 'Was denkst du ist passiert?',
                        fr: 'Que pensez-vous qu\'il s\'est passé?',
                        nl: 'Wat denk je dat er is gebeurd?'
                    }
                ];
            }

            setupEventListeners() {
                console.log('Setting up event listeners...');
                
                // Search input
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        console.log('Search input:', e.target.value);
                        this.searchItems(e.target.value);
                    });
                    console.log('✅ Search input listener added');
                } else {
                    console.error('❌ Search input not found');
                }

                // Voice dropdown event listeners
                const playhtVoice = document.getElementById('playhtVoice');
                if (playhtVoice) {
                    playhtVoice.addEventListener('change', (e) => {
                        console.log('PlayHT voice selected:', e.target.value);
                        if (e.target.value) {
                            this.generateAudio('playht', e.target.value);
                        }
                    });
                    console.log('✅ PlayHT voice listener added');
                } else {
                    console.error('❌ PlayHT voice dropdown not found');
                }

                const elevenlabsVoice = document.getElementById('elevenlabsVoice');
                if (elevenlabsVoice) {
                    elevenlabsVoice.addEventListener('change', (e) => {
                        console.log('ElevenLabs voice selected:', e.target.value);
                        if (e.target.value) {
                            this.generateAudio('elevenlabs', e.target.value);
                        }
                    });
                    console.log('✅ ElevenLabs voice listener added');
                } else {
                    console.error('❌ ElevenLabs voice dropdown not found');
                }

                // Refresh voices button
                const refreshVoices = document.getElementById('refreshVoices');
                if (refreshVoices) {
                    refreshVoices.addEventListener('click', async () => {
                        console.log('Refresh voices clicked');
                        this.setStatus('🔄 Refreshing voices...');
                        // Reload comprehensive voices first
                        await this.loadComprehensiveVoices();
                        // Then reload API voices if credentials are available
                        await this.loadVoices();
                    });
                    console.log('✅ Refresh voices listener added');
                } else {
                    console.error('❌ Refresh voices button not found');
                }

                // SSML play button
                const playSSML = document.getElementById('playSSML');
                if (playSSML) {
                    playSSML.addEventListener('click', () => {
                        console.log('Play SSML clicked');
                        this.playSSMLText();
                    });
                    console.log('✅ Play SSML listener added');
                } else {
                    console.error('❌ Play SSML button not found');
                }

                // Debug voices button
                const debugVoices = document.getElementById('debugVoices');
                if (debugVoices) {
                    debugVoices.addEventListener('click', () => {
                        console.log('Debug voices clicked');
                        this.showAvailableVoices();
                    });
                    console.log('✅ Debug voices listener added');
                } else {
                    console.error('❌ Debug voices button not found');
                }
                
                console.log('Event listeners setup complete');
            }

            createTabs() {
                const tabButtons = document.getElementById('tabButtons');
                const tabContent = document.getElementById('tabContent');

                console.log('Creating language tabs...', Object.keys(this.languages));

                Object.keys(this.languages).forEach((language, index) => {
                    const button = document.createElement('button');
                    button.className = `tab-button ${index === 0 ? 'active' : ''}`;
                    button.textContent = language;
                    button.addEventListener('click', () => this.switchTab(language));
                    tabButtons.appendChild(button);

                    const content = document.createElement('div');
                    content.className = `tab-content ${index === 0 ? 'active' : ''}`;
                    content.id = `tab-${language}`;
                    content.innerHTML = this.createTableHTML(language);
                    tabContent.appendChild(content);
                });

                this.currentLanguage = Object.keys(this.languages)[0];
                console.log('Populating initial table for:', this.currentLanguage);
                this.populateTable(this.currentLanguage);
                console.log('Tabs created successfully');
            }

            createTableHTML(language) {
                const langCode = this.languages[language].lang_code;
                return `
                    <table class="data-table" id="table-${language}">
                        <thead>
                            <tr>
                                <th>Item ID</th>
                                <th>Task</th>
                                <th>English</th>
                                <th>Translated (${langCode})</th>
                                <th>Audio File</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                `;
            }

            populateTable(language) {
                const table = document.getElementById(`table-${language}`);
                const tbody = table.querySelector('tbody');
                const langCode = this.languages[language].lang_code;

                tbody.innerHTML = '';

                this.data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    row.addEventListener('click', () => this.selectRow(row, item));

                    const translatedText = item[langCode] || 'No translation available';
                    const englishText = item.en || 'No English text';
                    const audioFilePath = `audio_files/${item.labels}/${langCode}/shared/${item.item_id}.mp3`;
                    
                    row.innerHTML = `
                        <td>${item.item_id}</td>
                        <td>${item.labels}</td>
                        <td class="text-cell">${this.wrapText(englishText, 40)}</td>
                        <td class="text-cell">${this.wrapText(translatedText, 40)}</td>
                        <td class="audio-path">${audioFilePath}</td>
                        <td>
                            <button class="btn btn-primary" onclick="dashboard.playExistingAudio('${item.item_id}', '${langCode}', '${item.labels}')">
                                <i class="fas fa-play"></i> Play
                            </button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            switchTab(language) {
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`tab-${language}`).classList.add('active');

                this.currentLanguage = language;
                this.populateTable(language);
                
                // Refresh voice dropdowns for the new language
                this.populateVoiceDropdowns();
                
                console.log(`Switched to ${language} tab, refreshed voice dropdowns`);
                this.setStatus(`Switched to ${language} language`);
            }

            selectRow(row, item) {
                document.querySelectorAll('.data-table tr').forEach(r => {
                    r.classList.remove('selected');
                });

                row.classList.add('selected');
                this.selectedRow = item;

                const langCode = this.languages[this.currentLanguage].lang_code;
                const text = item[langCode] || item.en || '';
                document.getElementById('ssmlEditor').value = text;

                this.setStatus(`Selected: ${item.item_id}`);
            }

            searchItems(query) {
                const tables = document.querySelectorAll('.data-table tbody');
                
                tables.forEach(tbody => {
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        if (text.includes(query.toLowerCase())) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }

            wrapText(text, width = 40) {
                if (!text) return '';
                
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';
                
                words.forEach(word => {
                    if ((currentLine + word).length <= width) {
                        currentLine += (currentLine ? ' ' : '') + word;
                    } else {
                        if (currentLine) lines.push(currentLine);
                        currentLine = word;
                    }
                });
                
                if (currentLine) lines.push(currentLine);
                return lines.join('<br>');
            }

            async playExistingAudio(itemId, langCode, taskLabel) {
                this.setStatus(`Loading audio for ${itemId} (${langCode})...`);
                
                // Construct the GitHub raw URL for the audio file
                const baseUrl = 'https://raw.githubusercontent.com/levante-framework/levante_translations/main/audio_files';
                const audioUrl = `${baseUrl}/${taskLabel}/${langCode}/shared/${itemId}.mp3`;
                
                console.log(`Attempting to play audio from: ${audioUrl}`);
                
                try {
                    // Check if the audio file exists
                    const response = await fetch(audioUrl, { method: 'HEAD' });
                    
                    if (response.ok) {
                        // File exists, play it
                        const audio = new Audio(audioUrl);
                        
                        audio.addEventListener('loadstart', () => {
                            this.setStatus(`Loading audio: ${itemId}...`);
                        });
                        
                        audio.addEventListener('canplay', () => {
                            this.setStatus(`Playing audio: ${itemId}`);
                        });
                        
                        audio.addEventListener('ended', () => {
                            this.setStatus(`Finished playing: ${itemId}`);
                        });
                        
                        audio.addEventListener('error', (e) => {
                            console.error('Audio playback error:', e);
                            this.setStatus(`❌ Error playing audio: ${itemId}`);
                        });
                        
                        await audio.play();
                    } else {
                        // File doesn't exist, try alternative locations
                        console.log(`Audio file not found at ${audioUrl}, trying alternative locations...`);
                        await this.tryAlternativeAudioLocations(itemId, langCode, taskLabel);
                    }
                } catch (error) {
                    console.error('Error loading audio:', error);
                    this.setStatus(`❌ Could not load audio for ${itemId}`);
                }
            }

            async tryAlternativeAudioLocations(itemId, langCode, taskLabel) {
                // Try different possible locations for the audio file
                const baseUrl = 'https://raw.githubusercontent.com/levante-framework/levante_translations/main/audio_files';
                
                // Map simplified codes to potential full codes
                const langCodeMappings = {
                    'en': ['en', 'en-US'],
                    'es': ['es', 'es-CO'], 
                    'de': ['de', 'de-DE'],
                    'fr': ['fr', 'fr-CA'],
                    'nl': ['nl', 'nl-NL']
                };
                
                const possibleLangCodes = langCodeMappings[langCode] || [langCode];
                
                for (const testLangCode of possibleLangCodes) {
                    const audioUrl = `${baseUrl}/${taskLabel}/${testLangCode}/shared/${itemId}.mp3`;
                    console.log(`Trying alternative location: ${audioUrl}`);
                    
                    try {
                        const response = await fetch(audioUrl, { method: 'HEAD' });
                        if (response.ok) {
                            console.log(`Found audio at: ${audioUrl}`);
                            const audio = new Audio(audioUrl);
                            await audio.play();
                            this.setStatus(`✅ Playing audio: ${itemId} (${testLangCode})`);
                            return;
                        }
                    } catch (error) {
                        console.log(`Failed to load from ${audioUrl}`);
                    }
                }
                
                // If no audio file found anywhere
                this.setStatus(`❌ No audio file found for ${itemId} in any location`);
                console.log(`No audio file found for ${itemId} in language ${langCode}`);
            }

            async generateAudio(service, voiceId) {
                const text = document.getElementById('ssmlEditor').value;
                if (!text.trim()) {
                    this.setStatus('❌ Please enter some text to generate audio');
                    return;
                }

                const credentials = this.loadCredentials();
                
                if (service === 'playht') {
                    if (!credentials.playht.apiKey || !credentials.playht.userId) {
                        this.setStatus('❌ PlayHT credentials not found');
                        this.showCredentialsModal(true, false);
                        return;
                    }
                    await this.generatePlayHTAudio(text, voiceId, credentials.playht);
                } else if (service === 'elevenlabs') {
                    if (!credentials.elevenlabs.apiKey) {
                        this.setStatus('❌ ElevenLabs credentials not found');
                        this.showCredentialsModal(false, true);
                        return;
                    }
                    await this.generateElevenLabsAudio(text, voiceId, credentials.elevenlabs);
                }
            }

            async generatePlayHTAudio(text, voiceId, credentials) {
                this.setStatus('🎵 Generating PlayHT audio...');
                
                if (!credentials.apiKey || !credentials.userId) {
                    throw new Error('PlayHT API credentials not configured');
                }

                // Convert HTML to SSML and remove wrapper tags for PlayHT
                let ssmlText = this.htmlToSSML(text);
                if (ssmlText.startsWith('<speak>') && ssmlText.endsWith('</speak>')) {
                    ssmlText = ssmlText.slice(7, -8);
                }

                const requestData = {
                    text: ssmlText,
                    voice: voiceId,
                    voice_engine: 'PlayDialog',
                    output_format: 'mp3',
                    sample_rate: 24000
                };

                // Add text_type if SSML tags are present
                if (ssmlText.includes('<') && ssmlText.includes('>')) {
                    requestData.text_type = 'ssml';
                }

                try {
                    const response = await fetch('https://api.play.ht/api/v2/tts/stream', {
                        method: 'POST',
                        headers: {
                            'AUTHORIZATION': credentials.apiKey,
                            'X-USER-ID': credentials.userId,
                            'Content-Type': 'application/json',
                            'Accept': 'audio/mpeg'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`PlayHT API error: ${response.status} - ${response.statusText}`);
                    }

                    const audioData = await response.arrayBuffer();
                    await this.playAudioData(audioData);
                    this.setStatus(`🔊 PlayHT audio generated successfully`);
                    
                } catch (error) {
                    console.error('PlayHT API error:', error);
                    this.setStatus(`❌ PlayHT error: ${error.message}`);
                }
            }

            async generateElevenLabsAudio(text, voiceId, credentials) {
                this.setStatus('🎵 Generating ElevenLabs audio...');
                
                if (!credentials.apiKey) {
                    throw new Error('ElevenLabs API key not configured');
                }

                const requestData = {
                    text: text,
                    model_id: 'eleven_multilingual_v2',
                    voice_settings: {
                        stability: 0.65,
                        similarity_boost: 0.5,
                        style: 0.0,
                        use_speaker_boost: true
                    }
                };

                try {
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                        method: 'POST',
                        headers: {
                            'xi-api-key': credentials.apiKey,
                            'Content-Type': 'application/json',
                            'Accept': 'audio/mpeg'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`ElevenLabs API error: ${response.status} - ${response.statusText}`);
                    }

                    const audioData = await response.arrayBuffer();
                    await this.playAudioData(audioData);
                    this.setStatus(`🔊 ElevenLabs audio generated successfully`);
                    
                } catch (error) {
                    console.error('ElevenLabs API error:', error);
                    this.setStatus(`❌ ElevenLabs error: ${error.message}`);
                }
            }

            async playAudioData(audioData) {
                const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                const audio = new Audio(audioUrl);
                
                return new Promise((resolve, reject) => {
                    audio.addEventListener('ended', () => {
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    });
                    
                    audio.addEventListener('error', (e) => {
                        URL.revokeObjectURL(audioUrl);
                        reject(new Error('Audio playback failed'));
                    });
                    
                    audio.play().catch(reject);
                });
            }

            htmlToSSML(html) {
                // Convert HTML tags to SSML tags
                let ssml = html
                    .replace(/<\s*bold\s*>/g, '<emphasis>')
                    .replace(/<\s*\/\s*bold\s*>/g, '</emphasis>')
                    .replace(/<\s*br\s*\/?>/g, '<break time="400ms"/>')
                    .replace(/<\s*p\s*\/?>/g, '<break time="400ms"/>');

                // Wrap in speak tags
                return `<speak>${ssml}</speak>`;
            }

            debugVoices() {
                console.log('=== VOICE DEBUG INFO ===');
                console.log('PlayHT voices loaded:', this.voices.playht.length);
                console.log('ElevenLabs voices loaded:', this.voices.elevenlabs.length);
                
                console.log('PlayHT voices:', this.voices.playht);
                console.log('ElevenLabs voices:', this.voices.elevenlabs);
                
                const credentials = this.loadCredentials();
                console.log('Credentials status:', {
                    playht: {
                        hasApiKey: !!credentials.playht.apiKey,
                        hasUserId: !!credentials.playht.userId
                    },
                    elevenlabs: {
                        hasApiKey: !!credentials.elevenlabs.apiKey
                    }
                });
                
                this.setStatus('🔍 Debug info logged to console. Check browser dev tools.');
            }

            playSSMLText() {
                const text = document.getElementById('ssmlEditor').value;
                if (!text.trim()) {
                    this.setStatus('❌ Please enter some text to play');
                    return;
                }

                // Check which voice is selected
                const playhtVoice = document.getElementById('playhtVoice').value;
                const elevenlabsVoice = document.getElementById('elevenlabsVoice').value;
                
                console.log(`Voice selection debug: PlayHT="${playhtVoice}", ElevenLabs="${elevenlabsVoice}"`);
                
                if (playhtVoice) {
                    // PlayHT voice selected
                    console.log(`Using PlayHT voice: ${playhtVoice}`);
                    this.generateAudio('playht', playhtVoice);
                } else if (elevenlabsVoice) {
                    // ElevenLabs voice selected
                    console.log(`Using ElevenLabs voice: ${elevenlabsVoice}`);
                    this.generateAudio('elevenlabs', elevenlabsVoice);
                } else {
                    // No voice selected, use browser speech synthesis with appropriate language
                    console.log('No voice selected, using browser speech synthesis');
                    this.setStatus('💡 Tip: Select a voice from the dropdowns above for better quality audio');
                    this.playWithBrowserSpeech(text);
                }
            }

            playWithBrowserSpeech(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Set language based on current tab
                    const currentLang = this.getCurrentLanguage();
                    const langCodes = {
                        'English': 'en-US',
                        'Spanish': 'es-ES',
                        'German': 'de-DE',
                        'French': 'fr-FR',
                        'Dutch': 'nl-NL'
                    };
                    
                    const targetLang = langCodes[currentLang] || 'en-US';
                    utterance.lang = targetLang;
                    
                    // Wait for voices to load if they haven't already
                    const selectVoiceAndSpeak = () => {
                        const voices = speechSynthesis.getVoices();
                        console.log(`Available voices: ${voices.length}`);
                        
                        // Try to find the best matching voice for the language
                        let matchingVoice = null;
                        
                        // First try to find exact language match
                        matchingVoice = voices.find(voice => 
                            voice.lang === targetLang
                        );
                        
                        // If no exact match, try language prefix match
                        if (!matchingVoice) {
                            matchingVoice = voices.find(voice => 
                                voice.lang.startsWith(targetLang.split('-')[0])
                            );
                        }
                        
                        // If still no match, try to find a female voice for the language
                        if (!matchingVoice) {
                            matchingVoice = voices.find(voice => 
                                voice.lang.startsWith(targetLang.split('-')[0]) && 
                                (voice.name.toLowerCase().includes('female') || 
                                 voice.name.toLowerCase().includes('woman') ||
                                 voice.name.toLowerCase().includes('zira') ||
                                 voice.name.toLowerCase().includes('sabina') ||
                                 voice.name.toLowerCase().includes('helena'))
                            );
                        }
                        
                        if (matchingVoice) {
                            utterance.voice = matchingVoice;
                            this.setStatus(`🔊 Playing with ${matchingVoice.name} (${matchingVoice.lang})`);
                            console.log(`Selected voice: ${matchingVoice.name} (${matchingVoice.lang})`);
                        } else {
                            this.setStatus(`🔊 Playing with browser default voice (${targetLang})`);
                            console.log(`No matching voice found for ${targetLang}, using default`);
                        }
                        
                        speechSynthesis.speak(utterance);
                    };
                    
                    // Check if voices are already loaded
                    if (speechSynthesis.getVoices().length > 0) {
                        selectVoiceAndSpeak();
                    } else {
                        // Wait for voices to load
                        speechSynthesis.addEventListener('voiceschanged', selectVoiceAndSpeak, { once: true });
                        // Fallback timeout in case voiceschanged doesn't fire
                        setTimeout(selectVoiceAndSpeak, 100);
                    }
                } else {
                    this.setStatus('❌ Speech synthesis not supported in this browser');
                }
            }

            getCurrentLanguage() {
                const activeTab = document.querySelector('.tab-button.active');
                return activeTab ? activeTab.textContent : 'English';
            }

            // Debug function to show available voices
            showAvailableVoices() {
                if ('speechSynthesis' in window) {
                    const voices = speechSynthesis.getVoices();
                    console.log('=== Available Browser Voices ===');
                    voices.forEach((voice, index) => {
                        console.log(`${index + 1}. ${voice.name} (${voice.lang}) - ${voice.gender || 'unknown gender'}`);
                    });
                    console.log(`Total voices: ${voices.length}`);
                    
                    // Show in status bar
                    this.setStatus(`📋 ${voices.length} voices available - check console for details`);
                } else {
                    console.log('Speech synthesis not supported');
                    this.setStatus('❌ Speech synthesis not supported');
                }
            }

            setStatus(message) {
                const statusBar = document.getElementById('statusBar');
                if (statusBar) {
                    statusBar.textContent = message;
                } else {
                    console.log('Status:', message);
                }
            }

            // Test function to verify JavaScript is working
            testFunction() {
                console.log('Test function called - JavaScript is working!');
                this.setStatus('✅ Test function called - JavaScript is working!');
                alert('JavaScript is working! Dashboard should be functional.');
            }
        }

        // Global functions for credential management
        async function saveCredentialsFromModal() {
            const credentials = {
                playht: {
                    apiKey: document.getElementById('playhtApiKey')?.value || '',
                    userId: document.getElementById('playhtUserId')?.value || ''
                },
                elevenlabs: {
                    apiKey: document.getElementById('elevenlabsApiKey')?.value || ''
                }
            };

            dashboard.saveCredentials(credentials);
            closeCredentialsModal();
            dashboard.setStatus('✅ Credentials saved successfully');
            
            // Load voices after saving credentials
            await dashboard.loadVoices();
        }

        function clearAllCredentials() {
            if (confirm('Are you sure you want to clear all stored credentials?')) {
                dashboard.clearCredentials();
                closeCredentialsModal();
                dashboard.setStatus('🗑️ All credentials cleared');
            }
        }

        function closeCredentialsModal() {
            const modal = document.getElementById('credentialsModal');
            if (modal) {
                modal.remove();
            }
        }

        function showCredentialsSetup() {
            console.log('showCredentialsSetup called');
            if (window.dashboard) {
                console.log('Dashboard found, showing modal');
                window.dashboard.showCredentialsModal(true, true);
            } else {
                console.error('Dashboard not initialized yet');
                alert('Dashboard is still loading. Please wait a moment and try again.');
            }
        }

        // Initialize the dashboard when the page loads
        let dashboard;
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing dashboard');
            try {
                dashboard = new AudioDashboard();
                window.dashboard = dashboard;
                console.log('Dashboard assigned to window.dashboard');
                
                // Add a loading indicator
                const statusBar = document.getElementById('statusBar');
                if (statusBar) {
                    statusBar.textContent = 'Initializing dashboard...';
                }
                
                // Wait a bit for the dashboard to initialize
                setTimeout(() => {
                    if (statusBar) {
                        statusBar.textContent = 'Dashboard loaded! Select a language tab to begin.';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                const statusBar = document.getElementById('statusBar');
                if (statusBar) {
                    statusBar.textContent = `Error: ${error.message}`;
                    statusBar.style.color = 'red';
                }
            }
        });
    </script>
</body>
</html> 