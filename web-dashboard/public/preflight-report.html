<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Assets Preflight Readiness Report</title>
	<link rel="icon" type="image/svg+xml" href="./favicon.svg">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<link rel="stylesheet" href="./styles.css">
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; color: #222; }
		h1 { font-size: 20px; margin-bottom: 16px; }
		.table { width: 100%; border-collapse: collapse; }
		.table th, .table td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 13px; text-align: left; }
		.table thead th { background: #f8fafc; position: sticky; top: 0; }
		.badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 12px; font-weight: 600; }
		.ok { background: #e7f7ec; color: #1f7a37; }
		.warn { background: #fff7e6; color: #8a6d1f; }
		.err { background: #fde7ea; color: #842029; }
		
		/* Stoplight button styles */
		.stoplight.go { background: #059669; color: white; border-color: #059669; }
		.stoplight.diff { background: #f59e0b; color: white; border-color: #f59e0b; cursor: pointer; }
		.stoplight.diff:hover { background: #d97706; }
		.stoplight.fail { background: #dc2626; color: white; border-color: #dc2626; }
		.stoplight.loading { background: #6b7280; color: white; border-color: #6b7280; }
		
		/* Modal styles */
		.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
		.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
		.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb; }
		.modal-title { font-size: 18px; font-weight: 600; color: #111827; }
		.close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
		.close:hover { color: #000; }
		.modal-body { font-size: 14px; line-height: 1.5; }
		.diff-section { margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 6px; }
		.diff-section h4 { margin: 0 0 8px 0; font-size: 14px; font-weight: 600; color: #374151; }
		.diff-value { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
		.diff-comparison { display: flex; gap: 16px; align-items: center; }
		.diff-item { flex: 1; text-align: center; }
		.diff-arrow { font-size: 18px; color: #6b7280; }
		.small { color: #374151; font-size: 12px; font-weight: 500; }
		.code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; background: #f3f4f6; padding: 1px 4px; border-radius: 4px; }
		.footer { margin-top: 16px; font-size: 12px; color: #6b7280; }
		.section { margin-top: 20px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
		.link { color: #0d6efd; cursor: pointer; text-decoration: underline; }
	</style>
</head>
<body>
	<h1><i class="fas fa-clipboard-list"></i> Assets Preflight Readiness Report</h1>
	<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
		<button id="refreshBtn" style="padding: 4px 12px; border: 1px solid #d1d5db; border-radius: 4px; background: #0d6efd; color: white; cursor: pointer; font-size: 13px;">🔄 Refresh</button>
	</div>
	
	<div class="section" id="translationsAuditSection">
		<h2 style="font-size:16px; margin:0 0 8px 0;">Translations Audit</h2>
	</div>
	
	<table class="table" id="reportTable" aria-label="Languages Preflight Readiness table">
		<thead>
			<tr>
				<th rowspan="2">Language</th>
				<th rowspan="2">Code</th>
				<th colspan="4" style="text-align: center; background: #f8f9fa;">Dev Environment</th>
				<th colspan="4" style="text-align: center; background: #f8f9fa;">Prod Environment</th>
			</tr>
			<tr>
				<th>From Crowdin</th>
				<th>Surveys</th>
				<th>Dashboard</th>
				<th>Audio</th>
				<th>From Crowdin</th>
				<th>Surveys</th>
				<th>Dashboard</th>
				<th>Audio</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<div class="footer" style="margin: 16px 0;">
		Color legend: <span class="badge ok">100%</span> <span class="badge warn">&gt; 0%</span> <span class="badge err">0%</span>
		<div class="small" style="margin-top:6px;">
			- <span class="badge ok">yes</span>: exact locale file exists in levante-dashboard (e.g., de-CH)
			- <span class="badge warn">base</span>: only base language file exists (e.g., de)
			- <span class="badge err">missing</span>: neither exact nor base locale file exists
			- Surveys %: percentage of survey JSONs that include the locale (or base for fallback; English counts implicit defaults)
			- From Crowdin: coverage of Item Bank CSV translations
		</div>
	</div>

	<div class="section" id="visualAuditsSection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Visual Assets Audit</h2>
			<button id="visualStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="visualPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="visualAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="visualBucket" class="code"></span> · Prefix: <span id="visualPrefix" class="code">visual/</span></p>
				<p id="visualSummary" class="small">Loading…</p>
				<p class="small"><span id="visualDetails" class="link" style="display:none; margin-right:12px;">Show missing PNG → WEBP list</span><button id="visualFixBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Fix It</button></p>
			</div>
			<div id="visualAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="visualBucketProd" class="code"></span> · Prefix: <span id="visualPrefixProd" class="code">visual/</span></p>
				<p id="visualSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="visualDetailsProd" class="link" style="display:none; margin-right:12px;">Show missing PNG → WEBP list</span><button id="visualFixBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Fix It</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="audioAuditsSection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Audio Assets Audit</h2>
			<button id="audioStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="audioPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="audioAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="audioBucket" class="code"></span> · Prefix: <span id="audioPrefix" class="code">audio/</span></p>
				<p id="audioSummary" class="small">Loading…</p>
				<p class="small"><span id="audioDetails" class="link" style="display:none; margin-right:12px;">Show audio coverage details</span><button id="audioCoverageBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">View Coverage</button></p>
			</div>
			<div id="audioAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="audioBucketProd" class="code"></span> · Prefix: <span id="audioPrefixProd" class="code">audio/</span></p>
				<p id="audioSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="audioDetailsProd" class="link" style="display:none; margin-right:12px;">Show audio coverage details</span><button id="audioCoverageBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">View Coverage</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="coreTasksAuditsSection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Core Tasks Audit</h2>
			<button id="coreTasksStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="coreTasksPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="coreTasksAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="coreTasksBucket" class="code"></span> · Prefix: <span id="coreTasksPrefix" class="code">corpus/</span></p>
				<p id="coreTasksSummary" class="small">Loading…</p>
				<p class="small"><span id="coreTasksDetails" class="link" style="display:none; margin-right:12px;">Show corpus details</span><button id="coreTasksValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="coreTasksAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="coreTasksBucketProd" class="code"></span> · Prefix: <span id="coreTasksPrefixProd" class="code">corpus/</span></p>
				<p id="coreTasksSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="coreTasksDetailsProd" class="link" style="display:none; margin-right:12px;">Show corpus details</span><button id="coreTasksValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="corpusAuditsSection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Corpus Audit</h2>
			<button id="corpusStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="corpusPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="corpusAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="corpusBucket" class="code"></span> · Prefix: <span id="corpusPrefix" class="code">corpus/</span></p>
				<p id="corpusSummary" class="small">Loading…</p>
				<p class="small"><span id="corpusDetails" class="link" style="display:none; margin-right:12px;">Show corpus details</span><button id="corpusValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="corpusAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="corpusBucketProd" class="code"></span> · Prefix: <span id="corpusPrefixProd" class="code">corpus/</span></p>
				<p id="corpusSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="corpusDetailsProd" class="link" style="display:none; margin-right:12px;">Show corpus details</span><button id="corpusValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="translationCompletenessSection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Translation Completeness Audit</h2>
			<button id="translationCompletenessStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="translationCompletenessPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="translationCompletenessAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Source: <span id="translationCompletenessSource" class="code">item_bank_translations.csv</span></p>
				<p id="translationCompletenessSummary" class="small">Loading…</p>
				<p class="small"><span id="translationCompletenessDetails" class="link" style="display:none; margin-right:12px;">Show missing translations</span><button id="translationCompletenessValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="translationCompletenessAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Source: <span id="translationCompletenessSourceProd" class="code">item_bank_translations.csv</span></p>
				<p id="translationCompletenessSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="translationCompletenessDetailsProd" class="link" style="display:none; margin-right:12px;">Show missing translations</span><button id="translationCompletenessValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="assetIntegritySection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Asset Integrity Audit</h2>
			<button id="assetIntegrityStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="assetIntegrityPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="assetIntegrityAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Scope: <span id="assetIntegrityScope" class="code">All assets</span></p>
				<p id="assetIntegritySummary" class="small">Loading…</p>
				<p class="small"><span id="assetIntegrityDetails" class="link" style="display:none; margin-right:12px;">Show integrity issues</span><button id="assetIntegrityValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="assetIntegrityAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Scope: <span id="assetIntegrityScopeProd" class="code">All assets</span></p>
				<p id="assetIntegritySummaryProd" class="small">Loading…</p>
				<p class="small"><span id="assetIntegrityDetailsProd" class="link" style="display:none; margin-right:12px;">Show integrity issues</span><button id="assetIntegrityValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="configValidationSection">
		<div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
			<h2 style="font-size:16px; margin:0;">Configuration Validation</h2>
			<button id="configValidationStoplight" class="stoplight" style="display:none; padding:4px 8px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; font-weight:600; cursor:default;">Loading...</button>
		</div>
		<div id="configValidationPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="configValidationAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Scope: <span id="configValidationScope" class="code">Environment & API configs</span></p>
				<p id="configValidationSummary" class="small">Loading…</p>
				<p class="small"><span id="configValidationDetails" class="link" style="display:none; margin-right:12px;">Show config issues</span><button id="configValidationValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="configValidationAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Scope: <span id="configValidationScopeProd" class="code">Environment & API configs</span></p>
				<p id="configValidationSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="configValidationDetailsProd" class="link" style="display:none; margin-right:12px;">Show config issues</span><button id="configValidationValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<!-- Diff Modal -->
	<div id="diffModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title" id="diffModalTitle">Environment Differences</h2>
				<span class="close" id="diffModalClose">&times;</span>
			</div>
			<div class="modal-body" id="diffModalBody">
				<!-- Content will be populated by JavaScript -->
			</div>
		</div>
	</div>

	<script>
	(async function() {
		// Refresh button handler
		const refreshBtn = document.getElementById('refreshBtn');
		refreshBtn.addEventListener('click', () => {
			refreshReport();
		});
		
		// Function to refresh the entire report
		async function refreshReport() {
			// Clear existing content
			document.querySelector('#reportTable tbody').innerHTML = '';
			document.getElementById('visualSummary').textContent = 'Loading…';
			document.getElementById('visualSummaryProd').textContent = 'Loading…';
			document.getElementById('audioSummary').textContent = 'Loading…';
			document.getElementById('audioSummaryProd').textContent = 'Loading…';
			document.getElementById('coreTasksSummary').textContent = 'Loading…';
			document.getElementById('coreTasksSummaryProd').textContent = 'Loading…';
			document.getElementById('corpusSummary').textContent = 'Loading…';
			document.getElementById('corpusSummaryProd').textContent = 'Loading…';
			
			// Reset stoplight buttons
			resetStoplights();
			
			// Reload all data
			await loadReportData();
		}
		
		// Reset all stoplight buttons to loading state
		function resetStoplights() {
			const stoplights = ['visualStoplight', 'audioStoplight', 'coreTasksStoplight', 'corpusStoplight'];
			stoplights.forEach(id => {
				const btn = document.getElementById(id);
				if (btn) {
					btn.style.display = 'inline-block';
					btn.textContent = 'Loading...';
					btn.className = 'stoplight loading';
				}
			});
		}
		
		// Update stoplight button based on comparison
		function updateStoplight(buttonId, devValue, prodValue) {
			const btn = document.getElementById(buttonId);
			if (!btn) return;
			
			btn.style.display = 'inline-block';
			
			// Check if either value is empty/null/undefined
			if (devValue === null || devValue === undefined || devValue === '' || 
				prodValue === null || prodValue === undefined || prodValue === '') {
				btn.textContent = 'Fail';
				btn.className = 'stoplight fail';
				return;
			}
			
			// Check if values match
			if (devValue === prodValue) {
				btn.textContent = 'Go';
				btn.className = 'stoplight go';
			} else {
				btn.textContent = 'Diff';
				btn.className = 'stoplight diff';
				// Add click handler for diff buttons
				btn.onclick = () => showDiffModal(buttonId, devValue, prodValue);
			}
		}
		
		// Show diff modal with detailed comparison
		async function showDiffModal(buttonId, devValue, prodValue) {
			const modal = document.getElementById('diffModal');
			const title = document.getElementById('diffModalTitle');
			const body = document.getElementById('diffModalBody');
			
			// Show loading state
			title.textContent = 'Loading detailed differences...';
			body.innerHTML = '<div style="text-align: center; padding: 20px;"><div>Loading detailed information...</div></div>';
			modal.style.display = 'block';
			
			// Determine section type and set title
			let sectionName = '';
			let parameterName = '';
			
			if (buttonId === 'visualStoplight') {
				sectionName = 'Visual Assets Audit';
				parameterName = 'PNGs needing WEBP conversion';
			} else if (buttonId === 'audioStoplight') {
				sectionName = 'Audio Assets Audit';
				parameterName = 'Available languages';
			} else if (buttonId === 'coreTasksStoplight') {
				sectionName = 'Core Tasks Audit';
				parameterName = 'CSV files in corpus';
			} else if (buttonId === 'corpusStoplight') {
				sectionName = 'Corpus Audit';
				parameterName = 'Unique item_ids in corpus';
			} else if (buttonId === 'translationCompletenessStoplight') {
				sectionName = 'Translation Completeness Audit';
				parameterName = 'Missing translations';
			} else if (buttonId === 'assetIntegrityStoplight') {
				sectionName = 'Asset Integrity Audit';
				parameterName = 'Integrity issues';
			} else if (buttonId === 'configValidationStoplight') {
				sectionName = 'Configuration Validation';
				parameterName = 'Configuration issues';
			}
			
			title.textContent = `${sectionName} - Environment Differences`;
			
			// Fetch detailed information based on section
			let detailedContent = '';
			try {
				if (buttonId === 'visualStoplight') {
					detailedContent = await getVisualDifferences();
				} else if (buttonId === 'audioStoplight') {
					detailedContent = await getAudioDifferences();
				} else if (buttonId === 'coreTasksStoplight') {
					detailedContent = await getCoreTasksDifferences();
				} else if (buttonId === 'corpusStoplight') {
					detailedContent = await getCorpusDifferences();
				} else if (buttonId === 'translationCompletenessStoplight') {
					detailedContent = await getTranslationCompletenessDifferences();
				} else if (buttonId === 'assetIntegrityStoplight') {
					detailedContent = await getAssetIntegrityDifferences();
				} else if (buttonId === 'configValidationStoplight') {
					detailedContent = await getConfigValidationDifferences();
				}
			} catch (error) {
				detailedContent = `<div style="color: #dc2626; padding: 12px; background: #fef2f2; border-radius: 4px; border-left: 4px solid #dc2626;">
					<strong>Error loading detailed information:</strong> ${error.message}
				</div>`;
			}
			
			// Create comprehensive diff content
			body.innerHTML = `
				<div class="diff-section">
					<h4>Summary</h4>
					<div class="diff-comparison">
						<div class="diff-item">
							<strong>Dev Environment</strong><br>
							<span class="diff-value">${devValue}</span>
						</div>
						<div class="diff-arrow">→</div>
						<div class="diff-item">
							<strong>Prod Environment</strong><br>
							<span class="diff-value">${prodValue}</span>
						</div>
					</div>
					<div style="margin-top: 12px; padding: 8px; background: #fef3c7; border-radius: 4px; border-left: 4px solid #f59e0b;">
						<strong>Difference:</strong> ${Math.abs(devValue - prodValue)} ${devValue > prodValue ? '(Dev has more)' : '(Prod has more)'}
					</div>
				</div>
				${detailedContent}
				<div class="diff-section">
					<h4>Recommendation</h4>
					<p>${getRecommendation(buttonId, devValue, prodValue)}</p>
				</div>
			`;
		}
		
		// Get detailed visual differences
		async function getVisualDifferences() {
			try {
				const [devRes, prodRes] = await Promise.all([
					fetch('/api/visual-audit?env=dev&prefix=visual/', { cache: 'no-cache' }),
					fetch('/api/visual-audit?env=prod&prefix=visual/', { cache: 'no-cache' })
				]);
				
				const devData = await devRes.json();
				const prodData = await prodRes.json();
				
				const devMissing = devData.missing || [];
				const prodMissing = prodData.missing || [];
				
				const devOnly = devMissing.filter(f => !prodMissing.includes(f));
				const prodOnly = prodMissing.filter(f => !devMissing.includes(f));
				const common = devMissing.filter(f => prodMissing.includes(f));
				
				return `
					<div class="diff-section">
						<h4>Detailed Analysis</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
							<div style="padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9;">
								<strong>Dev Only</strong><br>
								<span class="diff-value">${devOnly.length}</span> files<br>
								<small>PNGs in dev that don't need conversion in prod</small>
							</div>
							<div style="padding: 12px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e;">
								<strong>Prod Only</strong><br>
								<span class="diff-value">${prodOnly.length}</span> files<br>
								<small>PNGs in prod that don't need conversion in dev</small>
							</div>
						</div>
						<div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
							<strong>Common Issues</strong><br>
							<span class="diff-value">${common.length}</span> files need conversion in both environments
						</div>
						${devOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>Files only needing conversion in Dev (first 10):</strong><br>
								<div style="max-height: 150px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${devOnly.slice(0, 10).map(f => `• ${f}`).join('<br>')}
									${devOnly.length > 10 ? `<br>... and ${devOnly.length - 10} more files` : ''}
								</div>
							</div>
						` : ''}
						${prodOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>Files only needing conversion in Prod (first 10):</strong><br>
								<div style="max-height: 150px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${prodOnly.slice(0, 10).map(f => `• ${f}`).join('<br>')}
									${prodOnly.length > 10 ? `<br>... and ${prodOnly.length - 10} more files` : ''}
								</div>
							</div>
						` : ''}
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626;">Error loading visual differences: ${error.message}</div>`;
			}
		}
		
		// Get detailed audio differences
		async function getAudioDifferences() {
			try {
				const [devRes, prodRes] = await Promise.all([
					fetch('/api/read-tags?list=1&bucket=levante-assets-dev', { cache: 'no-cache' }),
					fetch('/api/read-tags?list=1&bucket=levante-assets-prod', { cache: 'no-cache' })
				]);
				
				const devData = await devRes.json();
				const prodData = await prodRes.json();
				
				const devLangs = devData.languages || [];
				const prodLangs = prodData.languages || [];
				
				const devOnly = devLangs.filter(l => !prodLangs.includes(l));
				const prodOnly = prodLangs.filter(l => !devLangs.includes(l));
				const common = devLangs.filter(l => prodLangs.includes(l));
				
				return `
					<div class="diff-section">
						<h4>Language Analysis</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
							<div style="padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9;">
								<strong>Dev Only</strong><br>
								<span class="diff-value">${devOnly.length}</span> languages<br>
								<small>Available in dev but not in prod</small>
							</div>
							<div style="padding: 12px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e;">
								<strong>Prod Only</strong><br>
								<span class="diff-value">${prodOnly.length}</span> languages<br>
								<small>Available in prod but not in dev</small>
							</div>
						</div>
						<div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
							<strong>Common Languages</strong><br>
							<span class="diff-value">${common.length}</span> languages available in both environments
						</div>
						${devOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>Languages only in Dev:</strong><br>
								<div style="background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${devOnly.map(l => `• ${l}`).join('<br>')}
								</div>
							</div>
						` : ''}
						${prodOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>Languages only in Prod:</strong><br>
								<div style="background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${prodOnly.map(l => `• ${l}`).join('<br>')}
								</div>
							</div>
						` : ''}
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626;">Error loading audio differences: ${error.message}</div>`;
			}
		}
		
		// Get detailed core tasks differences
		async function getCoreTasksDifferences() {
			try {
				const [devRes, prodRes] = await Promise.all([
					fetch('/api/read-tags?list=1&bucket=levante-assets-dev&prefix=corpus/', { cache: 'no-cache' }),
					fetch('/api/read-tags?list=1&bucket=levante-assets-prod&prefix=corpus/', { cache: 'no-cache' })
				]);
				
				const devData = await devRes.json();
				const prodData = await prodRes.json();
				
				const devFiles = (devData.files || []).filter(f => f.toLowerCase().endsWith('.csv'));
				const prodFiles = (prodData.files || []).filter(f => f.toLowerCase().endsWith('.csv'));
				
				const devOnly = devFiles.filter(f => !prodFiles.includes(f));
				const prodOnly = prodFiles.filter(f => !devFiles.includes(f));
				const common = devFiles.filter(f => prodFiles.includes(f));
				
				return `
					<div class="diff-section">
						<h4>CSV File Analysis</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
							<div style="padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9;">
								<strong>Dev Only</strong><br>
								<span class="diff-value">${devOnly.length}</span> CSV files<br>
								<small>Present in dev but not in prod</small>
							</div>
							<div style="padding: 12px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e;">
								<strong>Prod Only</strong><br>
								<span class="diff-value">${prodOnly.length}</span> CSV files<br>
								<small>Present in prod but not in dev</small>
							</div>
						</div>
						<div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
							<strong>Common Files</strong><br>
							<span class="diff-value">${common.length}</span> CSV files present in both environments
						</div>
						${devOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>CSV files only in Dev:</strong><br>
								<div style="max-height: 150px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${devOnly.map(f => `• ${f}`).join('<br>')}
								</div>
							</div>
						` : ''}
						${prodOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>CSV files only in Prod:</strong><br>
								<div style="max-height: 150px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${prodOnly.map(f => `• ${f}`).join('<br>')}
								</div>
							</div>
						` : ''}
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626;">Error loading core tasks differences: ${error.message}</div>`;
			}
		}
		
		// Get detailed corpus differences
		async function getCorpusDifferences() {
			try {
				const [devRes, prodRes] = await Promise.all([
					fetch('/api/read-tags?list=1&bucket=levante-assets-dev&prefix=corpus/', { cache: 'no-cache' }),
					fetch('/api/read-tags?list=1&bucket=levante-assets-prod&prefix=corpus/', { cache: 'no-cache' })
				]);
				
				const devData = await devRes.json();
				const prodData = await prodRes.json();
				
				// Get unique item_ids from both environments
				const devItemIds = await getUniqueItemIds('levante-assets-dev', devData.files || []);
				const prodItemIds = await getUniqueItemIds('levante-assets-prod', prodData.files || []);
				
				const devOnly = devItemIds.filter(id => !prodItemIds.includes(id));
				const prodOnly = prodItemIds.filter(id => !devItemIds.includes(id));
				const common = devItemIds.filter(id => prodItemIds.includes(id));
				
				return `
					<div class="diff-section">
						<h4>Item ID Analysis</h4>
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
							<div style="padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9;">
								<strong>Dev Only</strong><br>
								<span class="diff-value">${devOnly.length}</span> item_ids<br>
								<small>Present in dev but not in prod</small>
							</div>
							<div style="padding: 12px; background: #f0fdf4; border-radius: 6px; border-left: 4px solid #22c55e;">
								<strong>Prod Only</strong><br>
								<span class="diff-value">${prodOnly.length}</span> item_ids<br>
								<small>Present in prod but not in dev</small>
							</div>
						</div>
						<div style="padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
							<strong>Common Item IDs</strong><br>
							<span class="diff-value">${common.length}</span> item_ids present in both environments
						</div>
						${devOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>Item IDs only in Dev (first 20):</strong><br>
								<div style="max-height: 150px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${devOnly.slice(0, 20).map(id => `• ${id}`).join('<br>')}
									${devOnly.length > 20 ? `<br>... and ${devOnly.length - 20} more item_ids` : ''}
								</div>
							</div>
						` : ''}
						${prodOnly.length > 0 ? `
							<div style="margin-top: 12px;">
								<strong>Item IDs only in Prod (first 20):</strong><br>
								<div style="max-height: 150px; overflow-y: auto; background: #f9fafb; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
									${prodOnly.slice(0, 20).map(id => `• ${id}`).join('<br>')}
									${prodOnly.length > 20 ? `<br>... and ${prodOnly.length - 20} more item_ids` : ''}
								</div>
							</div>
						` : ''}
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626;">Error loading corpus differences: ${error.message}</div>`;
			}
		}
		
		// Translation Completeness Differences
		async function getTranslationCompletenessDifferences() {
			try {
				// Get translation completeness data for both environments
				const devMissing = window.translationCompletenessDevMissing || 0;
				const prodMissing = window.translationCompletenessProdMissing || 0;
				
				const difference = Math.abs(devMissing - prodMissing);
				const devHasMore = devMissing > prodMissing;
				
				return `
					<div class="diff-section">
						<h4>Translation Completeness Analysis</h4>
						<div class="diff-comparison">
							<div class="diff-item">
								<strong>Dev Environment</strong><br>
								<span class="diff-value">${devMissing} missing translations</span>
							</div>
							<div class="diff-arrow">→</div>
							<div class="diff-item">
								<strong>Prod Environment</strong><br>
								<span class="diff-value">${prodMissing} missing translations</span>
							</div>
						</div>
						<div style="margin-top: 12px; padding: 8px; background: ${difference === 0 ? '#f0f9ff' : '#fef3c7'}; border-radius: 4px; border-left: 4px solid ${difference === 0 ? '#0ea5e9' : '#f59e0b'};">
							<strong>Difference:</strong> ${difference} missing translations ${devHasMore ? '(Dev has more missing)' : '(Prod has more missing)'}
						</div>
					</div>
					<div class="diff-section">
						<h4>Recommendation</h4>
						<p>${difference === 0 ? 'Both environments have the same translation completeness. This is ideal for consistency.' : 'Consider synchronizing translation completeness between environments. Focus on completing missing translations in the environment with more gaps.'}</p>
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626; padding: 12px; background: #fef2f2; border-radius: 4px; border-left: 4px solid #dc2626;">
					<strong>Error:</strong> ${error.message}
				</div>`;
			}
		}

		// Asset Integrity Differences
		async function getAssetIntegrityDifferences() {
			try {
				// Get asset integrity data for both environments
				const devIssues = window.assetIntegrityDevIssues || 0;
				const prodIssues = window.assetIntegrityProdIssues || 0;
				
				const difference = Math.abs(devIssues - prodIssues);
				const devHasMore = devIssues > prodIssues;
				
				return `
					<div class="diff-section">
						<h4>Asset Integrity Analysis</h4>
						<div class="diff-comparison">
							<div class="diff-item">
								<strong>Dev Environment</strong><br>
								<span class="diff-value">${devIssues} integrity issues</span>
							</div>
							<div class="diff-arrow">→</div>
							<div class="diff-item">
								<strong>Prod Environment</strong><br>
								<span class="diff-value">${prodIssues} integrity issues</span>
							</div>
						</div>
						<div style="margin-top: 12px; padding: 8px; background: ${difference === 0 ? '#f0f9ff' : '#fef3c7'}; border-radius: 4px; border-left: 4px solid ${difference === 0 ? '#0ea5e9' : '#f59e0b'};">
							<strong>Difference:</strong> ${difference} integrity issues ${devHasMore ? '(Dev has more issues)' : '(Prod has more issues)'}
						</div>
					</div>
					<div class="diff-section">
						<h4>Recommendation</h4>
						<p>${difference === 0 ? 'Both environments have the same asset integrity status. This is ideal for consistency.' : 'Address asset integrity issues in the environment with more problems. Consider implementing automated asset validation in your deployment pipeline.'}</p>
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626; padding: 12px; background: #fef2f2; border-radius: 4px; border-left: 4px solid #dc2626;">
					<strong>Error:</strong> ${error.message}
				</div>`;
			}
		}

		// Configuration Validation Differences
		async function getConfigValidationDifferences() {
			try {
				// Get configuration validation data for both environments
				const devIssues = window.configValidationDevIssues || 0;
				const prodIssues = window.configValidationProdIssues || 0;
				const devDetails = window.configValidationDevDetails || [];
				const prodDetails = window.configValidationProdDetails || [];
				
				const difference = Math.abs(devIssues - prodIssues);
				const devHasMore = devIssues > prodIssues;
				
				// Find specific differences between environments
				const devStatuses = {};
				const prodStatuses = {};
				
				devDetails.forEach(check => {
					devStatuses[check.name] = check.status;
				});
				
				prodDetails.forEach(check => {
					prodStatuses[check.name] = check.status;
				});
				
				// Find checks that differ between environments
				const allCheckNames = [...new Set([...Object.keys(devStatuses), ...Object.keys(prodStatuses)])];
				const differingChecks = allCheckNames.filter(name => devStatuses[name] !== prodStatuses[name]);
				
				return `
					<div class="diff-section">
						<h4>Configuration Validation Analysis</h4>
						<div class="diff-comparison">
							<div class="diff-item">
								<strong>Dev Environment</strong><br>
								<span class="diff-value">${devIssues} configuration issues</span>
							</div>
							<div class="diff-arrow">→</div>
							<div class="diff-item">
								<strong>Prod Environment</strong><br>
								<span class="diff-value">${prodIssues} configuration issues</span>
							</div>
						</div>
						<div style="margin-top: 12px; padding: 8px; background: ${difference === 0 ? '#f0f9ff' : '#fef3c7'}; border-radius: 4px; border-left: 4px solid ${difference === 0 ? '#0ea5e9' : '#f59e0b'};">
							<strong>Difference:</strong> ${difference} configuration issues ${devHasMore ? '(Dev has more issues)' : '(Prod has more issues)'}
						</div>
					</div>
					${differingChecks.length > 0 ? `
						<div class="diff-section">
							<h4>Specific Differences</h4>
							${differingChecks.map(checkName => {
								const devStatus = devStatuses[checkName] || 'unknown';
								const prodStatus = prodStatuses[checkName] || 'unknown';
								const devCheck = devDetails.find(c => c.name === checkName);
								const prodCheck = prodDetails.find(c => c.name === checkName);
								
								return `
									<div style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 8px;">
										<strong>${checkName}</strong>
										<div style="display: flex; gap: 16px; margin-top: 4px;">
											<div style="flex: 1;">
												<span style="font-size: 12px; color: #6b7280;">Dev:</span>
												<span style="font-size: 11px; padding: 2px 6px; border-radius: 2px; background: ${devStatus === 'valid' ? '#dcfce7' : devStatus === 'warning' ? '#fef3c7' : '#fef2f2'}; color: ${devStatus === 'valid' ? '#166534' : devStatus === 'warning' ? '#92400e' : '#991b1b'};">
													${devStatus}
												</span>
												${devCheck && devCheck.details ? `<div style="font-size: 10px; color: #6b7280; margin-top: 2px;">${devCheck.details}</div>` : ''}
											</div>
											<div style="flex: 1;">
												<span style="font-size: 12px; color: #6b7280;">Prod:</span>
												<span style="font-size: 11px; padding: 2px 6px; border-radius: 2px; background: ${prodStatus === 'valid' ? '#dcfce7' : prodStatus === 'warning' ? '#fef3c7' : '#fef2f2'}; color: ${prodStatus === 'valid' ? '#166534' : prodStatus === 'warning' ? '#92400e' : '#991b1b'};">
													${prodStatus}
												</span>
												${prodCheck && prodCheck.details ? `<div style="font-size: 10px; color: #6b7280; margin-top: 2px;">${prodCheck.details}</div>` : ''}
											</div>
										</div>
									</div>
								`;
							}).join('')}
						</div>
					` : ''}
					<div class="diff-section">
						<h4>Recommendation</h4>
						<p>${difference === 0 ? 'Both environments have the same configuration validation status. This is ideal for consistency.' : 'Resolve configuration issues in the environment with more problems. Ensure all required environment variables, API keys, and permissions are properly configured.'}</p>
						${differingChecks.length > 0 ? `
							<ul style="margin-top: 8px; font-size: 12px; color: #6b7280;">
								<li>Review and align configuration settings between dev and prod</li>
								<li>Ensure consistent API endpoint configurations</li>
								<li>Verify GCS bucket access permissions are identical</li>
								<li>Check that file type availability matches between environments</li>
							</ul>
						` : ''}
					</div>
				`;
			} catch (error) {
				return `<div style="color: #dc2626; padding: 12px; background: #fef2f2; border-radius: 4px; border-left: 4px solid #dc2626;">
					<strong>Error:</strong> ${error.message}
				</div>`;
			}
		}

		// Helper function to get unique item_ids from CSV files
		async function getUniqueItemIds(bucket, files) {
			const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
			const uniqueItemIds = new Set();
			
			for (const csvFile of csvFiles) {
				try {
					const csvUrl = `https://storage.googleapis.com/${bucket}/${csvFile}`;
					const csvRes = await fetch(csvUrl, { cache: 'no-cache' });
					if (csvRes.ok) {
						const csvText = await csvRes.text();
						const lines = csvText.split('\n');
						const header = lines[0].split(',').map(h => h.trim().toLowerCase());
						const itemIdIndex = header.findIndex(h => h.includes('item_id') || h.includes('identifier'));
						
						if (itemIdIndex !== -1) {
							for (let i = 1; i < lines.length; i++) {
								const row = lines[i].split(',');
								const itemId = row[itemIdIndex]?.trim();
								if (itemId && itemId !== '') {
									uniqueItemIds.add(itemId);
								}
							}
						}
					}
				} catch (e) {
					console.warn(`Failed to process CSV file ${csvFile}:`, e);
				}
			}
			
			return Array.from(uniqueItemIds);
		}
		
		// Get recommendation based on section and values
		function getRecommendation(buttonId, devValue, prodValue) {
			if (buttonId === 'visualStoplight') {
				if (devValue > prodValue) {
					return 'Dev has more PNGs needing conversion. Consider running the visual fix process on dev to convert more PNGs to WEBP format.';
				} else {
					return 'Prod has more PNGs needing conversion. Consider running the visual fix process on prod to convert more PNGs to WEBP format.';
				}
			} else if (buttonId === 'audioStoplight') {
				if (devValue > prodValue) {
					return 'Dev has more languages available. Consider deploying audio files from dev to prod to sync the environments.';
				} else {
					return 'Prod has more languages available. This may indicate that prod has additional language support that dev lacks.';
				}
			} else if (buttonId === 'coreTasksStoplight') {
				if (devValue > prodValue) {
					return 'Dev has more CSV files in corpus. Consider deploying corpus files from dev to prod to sync the environments.';
				} else {
					return 'Prod has more CSV files in corpus. This may indicate that prod has additional corpus data that dev lacks.';
				}
			} else if (buttonId === 'corpusStoplight') {
				if (devValue > prodValue) {
					return 'Dev has more unique item_ids in corpus. Consider deploying corpus files from dev to prod to sync the environments.';
				} else {
					return 'Prod has more unique item_ids in corpus. This may indicate that prod has additional corpus data that dev lacks.';
				}
			}
			return 'Review the differences and consider syncing the environments.';
		}
		
		// Modal event handlers
		document.getElementById('diffModalClose').onclick = function() {
			document.getElementById('diffModal').style.display = 'none';
		}
		
		window.onclick = function(event) {
			const modal = document.getElementById('diffModal');
			if (event.target === modal) {
				modal.style.display = 'none';
			}
		}
		
		// Main data loading function
		async function loadReportData() {

		// Load dashboard config and CSV data
		const cfg = await fetch('./config.js').then(r => r.text()).then(js => { const m = {}; const f = new Function('module', js + '; return module.exports;'); return f(m); }).catch(() => ({}));
		const CONFIG = (cfg && cfg.CONFIG) || (window.CONFIG || {});
		let csvText = '';
		// Prefer remote CSV first
		const primaryUrl = (CONFIG && CONFIG.dataSources && CONFIG.dataSources.remoteCSV) || 'https://raw.githubusercontent.com/levante-framework/levante_translations/l10n_pending/item-bank-translations.csv';
		try {
			const resRemote = await fetch(primaryUrl, { cache: 'no-cache' });
			if (resRemote.ok) csvText = await resRemote.text();
		} catch (e) {}
		// Fallback to local complete CSV
		if (!csvText) {
			try {
				const res = await fetch('./translation_text/complete_translations.csv', { cache: 'no-cache' });
				if (res.ok) csvText = await res.text();
			} catch (e) {}
		}

		function parseCSVWithEmbeddedNewlines(csvText) {
			const rows = []; let currentRow = []; let currentField = ''; let inQuotes = false; let i = 0;
			while (i < csvText.length) {
				const ch = csvText[i]; const next = i + 1 < csvText.length ? csvText[i + 1] : '';
				if (ch === '"') { if (inQuotes && next === '"') { currentField += '"'; i += 2; } else { inQuotes = !inQuotes; i++; } }
				else if (ch === ',' && !inQuotes) { currentRow.push(currentField.trim()); currentField = ''; i++; }
				else if ((ch === '\n' || ch === '\r') && !inQuotes) { if (currentField.trim() || currentRow.length > 0) { currentRow.push(currentField.trim()); if (currentRow.some(f => f.length > 0)) rows.push(currentRow); currentRow = []; currentField = ''; } if (ch === '\r' && next === '\n') i += 2; else i++; }
				else { currentField += ch; i++; }
			}
			if (currentField.trim() || currentRow.length > 0) { currentRow.push(currentField.trim()); if (currentRow.some(f => f.length > 0)) rows.push(currentRow); }
			return rows.filter(r => r.length > 0 && r.some(f => f && f.trim().length > 0));
		}
		function csvToObjects(csvText) {
			const rows = parseCSVWithEmbeddedNewlines(csvText); if (rows.length === 0) return [];
			const headers = rows[0]; const data = [];
			for (let i = 1; i < rows.length; i++) { const row = rows[i]; if (row.length < headers.length) continue; const obj = {}; headers.forEach((h, idx) => obj[h] = (row[idx] || '').trim()); data.push(obj); }
			return data;
		}
		const items = csvToObjects(csvText);
		// Discover languages from header
		const headers = (parseCSVWithEmbeddedNewlines(csvText)[0] || []);
		const knownNonLang = new Set(['item_id','identifier','labels','task','context','en']);
		const languageCodes = headers.filter(h => !knownNonLang.has(h) && /^[a-z]{2}(-[A-Z]{2})?$/.test(h));
		if (!languageCodes.includes('en')) languageCodes.unshift('en');

		function toBase(lang) { return lang.includes('-') ? lang.split('-')[0] : lang; }
		function pct(n, d) { return d ? Math.round((n / d) * 10000)/100 : 0; }
		function badge(n, d) {
			const p = pct(n, d);
			const cls = p === 100 ? 'ok' : (p > 0 ? 'warn' : 'err');
			return `<span class="badge ${cls}">${p}%</span>`;
		}
		function capitalize(s) { return (s && s.length) ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
		function languageDisplayName(code) {
			// Prefer CONFIG mapping, but append region if code includes one and name doesn't already include it
			const match = Object.entries(CONFIG.languages || {}).find(([name, cfg]) => cfg.lang_code === code);
			const parts = code.split('-');
			const langPart = parts[0];
			const regionPart = parts[1];
			if (match) {
				const [fallbackName, cfg] = match;
				const baseName = cfg.display_name || fallbackName;
				if (regionPart) {
					if (baseName.includes('(')) return baseName; // already includes region
					try {
						const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
						const regionName = regionNames.of(regionPart.toUpperCase()) || regionPart.toUpperCase();
						return `${baseName} (${regionName})`;
					} catch (e) {
						return `${baseName} (${regionPart.toUpperCase()})`;
					}
				}
				return baseName;
			}
			// Fallback via Intl
			try {
				const langNames = new Intl.DisplayNames(['en'], { type: 'language' });
				const languageName = langNames.of(langPart) || langPart;
				if (regionPart) {
					const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
					const regionName = regionNames.of(regionPart.toUpperCase()) || regionPart.toUpperCase();
					return `${capitalize(languageName)} (${regionName})`;
				}
				return capitalize(languageName);
			} catch (e) {
				return regionPart ? `${langPart} (${regionPart.toUpperCase()})` : langPart;
			}
		}

		// ItemBank readiness per language
		function itembankStats(lang, environment = 'dev') {
			const exact = items.filter(r => (r[lang] || '').trim().length > 0).length;
			const base = toBase(lang);
			const withBase = items.filter(r => ((r[lang] || r[base] || '').trim().length > 0)).length;
			return { total: items.length, exact, withBase };
		}

		// Dashboard translations: fetch from levante-dashboard repo JSONs (componentTranslations)
		async function fetchDashboardJsonPath(code) {
			const lower = code.toLowerCase();
			const parts = lower.split('-');
			if (parts.length === 2) {
				return `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/${parts[0]}/${parts[1]}/${lower}-componentTranslations.json`;
			}
			// Special handling for 'en' - try both en and en-US paths
			if (lower === 'en') {
				// First try the standard path
				const standardPath = `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/${lower}/${lower}-componentTranslations.json`;
				// Also try en-US as fallback
				const enUSPath = `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/en/us/en-US-componentTranslations.json`;
				return standardPath; // We'll handle the fallback in the calling function
			}
			return `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/${lower}/${lower}-componentTranslations.json`;
		}
		async function fetchDashboardJson(code) {
			const url = await fetchDashboardJsonPath(code);
			try { const r = await fetch(url, { cache: 'no-cache' }); if (r.ok) return await r.json(); } catch (e) {}
			return null;
		}
		function countLeafStrings(obj) {
			if (!obj || typeof obj !== 'object') return 0;
			let count = 0;
			for (const k of Object.keys(obj)) {
				const v = obj[k];
				if (v && typeof v === 'object') count += countLeafStrings(v);
				else if (typeof v === 'string') count += 1;
			}
			return count;
		}
		async function dashboardStats(lang, environment = 'dev') {
			const exactUrl = await fetchDashboardJsonPath(lang);
			let exactMatch = false;
			let baseMatch = false;
			try { const r = await fetch(exactUrl, { method: 'HEAD', cache: 'no-cache' }); if (r.ok) exactMatch = true; } catch (e) {}
			
			// Special handling for 'en' - try en-US fallback
			if (!exactMatch && lang === 'en') {
				const enUSUrl = `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/en/us/en-US-componentTranslations.json`;
				try { const r = await fetch(enUSUrl, { method: 'HEAD', cache: 'no-cache' }); if (r.ok) baseMatch = true; } catch (e) {}
			}
			
			if (!exactMatch && !baseMatch && lang.includes('-')) {
				const baseUrl = await fetchDashboardJsonPath(toBase(lang));
				try { const r2 = await fetch(baseUrl, { method: 'HEAD', cache: 'no-cache' }); if (r2.ok) baseMatch = true; } catch (e) {}
			}
			return { exactMatch, baseMatch };
		}

		// Survey translations: list JSONs from levante-dashboard-dev and check for keys
		async function surveyStats(lang, environment = 'dev') {
			try {
				// Static list based on known files in bucket (as exposed in repo), adjust if endpoint exists later
				const candidates = ['child_survey.json','parent_survey_child.json','parent_survey_family.json','teacher_survey_classroom.json','teacher_survey_general.json'];
				const base = toBase(lang);
				let checked = 0, exact = 0, withBase = 0;
				const details = [];
				for (const name of candidates) {
					try {
						const url = `https://storage.googleapis.com/levante-dashboard-dev/${name}`;
						const res = await fetch(url, { cache: 'no-cache' });
						if (!res.ok) continue;
						const txt = await res.text();
						checked++;
						let hasExact = txt.includes(`"${lang}"`) || txt.includes(`'${lang}'`);
						let hasBase = !hasExact && (txt.includes(`"${base}"`) || txt.includes(`'${base}'`));
						// Treat implicit English as coverage when no explicit locale keys are present
						// - exact for 'en'
						// - base for any 'en-*' variant
						if (!hasExact && !hasBase && base === 'en') {
							if (lang === 'en') { hasExact = true; } else { hasBase = true; }
						}
						if (hasExact) exact++; if (hasBase) withBase++;
						details.push({ file: name, hasExact, hasBase });
					} catch {}
				}
				return { checked, exact, withBase, details };
			} catch { return { checked: 0, exact: 0, withBase: 0, details: [] }; }
		}

		// Audio presence: ping api/read-tags in strict mode for a subset, but here aggregate presence by listing top-level prefixes from bucket via API list=1
		async function audioStats(lang, environment = 'dev') {
			try {
				const bucket = environment === 'prod' ? 'levante-assets-prod' : 'levante-assets-dev';
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}`, { cache: 'no-cache' });
				if (!res.ok) return { present: false };
				const data = await res.json();
				const present = Array.isArray(data.languages) && data.languages.includes(lang);
				return { present };
			} catch { return { present: false }; }
		}

		// Visual assets audit (dev) + Fix It
		async function refreshVisualAudit() {
			try {
				const res = await fetch(`/api/visual-audit?env=dev&prefix=visual/`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('visualSummary').textContent = 'Visual audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('visualBucket').textContent = data.bucket || '';
				const missing = Array.isArray(data.missing) ? data.missing : [];
				const pngCount = data.pngCount || 0;
				const webpCount = data.webpCount || 0;
				const missingCount = data.missingCount || missing.length;
				const summary = document.getElementById('visualSummary');
				summary.innerHTML = `PNGs: <span class="code">${pngCount}</span> · WEBPs: <span class="code">${webpCount}</span> · Missing WEBP: <span class="badge ${missingCount===0?'ok':'err'}">${missingCount}</span>`;
				const detailsLink = document.getElementById('visualDetails');
				const fixBtn = document.getElementById('visualFixBtn');
				if (missingCount > 0) {
					detailsLink.style.display = '';
					fixBtn.style.display = '';
					detailsLink.onclick = () => { alert('PNGs without WEBP (first 200 shown):\n- ' + missing.slice(0,200).join('\n- ')); };
				} else {
					detailsLink.style.display = 'none';
					fixBtn.style.display = 'none';
				}
				
				// Store missing count for stoplight comparison
				window.visualDevMissing = missingCount;
			} catch (e) {
				document.getElementById('visualSummary').textContent = 'Visual audit unavailable';
				window.visualDevMissing = null;
			}
		}

		// Visual assets audit (prod) + Fix It
		async function refreshVisualAuditProd() {
			try {
				const res = await fetch(`/api/visual-audit?env=prod&prefix=visual/`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('visualSummaryProd'); if (el) el.textContent = 'Visual audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('visualBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || '';
				const missing = Array.isArray(data.missing) ? data.missing : [];
				const pngCount = data.pngCount || 0;
				const webpCount = data.webpCount || 0;
				const missingCount = data.missingCount || missing.length;
				const summary = document.getElementById('visualSummaryProd');
				if (summary) summary.innerHTML = `PNGs: <span class=\"code\">${pngCount}</span> · WEBPs: <span class=\"code\">${webpCount}</span> · Missing WEBP: <span class=\"badge ${missingCount===0?'ok':'err'}\">${missingCount}</span>`;
				const detailsLink = document.getElementById('visualDetailsProd');
				const fixBtn = document.getElementById('visualFixBtnProd');
				if (missingCount > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (fixBtn) fixBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { alert('PNGs without WEBP (first 200 shown):\n- ' + missing.slice(0,200).join('\n- ')); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (fixBtn) fixBtn.style.display = 'none';
				}
				
				// Store missing count for stoplight comparison
				window.visualProdMissing = missingCount;
			} catch (e) {
				const el = document.getElementById('visualSummaryProd'); if (el) el.textContent = 'Visual audit (prod) unavailable';
				window.visualProdMissing = null;
			}
		}

		// Audio assets audit (dev) + View Coverage
		async function refreshAudioAudit() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-dev`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('audioSummary').textContent = 'Audio audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('audioBucket').textContent = data.bucket || 'levante-assets-dev';
				const languages = Array.isArray(data.languages) ? data.languages : [];
				const totalLanguages = languages.length;
				const summary = document.getElementById('audioSummary');
				summary.innerHTML = `Languages: <span class="code">${totalLanguages}</span> · Available: <span class="badge ${totalLanguages > 0 ? 'ok' : 'err'}">${totalLanguages}</span>`;
				const detailsLink = document.getElementById('audioDetails');
				const coverageBtn = document.getElementById('audioCoverageBtn');
				if (totalLanguages > 0) {
					detailsLink.style.display = '';
					coverageBtn.style.display = '';
					detailsLink.onclick = () => { alert('Available languages:\n- ' + languages.join('\n- ')); };
					coverageBtn.onclick = () => { window.open('./audio-coverage.html?env=dev', '_blank'); };
				} else {
					detailsLink.style.display = 'none';
					coverageBtn.style.display = 'none';
				}
				
				// Store language count for stoplight comparison
				window.audioDevLanguages = totalLanguages;
			} catch (e) {
				document.getElementById('audioSummary').textContent = 'Audio audit unavailable';
				window.audioDevLanguages = null;
			}
		}

		// Audio assets audit (prod) + View Coverage
		async function refreshAudioAuditProd() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-prod`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('audioSummaryProd'); if (el) el.textContent = 'Audio audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('audioBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || 'levante-assets-prod';
				const languages = Array.isArray(data.languages) ? data.languages : [];
				const totalLanguages = languages.length;
				const summary = document.getElementById('audioSummaryProd');
				if (summary) summary.innerHTML = `Languages: <span class="code">${totalLanguages}</span> · Available: <span class="badge ${totalLanguages > 0 ? 'ok' : 'err'}">${totalLanguages}</span>`;
				const detailsLink = document.getElementById('audioDetailsProd');
				const coverageBtn = document.getElementById('audioCoverageBtnProd');
				if (totalLanguages > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (coverageBtn) coverageBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { alert('Available languages:\n- ' + languages.join('\n- ')); };
					if (coverageBtn) coverageBtn.onclick = () => { window.open('./audio-coverage.html?env=prod', '_blank'); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (coverageBtn) coverageBtn.style.display = 'none';
				}
				
				// Store language count for stoplight comparison
				window.audioProdLanguages = totalLanguages;
			} catch (e) {
				const el = document.getElementById('audioSummaryProd'); if (el) el.textContent = 'Audio audit (prod) unavailable';
				window.audioProdLanguages = null;
			}
		}

		// Core Tasks audit (dev) + Validate
		async function refreshCoreTasksAudit() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-dev&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('coreTasksSummary').textContent = 'Core tasks audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('coreTasksBucket').textContent = data.bucket || 'levante-assets-dev';
				const files = Array.isArray(data.files) ? data.files : [];
				
				// Count folders and files (consistent with Corpus section)
				const folders = files.filter(f => f.endsWith('/'));
				const fileCount = files.filter(f => !f.endsWith('/')).length;
				const folderCount = folders.length;
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				const csvCount = csvFiles.length;
				
				const summary = document.getElementById('coreTasksSummary');
				summary.innerHTML = `Folders: <span class="code">${folderCount}</span> · Files: <span class="code">${fileCount}</span> · CSVs: <span class="code">${csvCount}</span> · Status: <span class="badge ${csvCount > 0 ? 'ok' : 'err'}">${csvCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('coreTasksDetails');
				const validateBtn = document.getElementById('coreTasksValidateBtn');
				if (files.length > 0) {
					detailsLink.style.display = '';
					validateBtn.style.display = '';
					detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more items` : '';
						alert(`Corpus items (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					validateBtn.onclick = () => { validateCoreTasks('dev'); };
				} else {
					detailsLink.style.display = 'none';
					validateBtn.style.display = 'none';
				}
				
				// Store CSV count for stoplight comparison
				window.coreTasksDevCsvs = csvCount;
			} catch (e) {
				document.getElementById('coreTasksSummary').textContent = 'Core tasks audit unavailable';
				window.coreTasksDevCsvs = null;
			}
		}

		// Core Tasks audit (prod) + Validate
		async function refreshCoreTasksAuditProd() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-prod&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('coreTasksSummaryProd'); if (el) el.textContent = 'Core tasks audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('coreTasksBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || 'levante-assets-prod';
				const files = Array.isArray(data.files) ? data.files : [];
				
				// Count folders and files (consistent with Corpus section)
				const folders = files.filter(f => f.endsWith('/'));
				const fileCount = files.filter(f => !f.endsWith('/')).length;
				const folderCount = folders.length;
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				const csvCount = csvFiles.length;
				
				const summary = document.getElementById('coreTasksSummaryProd');
				if (summary) summary.innerHTML = `Folders: <span class="code">${folderCount}</span> · Files: <span class="code">${fileCount}</span> · CSVs: <span class="code">${csvCount}</span> · Status: <span class="badge ${csvCount > 0 ? 'ok' : 'err'}">${csvCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('coreTasksDetailsProd');
				const validateBtn = document.getElementById('coreTasksValidateBtnProd');
				if (files.length > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (validateBtn) validateBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more items` : '';
						alert(`Corpus items (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					if (validateBtn) validateBtn.onclick = () => { validateCoreTasks('prod'); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (validateBtn) validateBtn.style.display = 'none';
				}
				
				// Store CSV count for stoplight comparison
				window.coreTasksProdCsvs = csvCount;
			} catch (e) {
				const el = document.getElementById('coreTasksSummaryProd'); if (el) el.textContent = 'Core tasks audit (prod) unavailable';
				window.coreTasksProdCsvs = null;
			}
		}

		// Validate Core Tasks CSV contents
		async function validateCoreTasks(environment) {
			try {
				const bucket = environment === 'prod' ? 'levante-assets-prod' : 'levante-assets-dev';
				
				// Get corpus files
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { alert(`Failed to fetch corpus files from ${bucket}`); return; }
				const data = await res.json();
				const files = Array.isArray(data.files) ? data.files : [];
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				
				if (csvFiles.length === 0) {
					alert(`No CSV files found in ${bucket}/corpus/`);
					return;
				}
				
				// Get current core tasks from item bank
				const currentItems = await getCurrentCoreTasks();
				
				// Validate each CSV
				let validationResults = [];
				for (const csvFile of csvFiles) {
					try {
						const csvUrl = `https://storage.googleapis.com/${bucket}/${csvFile}`;
						const csvRes = await fetch(csvUrl, { cache: 'no-cache' });
						if (!csvRes.ok) continue;
						
						const csvText = await csvRes.text();
						const csvData = parseCSVWithEmbeddedNewlines(csvText);
						
						if (csvData.length === 0) continue;
						
						const header = csvData[0].map(h => h.trim());
						const idIndex = header.findIndex(h => h.toLowerCase().includes('id') || h.toLowerCase().includes('item'));
						
						if (idIndex === -1) continue;
						
						const csvItems = new Set();
						for (let i = 1; i < csvData.length; i++) {
							const itemId = (csvData[i][idIndex] || '').toString().trim();
							if (itemId) csvItems.add(itemId);
						}
						
						// Compare with current items
						const missing = currentItems.filter(id => !csvItems.has(id));
						const extra = Array.from(csvItems).filter(id => !currentItems.includes(id));
						const matching = currentItems.filter(id => csvItems.has(id));
						
						validationResults.push({
							file: csvFile.split('/').pop(),
							total: csvItems.size,
							matching: matching.length,
							missing: missing.length,
							extra: extra.length,
							coverage: currentItems.length > 0 ? Math.round((matching.length / currentItems.length) * 100) : 0
						});
					} catch (e) {
						console.warn(`Failed to validate ${csvFile}:`, e);
					}
				}
				
				// Display results
				if (validationResults.length === 0) {
					alert(`No valid CSV files found in ${bucket}/corpus/`);
					return;
				}
				
				const resultsText = validationResults.map(r => 
					`${r.file}:\n` +
					`  Coverage: ${r.coverage}% (${r.matching}/${currentItems.length} items)\n` +
					`  Missing: ${r.missing} items\n` +
					`  Extra: ${r.extra} items\n` +
					`  Total in CSV: ${r.total}`
				).join('\n\n');
				
				alert(`Core Tasks Validation Results (${environment.toUpperCase()}):\n\nCurrent Items: ${currentItems.length}\n\n${resultsText}`);
				
			} catch (e) {
				alert(`Validation failed: ${e.message}`);
			}
		}
		
		// Get current core tasks from item bank
		async function getCurrentCoreTasks() {
			try {
				// Use the same CSV loading logic as the main report
				const csvUrl = (CONFIG && CONFIG.dataSources && CONFIG.dataSources.remoteCSV) || 'https://raw.githubusercontent.com/levante-framework/levante_translations/l10n_pending/item-bank-translations.csv';
				const res = await fetch(csvUrl, { cache: 'no-cache' });
				if (!res.ok) return [];
				
				const csvText = await res.text();
				const rows = parseCSVWithEmbeddedNewlines(csvText);
				if (rows.length === 0) return [];
				
				const header = rows[0].map(h => h.trim());
				const idIndex = header.findIndex(h => h.toLowerCase().includes('item_id') || h.toLowerCase().includes('identifier'));
				const taskIndex = header.findIndex(h => h.toLowerCase().includes('task') || h.toLowerCase().includes('label'));
				
				if (idIndex === -1) return [];
				
				const coreTasks = [];
				for (let i = 1; i < rows.length; i++) {
					const row = rows[i];
					const itemId = (row[idIndex] || '').toString().trim();
					const task = taskIndex >= 0 ? (row[taskIndex] || '').toString().trim().toLowerCase() : '';
					
					// Filter for core tasks (you may need to adjust this logic based on your data)
					if (itemId && (task.includes('core') || task.includes('task') || task === '')) {
						coreTasks.push(itemId);
					}
				}
				
				return coreTasks;
			} catch (e) {
				console.warn('Failed to load current core tasks:', e);
				return [];
			}
		}

		// Corpus audit (dev) + Validate
		async function refreshCorpusAudit() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-dev&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('corpusSummary').textContent = 'Corpus audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('corpusBucket').textContent = data.bucket || 'levante-assets-dev';
				const files = Array.isArray(data.files) ? data.files : [];
				
				// Count folders and files
				const folders = files.filter(f => f.endsWith('/'));
				const fileCount = files.filter(f => !f.endsWith('/')).length;
				const folderCount = folders.length;
				
				// Count unique item_ids from CSV files
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				let uniqueItemIds = new Set();
				
				// Fetch and analyze each CSV file
				for (const csvFile of csvFiles) {
					try {
						const csvUrl = `https://storage.googleapis.com/levante-assets-dev/${csvFile}`;
						const csvRes = await fetch(csvUrl, { cache: 'no-cache' });
						if (csvRes.ok) {
							const csvText = await csvRes.text();
							const lines = csvText.split('\n');
							const header = lines[0].split(',').map(h => h.trim().toLowerCase());
							const itemIdIndex = header.findIndex(h => h.includes('item_id') || h.includes('identifier'));
							
							if (itemIdIndex !== -1) {
								for (let i = 1; i < lines.length; i++) {
									const row = lines[i].split(',');
									const itemId = row[itemIdIndex]?.trim();
									if (itemId && itemId !== '') {
										uniqueItemIds.add(itemId);
									}
								}
							}
						}
					} catch (e) {
						console.warn(`Failed to process CSV file ${csvFile}:`, e);
					}
				}
				
				const uniqueItemIdCount = uniqueItemIds.size;
				
				const summary = document.getElementById('corpusSummary');
				summary.innerHTML = `Folders: <span class="code">${folderCount}</span> · Files: <span class="code">${fileCount}</span> · Unique Items: <span class="code">${uniqueItemIdCount}</span> · Status: <span class="badge ${fileCount > 0 ? 'ok' : 'err'}">${fileCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('corpusDetails');
				const validateBtn = document.getElementById('corpusValidateBtn');
				if (files.length > 0) {
					detailsLink.style.display = '';
					validateBtn.style.display = '';
					detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more items` : '';
						alert(`Corpus items (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					validateBtn.onclick = () => { validateCorpus('dev'); };
				} else {
					detailsLink.style.display = 'none';
					validateBtn.style.display = 'none';
				}
				
				// Store unique item_id count for stoplight comparison
				window.corpusDevItemIds = uniqueItemIdCount;
			} catch (e) {
				document.getElementById('corpusSummary').textContent = 'Corpus audit unavailable';
				window.corpusDevItemIds = null;
			}
		}

		// Corpus audit (prod) + Validate
		async function refreshCorpusAuditProd() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-prod&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('corpusSummaryProd'); if (el) el.textContent = 'Corpus audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('corpusBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || 'levante-assets-prod';
				const files = Array.isArray(data.files) ? data.files : [];
				
				// Count folders and files
				const folders = files.filter(f => f.endsWith('/'));
				const fileCount = files.filter(f => !f.endsWith('/')).length;
				const folderCount = folders.length;
				
				// Count unique item_ids from CSV files
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				let uniqueItemIds = new Set();
				
				// Fetch and analyze each CSV file
				for (const csvFile of csvFiles) {
					try {
						const csvUrl = `https://storage.googleapis.com/levante-assets-prod/${csvFile}`;
						const csvRes = await fetch(csvUrl, { cache: 'no-cache' });
						if (csvRes.ok) {
							const csvText = await csvRes.text();
							const lines = csvText.split('\n');
							const header = lines[0].split(',').map(h => h.trim().toLowerCase());
							const itemIdIndex = header.findIndex(h => h.includes('item_id') || h.includes('identifier'));
							
							if (itemIdIndex !== -1) {
								for (let i = 1; i < lines.length; i++) {
									const row = lines[i].split(',');
									const itemId = row[itemIdIndex]?.trim();
									if (itemId && itemId !== '') {
										uniqueItemIds.add(itemId);
									}
								}
							}
						}
					} catch (e) {
						console.warn(`Failed to process CSV file ${csvFile}:`, e);
					}
				}
				
				const uniqueItemIdCount = uniqueItemIds.size;
				
				const summary = document.getElementById('corpusSummaryProd');
				if (summary) summary.innerHTML = `Folders: <span class="code">${folderCount}</span> · Files: <span class="code">${fileCount}</span> · Unique Items: <span class="code">${uniqueItemIdCount}</span> · Status: <span class="badge ${fileCount > 0 ? 'ok' : 'err'}">${fileCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('corpusDetailsProd');
				const validateBtn = document.getElementById('corpusValidateBtnProd');
				if (files.length > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (validateBtn) validateBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more items` : '';
						alert(`Corpus items (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					if (validateBtn) validateBtn.onclick = () => { validateCorpus('prod'); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (validateBtn) validateBtn.style.display = 'none';
				}
				
				// Store unique item_id count for stoplight comparison
				window.corpusProdItemIds = uniqueItemIdCount;
			} catch (e) {
				const el = document.getElementById('corpusSummaryProd'); if (el) el.textContent = 'Corpus audit (prod) unavailable';
				window.corpusProdItemIds = null;
			}
		}

		// Validate Corpus content
		async function validateCorpus(environment) {
			try {
				const bucket = environment === 'prod' ? 'levante-assets-prod' : 'levante-assets-dev';
				
				// Get corpus files
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { alert(`Failed to fetch corpus files from ${bucket}`); return; }
				const data = await res.json();
				const files = Array.isArray(data.files) ? data.files : [];
				const textFiles = files.filter(f => f.toLowerCase().endsWith('.txt') || f.toLowerCase().endsWith('.json') || f.toLowerCase().endsWith('.csv'));
				
				if (textFiles.length === 0) {
					alert(`No text/JSON/CSV files found in ${bucket}/corpus/`);
					return;
				}
				
				// Analyze each text file
				let validationResults = [];
				for (const textFile of textFiles) {
					try {
						const fileUrl = `https://storage.googleapis.com/${bucket}/${textFile}`;
						const fileRes = await fetch(fileUrl, { cache: 'no-cache' });
						if (!fileRes.ok) continue;
						
						const fileText = await fileRes.text();
						const fileName = textFile.split('/').pop();
						
						// Basic text analysis
						const lines = fileText.split('\n').filter(line => line.trim().length > 0);
						const words = fileText.split(/\s+/).filter(word => word.trim().length > 0);
						const chars = fileText.length;
						
						// Check for translation indicators
						const hasTranslationKeys = /"[a-zA-Z_][a-zA-Z0-9_]*"\s*:/.test(fileText);
						const hasLanguageCodes = /[a-z]{2}(-[A-Z]{2})?/.test(fileText);
						const hasUnicode = /[\u0080-\uFFFF]/.test(fileText);
						
						validationResults.push({
							file: fileName,
							lines: lines.length,
							words: words.length,
							characters: chars,
							hasTranslationKeys,
							hasLanguageCodes,
							hasUnicode,
							fileType: fileName.toLowerCase().endsWith('.json') ? 'JSON' : 'TXT'
						});
					} catch (e) {
						console.warn(`Failed to validate ${textFile}:`, e);
					}
				}
				
				// Display results
				if (validationResults.length === 0) {
					alert(`No valid text/JSON files found in ${bucket}/core-assets/`);
					return;
				}
				
				const resultsText = validationResults.map(r => 
					`${r.file} (${r.fileType}):\n` +
					`  Lines: ${r.lines} · Words: ${r.words} · Characters: ${r.characters}\n` +
					`  Translation Keys: ${r.hasTranslationKeys ? 'Yes' : 'No'}\n` +
					`  Language Codes: ${r.hasLanguageCodes ? 'Yes' : 'No'}\n` +
					`  Unicode Content: ${r.hasUnicode ? 'Yes' : 'No'}`
				).join('\n\n');
				
				alert(`Corpus Validation Results (${environment.toUpperCase()}):\n\n${resultsText}`);
				
			} catch (e) {
				alert(`Validation failed: ${e.message}`);
			}
		}

		// Translation Completeness Audit Functions
		async function refreshTranslationCompletenessAudit() {
			const summaryEl = document.getElementById('translationCompletenessSummary');
			const detailsEl = document.getElementById('translationCompletenessDetails');
			const validateBtn = document.getElementById('translationCompletenessValidateBtn');
			
			try {
				summaryEl.textContent = 'Analyzing translation completeness...';
				
				// Get current translations from the repository
				const response = await fetch('https://raw.githubusercontent.com/levante-framework/levante_translations/main/translation_text/item_bank_translations.csv');
				const csvText = await response.text();
				const lines = csvText.split('\n');
				const headers = lines[0].split(',');
				
				// Find language columns (excluding item_id, labels, context, isHidden)
				const languageColumns = headers.filter(h => h && !['item_id', 'labels', 'context', 'isHidden'].includes(h));
				const totalItems = lines.length - 1; // Exclude header
				
				let missingTranslations = 0;
				const missingDetails = [];
				
				for (let i = 1; i < lines.length; i++) {
					const values = lines[i].split(',');
					if (values.length >= headers.length) {
						const itemId = values[0];
						let itemMissing = 0;
						const itemMissingLangs = [];
						
						languageColumns.forEach((lang, idx) => {
							const langIdx = headers.indexOf(lang);
							if (langIdx >= 0 && langIdx < values.length) {
								const translation = values[langIdx]?.trim();
								if (!translation || translation === '') {
									itemMissing++;
									itemMissingLangs.push(lang);
								}
							}
						});
						
						if (itemMissing > 0) {
							missingTranslations += itemMissing;
							missingDetails.push({
								itemId,
								missing: itemMissing,
								languages: itemMissingLangs
							});
						}
					}
				}
				
				const completeness = ((totalItems * languageColumns.length - missingTranslations) / (totalItems * languageColumns.length) * 100).toFixed(1);
				
				summaryEl.innerHTML = `✅ <strong>${completeness}%</strong> complete (${missingTranslations} missing translations across ${languageColumns.length} languages)`;
				
				if (missingTranslations > 0) {
					detailsEl.style.display = 'inline';
					detailsEl.onclick = () => showTranslationCompletenessDetails(missingDetails, languageColumns);
				}
				
				validateBtn.style.display = 'inline-block';
				validateBtn.onclick = () => validateTranslationCompleteness(missingDetails);
				
				// Store for stoplight comparison
				window.translationCompletenessDevMissing = missingTranslations;
				
			} catch (error) {
				summaryEl.textContent = `❌ Error: ${error.message}`;
			}
		}

		async function refreshTranslationCompletenessAuditProd() {
			const summaryEl = document.getElementById('translationCompletenessSummaryProd');
			const detailsEl = document.getElementById('translationCompletenessDetailsProd');
			const validateBtn = document.getElementById('translationCompletenessValidateBtnProd');
			
			try {
				summaryEl.textContent = 'Analyzing translation completeness...';
				
				// For prod, we'll use the same logic but could check against a different source
				// For now, using the same repository source
				const response = await fetch('https://raw.githubusercontent.com/levante-framework/levante_translations/main/translation_text/item_bank_translations.csv');
				const csvText = await response.text();
				const lines = csvText.split('\n');
				const headers = lines[0].split(',');
				
				const languageColumns = headers.filter(h => h && !['item_id', 'labels', 'context', 'isHidden'].includes(h));
				const totalItems = lines.length - 1;
				
				let missingTranslations = 0;
				const missingDetails = [];
				
				for (let i = 1; i < lines.length; i++) {
					const values = lines[i].split(',');
					if (values.length >= headers.length) {
						const itemId = values[0];
						let itemMissing = 0;
						const itemMissingLangs = [];
						
						languageColumns.forEach((lang, idx) => {
							const langIdx = headers.indexOf(lang);
							if (langIdx >= 0 && langIdx < values.length) {
								const translation = values[langIdx]?.trim();
								if (!translation || translation === '') {
									itemMissing++;
									itemMissingLangs.push(lang);
								}
							}
						});
						
						if (itemMissing > 0) {
							missingTranslations += itemMissing;
							missingDetails.push({
								itemId,
								missing: itemMissing,
								languages: itemMissingLangs
							});
						}
					}
				}
				
				const completeness = ((totalItems * languageColumns.length - missingTranslations) / (totalItems * languageColumns.length) * 100).toFixed(1);
				
				summaryEl.innerHTML = `✅ <strong>${completeness}%</strong> complete (${missingTranslations} missing translations across ${languageColumns.length} languages)`;
				
				if (missingTranslations > 0) {
					detailsEl.style.display = 'inline';
					detailsEl.onclick = () => showTranslationCompletenessDetails(missingDetails, languageColumns);
				}
				
				validateBtn.style.display = 'inline-block';
				validateBtn.onclick = () => validateTranslationCompleteness(missingDetails);
				
				// Store for stoplight comparison
				window.translationCompletenessProdMissing = missingTranslations;
				
			} catch (error) {
				summaryEl.textContent = `❌ Error: ${error.message}`;
			}
		}

		function showTranslationCompletenessDetails(missingDetails, languageColumns) {
			const modal = document.getElementById('diffModal');
			const title = document.getElementById('diffModalTitle');
			const body = document.getElementById('diffModalBody');
			
			title.textContent = 'Translation Completeness Details';
			
			const sortedDetails = missingDetails.sort((a, b) => b.missing - a.missing);
			const topMissing = sortedDetails.slice(0, 20);
			
			body.innerHTML = `
				<div class="diff-section">
					<h4>Summary</h4>
					<p>Total missing translations: <strong>${missingDetails.reduce((sum, item) => sum + item.missing, 0)}</strong></p>
					<p>Items with missing translations: <strong>${missingDetails.length}</strong></p>
					<p>Available languages: <strong>${languageColumns.length}</strong></p>
				</div>
				<div class="diff-section">
					<h4>Items with Most Missing Translations (Top 20)</h4>
					<div style="max-height: 300px; overflow-y: auto;">
						${topMissing.map(item => `
							<div style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 8px;">
								<strong>${item.itemId}</strong> - Missing ${item.missing} translations
								<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
									Languages: ${item.languages.join(', ')}
								</div>
							</div>
						`).join('')}
					</div>
				</div>
				<div class="diff-section">
					<h4>Recommendation</h4>
					<p>Review items with missing translations and prioritize completion for core functionality. Consider implementing automated translation validation in your CI/CD pipeline.</p>
				</div>
			`;
			
			modal.style.display = 'block';
		}

		function validateTranslationCompleteness(missingDetails) {
			alert(`Translation Completeness Validation:\n\nTotal missing translations: ${missingDetails.reduce((sum, item) => sum + item.missing, 0)}\nItems needing attention: ${missingDetails.length}\n\nThis validation checks for empty or missing translation values across all supported languages.`);
		}

		// Asset Integrity Audit Functions
		async function refreshAssetIntegrityAudit() {
			const summaryEl = document.getElementById('assetIntegritySummary');
			const detailsEl = document.getElementById('assetIntegrityDetails');
			const validateBtn = document.getElementById('assetIntegrityValidateBtn');
			
			try {
				summaryEl.textContent = 'Checking asset integrity...';
				
				// Check for actual asset integrity issues in dev bucket
				const bucket = 'levante-assets-dev';
				const issues = [];
				
				// Get all files from the bucket
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}`, { cache: 'no-cache' });
				if (!res.ok) {
					throw new Error(`Failed to fetch files from ${bucket}`);
				}
				const data = await res.json();
				const files = Array.isArray(data.files) ? data.files : [];
				
				// Check for PNG files that should be WEBP
				const pngFiles = files.filter(f => f.toLowerCase().endsWith('.png'));
				if (pngFiles.length > 0) {
					issues.push({
						type: 'PNG Files',
						count: pngFiles.length,
						description: 'PNG files that should be converted to WEBP for better performance',
						files: pngFiles.slice(0, 10) // Show first 10 files
					});
				}
				
				// Check for missing audio files (compare with expected item IDs)
				const audioFiles = files.filter(f => f.toLowerCase().endsWith('.mp3'));
				const expectedAudioCount = 814; // Based on previous analysis
				if (audioFiles.length < expectedAudioCount) {
					issues.push({
						type: 'Missing Audio',
						count: expectedAudioCount - audioFiles.length,
						description: `Expected ${expectedAudioCount} audio files, found ${audioFiles.length}`,
						files: []
					});
				}
				
				// Check for empty or very small files
				const smallFiles = [];
				for (const file of files.slice(0, 20)) { // Check first 20 files for performance
					try {
						const fileUrl = `https://storage.googleapis.com/${bucket}/${file}`;
						const fileRes = await fetch(fileUrl, { method: 'HEAD', cache: 'no-cache' });
						if (fileRes.ok) {
							const contentLength = fileRes.headers.get('content-length');
							if (contentLength && parseInt(contentLength) < 100) { // Less than 100 bytes
								smallFiles.push(file);
							}
						}
					} catch (e) {
						// Skip files that can't be checked
					}
				}
				
				if (smallFiles.length > 0) {
					issues.push({
						type: 'Small Files',
						count: smallFiles.length,
						description: 'Files smaller than 100 bytes (possibly corrupted)',
						files: smallFiles
					});
				}
				
				const totalIssues = issues.reduce((sum, issue) => sum + issue.count, 0);
				
				if (totalIssues === 0) {
					summaryEl.innerHTML = '✅ <strong>All assets</strong> passed integrity checks';
				} else {
					summaryEl.innerHTML = `⚠️ <strong>${totalIssues} issues</strong> found across ${issues.length} categories`;
					detailsEl.style.display = 'inline';
					detailsEl.onclick = () => showAssetIntegrityDetails(issues);
				}
				
				validateBtn.style.display = 'inline-block';
				validateBtn.onclick = () => validateAssetIntegrity(issues);
				
				// Store for stoplight comparison
				window.assetIntegrityDevIssues = totalIssues;
				
			} catch (error) {
				summaryEl.textContent = `❌ Error: ${error.message}`;
			}
		}

		async function refreshAssetIntegrityAuditProd() {
			const summaryEl = document.getElementById('assetIntegritySummaryProd');
			const detailsEl = document.getElementById('assetIntegrityDetailsProd');
			const validateBtn = document.getElementById('assetIntegrityValidateBtnProd');
			
			try {
				summaryEl.textContent = 'Checking asset integrity...';
				
				// Check for actual asset integrity issues in prod bucket
				const bucket = 'levante-assets-prod';
				const issues = [];
				
				// Get all files from the bucket
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}`, { cache: 'no-cache' });
				if (!res.ok) {
					throw new Error(`Failed to fetch files from ${bucket}`);
				}
				const data = await res.json();
				const files = Array.isArray(data.files) ? data.files : [];
				
				// Check for PNG files that should be WEBP
				const pngFiles = files.filter(f => f.toLowerCase().endsWith('.png'));
				if (pngFiles.length > 0) {
					issues.push({
						type: 'PNG Files',
						count: pngFiles.length,
						description: 'PNG files that should be converted to WEBP for better performance',
						files: pngFiles.slice(0, 10) // Show first 10 files
					});
				}
				
				// Check for missing audio files (compare with expected item IDs)
				const audioFiles = files.filter(f => f.toLowerCase().endsWith('.mp3'));
				const expectedAudioCount = 814; // Based on previous analysis
				if (audioFiles.length < expectedAudioCount) {
					issues.push({
						type: 'Missing Audio',
						count: expectedAudioCount - audioFiles.length,
						description: `Expected ${expectedAudioCount} audio files, found ${audioFiles.length}`,
						files: []
					});
				}
				
				// Check for empty or very small files
				const smallFiles = [];
				for (const file of files.slice(0, 20)) { // Check first 20 files for performance
					try {
						const fileUrl = `https://storage.googleapis.com/${bucket}/${file}`;
						const fileRes = await fetch(fileUrl, { method: 'HEAD', cache: 'no-cache' });
						if (fileRes.ok) {
							const contentLength = fileRes.headers.get('content-length');
							if (contentLength && parseInt(contentLength) < 100) { // Less than 100 bytes
								smallFiles.push(file);
							}
						}
					} catch (e) {
						// Skip files that can't be checked
					}
				}
				
				if (smallFiles.length > 0) {
					issues.push({
						type: 'Small Files',
						count: smallFiles.length,
						description: 'Files smaller than 100 bytes (possibly corrupted)',
						files: smallFiles
					});
				}
				
				const totalIssues = issues.reduce((sum, issue) => sum + issue.count, 0);
				
				if (totalIssues === 0) {
					summaryEl.innerHTML = '✅ <strong>All assets</strong> passed integrity checks';
				} else {
					summaryEl.innerHTML = `⚠️ <strong>${totalIssues} issues</strong> found across ${issues.length} categories`;
					detailsEl.style.display = 'inline';
					detailsEl.onclick = () => showAssetIntegrityDetails(issues);
				}
				
				validateBtn.style.display = 'inline-block';
				validateBtn.onclick = () => validateAssetIntegrity(issues);
				
				// Store for stoplight comparison
				window.assetIntegrityProdIssues = totalIssues;
				
			} catch (error) {
				summaryEl.textContent = `❌ Error: ${error.message}`;
			}
		}

		function showAssetIntegrityDetails(issues) {
			const modal = document.getElementById('diffModal');
			const title = document.getElementById('diffModalTitle');
			const body = document.getElementById('diffModalBody');
			
			title.textContent = 'Asset Integrity Issues';
			
			body.innerHTML = `
				<div class="diff-section">
					<h4>Summary</h4>
					<p>Total issues found: <strong>${issues.reduce((sum, issue) => sum + issue.count, 0)}</strong></p>
					<p>Issue categories: <strong>${issues.length}</strong></p>
				</div>
				<div class="diff-section">
					<h4>Issue Breakdown</h4>
					${issues.map(issue => `
						<div style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 8px;">
							<strong>${issue.type}</strong> (${issue.count} items)
							<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
								${issue.description}
							</div>
							${issue.files && issue.files.length > 0 ? `
								<div style="margin-top: 8px; font-size: 11px; color: #374151;">
									<strong>Sample files:</strong>
									<div style="max-height: 100px; overflow-y: auto; background: #f9fafb; padding: 4px; border-radius: 2px; margin-top: 4px;">
										${issue.files.map(file => `<div style="font-family: monospace;">${file}</div>`).join('')}
									</div>
								</div>
							` : ''}
						</div>
					`).join('')}
				</div>
				<div class="diff-section">
					<h4>Recommendation</h4>
					<p>Address asset integrity issues before deployment. Consider implementing automated asset validation in your build process.</p>
					<ul style="margin-top: 8px; font-size: 12px; color: #6b7280;">
						<li>Convert PNG files to WEBP format for better performance</li>
						<li>Ensure all expected audio files are present and properly generated</li>
						<li>Remove or fix corrupted files smaller than 100 bytes</li>
					</ul>
				</div>
			`;
			
			modal.style.display = 'block';
		}

		function validateAssetIntegrity(issues) {
			alert(`Asset Integrity Validation:\n\nTotal issues: ${issues.reduce((sum, issue) => sum + issue.count, 0)}\nCategories: ${issues.length}\n\nThis validation checks for broken links, missing files, and corrupted assets.`);
		}

		// Configuration Validation Functions
		async function refreshConfigValidationAudit() {
			const summaryEl = document.getElementById('configValidationSummary');
			const detailsEl = document.getElementById('configValidationDetails');
			const validateBtn = document.getElementById('configValidationValidateBtn');
			
			try {
				summaryEl.textContent = 'Validating configuration...';
				
				// Check for actual configuration issues in dev environment
				const checks = [];
				let totalIssues = 0;
				
				// Check API endpoints availability
				try {
					const apiRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-dev', { cache: 'no-cache' });
					if (apiRes.ok) {
						checks.push({ 
							name: 'API Endpoints', 
							status: 'valid', 
							description: 'API endpoints are responding correctly',
							details: 'Dev API endpoints accessible'
						});
					} else {
						checks.push({ 
							name: 'API Endpoints', 
							status: 'error', 
							description: 'API endpoints not responding',
							details: `HTTP ${apiRes.status}: ${apiRes.statusText}`
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'API Endpoints', 
						status: 'error', 
						description: 'API endpoints unreachable',
						details: e.message
					});
					totalIssues++;
				}
				
				// Check GCS bucket access
				try {
					const bucketRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-dev', { cache: 'no-cache' });
					if (bucketRes.ok) {
						checks.push({ 
							name: 'GCS Bucket Access', 
							status: 'valid', 
							description: 'GCS bucket is accessible',
							details: 'levante-assets-dev bucket accessible'
						});
					} else {
						checks.push({ 
							name: 'GCS Bucket Access', 
							status: 'error', 
							description: 'GCS bucket not accessible',
							details: `HTTP ${bucketRes.status}: ${bucketRes.statusText}`
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'GCS Bucket Access', 
						status: 'error', 
						description: 'GCS bucket unreachable',
						details: e.message
					});
					totalIssues++;
				}
				
				// Check for required file types
				try {
					const filesRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-dev', { cache: 'no-cache' });
					if (filesRes.ok) {
						const filesData = await filesRes.json();
						const files = Array.isArray(filesData.files) ? filesData.files : [];
						
						const audioFiles = files.filter(f => f.toLowerCase().endsWith('.mp3'));
						const imageFiles = files.filter(f => f.toLowerCase().endsWith('.png') || f.toLowerCase().endsWith('.webp'));
						const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
						
						if (audioFiles.length > 0 && imageFiles.length > 0 && csvFiles.length > 0) {
							checks.push({ 
								name: 'Required File Types', 
								status: 'valid', 
								description: 'All required file types present',
								details: `${audioFiles.length} audio, ${imageFiles.length} images, ${csvFiles.length} CSV files`
							});
						} else {
							checks.push({ 
								name: 'Required File Types', 
								status: 'warning', 
								description: 'Some required file types missing',
								details: `${audioFiles.length} audio, ${imageFiles.length} images, ${csvFiles.length} CSV files`
							});
							totalIssues++;
						}
					} else {
						checks.push({ 
							name: 'Required File Types', 
							status: 'error', 
							description: 'Cannot check file types',
							details: 'Unable to access file listing'
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'Required File Types', 
						status: 'error', 
						description: 'File type check failed',
						details: e.message
					});
					totalIssues++;
				}
				
				// Check CORS configuration
				try {
					const corsRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-dev', { 
						method: 'OPTIONS',
						cache: 'no-cache' 
					});
					if (corsRes.ok) {
						checks.push({ 
							name: 'CORS Configuration', 
							status: 'valid', 
							description: 'CORS headers properly configured',
							details: 'CORS preflight requests successful'
						});
					} else {
						checks.push({ 
							name: 'CORS Configuration', 
							status: 'warning', 
							description: 'CORS configuration issues',
							details: `CORS preflight failed: ${corsRes.status}`
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'CORS Configuration', 
						status: 'warning', 
						description: 'CORS check failed',
						details: e.message
					});
					totalIssues++;
				}
				
				const errorCount = checks.filter(c => c.status === 'error').length;
				const warningCount = checks.filter(c => c.status === 'warning').length;
				const validCount = checks.filter(c => c.status === 'valid').length;
				
				if (totalIssues === 0) {
					summaryEl.innerHTML = `✅ <strong>All configurations</strong> are valid (${validCount} checks passed)`;
				} else {
					summaryEl.innerHTML = `⚠️ <strong>${totalIssues} issues</strong> found (${errorCount} errors, ${warningCount} warnings)`;
					detailsEl.style.display = 'inline';
					detailsEl.onclick = () => showConfigValidationDetails(checks);
				}
				
				validateBtn.style.display = 'inline-block';
				validateBtn.onclick = () => validateConfigValidation(checks);
				
				// Store for stoplight comparison
				window.configValidationDevIssues = totalIssues;
				window.configValidationDevDetails = checks;
				
			} catch (error) {
				summaryEl.textContent = `❌ Error: ${error.message}`;
			}
		}

		async function refreshConfigValidationAuditProd() {
			const summaryEl = document.getElementById('configValidationSummaryProd');
			const detailsEl = document.getElementById('configValidationDetailsProd');
			const validateBtn = document.getElementById('configValidationValidateBtnProd');
			
			try {
				summaryEl.textContent = 'Validating configuration...';
				
				// Check for actual configuration issues in prod environment
				const checks = [];
				let totalIssues = 0;
				
				// Check API endpoints availability
				try {
					const apiRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-prod', { cache: 'no-cache' });
					if (apiRes.ok) {
						checks.push({ 
							name: 'API Endpoints', 
							status: 'valid', 
							description: 'API endpoints are responding correctly',
							details: 'Prod API endpoints accessible'
						});
					} else {
						checks.push({ 
							name: 'API Endpoints', 
							status: 'error', 
							description: 'API endpoints not responding',
							details: `HTTP ${apiRes.status}: ${apiRes.statusText}`
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'API Endpoints', 
						status: 'error', 
						description: 'API endpoints unreachable',
						details: e.message
					});
					totalIssues++;
				}
				
				// Check GCS bucket access
				try {
					const bucketRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-prod', { cache: 'no-cache' });
					if (bucketRes.ok) {
						checks.push({ 
							name: 'GCS Bucket Access', 
							status: 'valid', 
							description: 'GCS bucket is accessible',
							details: 'levante-assets-prod bucket accessible'
						});
					} else {
						checks.push({ 
							name: 'GCS Bucket Access', 
							status: 'error', 
							description: 'GCS bucket not accessible',
							details: `HTTP ${bucketRes.status}: ${bucketRes.statusText}`
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'GCS Bucket Access', 
						status: 'error', 
						description: 'GCS bucket unreachable',
						details: e.message
					});
					totalIssues++;
				}
				
				// Check for required file types
				try {
					const filesRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-prod', { cache: 'no-cache' });
					if (filesRes.ok) {
						const filesData = await filesRes.json();
						const files = Array.isArray(filesData.files) ? filesData.files : [];
						
						const audioFiles = files.filter(f => f.toLowerCase().endsWith('.mp3'));
						const imageFiles = files.filter(f => f.toLowerCase().endsWith('.png') || f.toLowerCase().endsWith('.webp'));
						const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
						
						if (audioFiles.length > 0 && imageFiles.length > 0 && csvFiles.length > 0) {
							checks.push({ 
								name: 'Required File Types', 
								status: 'valid', 
								description: 'All required file types present',
								details: `${audioFiles.length} audio, ${imageFiles.length} images, ${csvFiles.length} CSV files`
							});
						} else {
							checks.push({ 
								name: 'Required File Types', 
								status: 'warning', 
								description: 'Some required file types missing',
								details: `${audioFiles.length} audio, ${imageFiles.length} images, ${csvFiles.length} CSV files`
							});
							totalIssues++;
						}
					} else {
						checks.push({ 
							name: 'Required File Types', 
							status: 'error', 
							description: 'Cannot check file types',
							details: 'Unable to access file listing'
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'Required File Types', 
						status: 'error', 
						description: 'File type check failed',
						details: e.message
					});
					totalIssues++;
				}
				
				// Check CORS configuration
				try {
					const corsRes = await fetch('/api/read-tags?list=1&bucket=levante-assets-prod', { 
						method: 'OPTIONS',
						cache: 'no-cache' 
					});
					if (corsRes.ok) {
						checks.push({ 
							name: 'CORS Configuration', 
							status: 'valid', 
							description: 'CORS headers properly configured',
							details: 'CORS preflight requests successful'
						});
					} else {
						checks.push({ 
							name: 'CORS Configuration', 
							status: 'warning', 
							description: 'CORS configuration issues',
							details: `CORS preflight failed: ${corsRes.status}`
						});
						totalIssues++;
					}
				} catch (e) {
					checks.push({ 
						name: 'CORS Configuration', 
						status: 'warning', 
						description: 'CORS check failed',
						details: e.message
					});
					totalIssues++;
				}
				
				const errorCount = checks.filter(c => c.status === 'error').length;
				const warningCount = checks.filter(c => c.status === 'warning').length;
				const validCount = checks.filter(c => c.status === 'valid').length;
				
				if (totalIssues === 0) {
					summaryEl.innerHTML = `✅ <strong>All configurations</strong> are valid (${validCount} checks passed)`;
				} else {
					summaryEl.innerHTML = `⚠️ <strong>${totalIssues} issues</strong> found (${errorCount} errors, ${warningCount} warnings)`;
					detailsEl.style.display = 'inline';
					detailsEl.onclick = () => showConfigValidationDetails(checks);
				}
				
				validateBtn.style.display = 'inline-block';
				validateBtn.onclick = () => validateConfigValidation(checks);
				
				// Store for stoplight comparison
				window.configValidationProdIssues = totalIssues;
				window.configValidationProdDetails = checks;
				
			} catch (error) {
				summaryEl.textContent = `❌ Error: ${error.message}`;
			}
		}

		function showConfigValidationDetails(checks) {
			const modal = document.getElementById('diffModal');
			const title = document.getElementById('diffModalTitle');
			const body = document.getElementById('diffModalBody');
			
			title.textContent = 'Configuration Validation Details';
			
			const errorCount = checks.filter(c => c.status === 'error').length;
			const warningCount = checks.filter(c => c.status === 'warning').length;
			const validCount = checks.filter(c => c.status === 'valid').length;
			
			body.innerHTML = `
				<div class="diff-section">
					<h4>Summary</h4>
					<p>Total checks: <strong>${checks.length}</strong></p>
					<p>Valid: <strong style="color: #059669;">${validCount}</strong> | Warnings: <strong style="color: #d97706;">${warningCount}</strong> | Errors: <strong style="color: #dc2626;">${errorCount}</strong></p>
				</div>
				<div class="diff-section">
					<h4>Configuration Status</h4>
					${checks.map(check => `
						<div style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 8px;">
							<div style="display: flex; align-items: center; gap: 8px;">
								<span style="width: 8px; height: 8px; border-radius: 50%; background: ${check.status === 'valid' ? '#059669' : check.status === 'warning' ? '#d97706' : '#dc2626'};"></span>
								<strong>${check.name}</strong>
								<span style="font-size: 12px; color: #6b7280;">(${check.status})</span>
							</div>
							<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
								${check.description}
							</div>
							${check.details ? `
								<div style="font-size: 11px; color: #374151; margin-top: 4px; padding: 4px; background: #f9fafb; border-radius: 2px; font-family: monospace;">
									<strong>Details:</strong> ${check.details}
								</div>
							` : ''}
						</div>
					`).join('')}
				</div>
				<div class="diff-section">
					<h4>Recommendation</h4>
					<p>Resolve configuration errors before deployment. Warnings can be addressed in future updates but should be monitored.</p>
					<ul style="margin-top: 8px; font-size: 12px; color: #6b7280;">
						<li>Ensure API endpoints are accessible and responding correctly</li>
						<li>Verify GCS bucket permissions and connectivity</li>
						<li>Check that all required file types are present in the bucket</li>
						<li>Validate CORS configuration for cross-origin requests</li>
					</ul>
				</div>
			`;
			
			modal.style.display = 'block';
		}

		function validateConfigValidation(checks) {
			const errorCount = checks.filter(c => c.status === 'error').length;
			const warningCount = checks.filter(c => c.status === 'warning').length;
			alert(`Configuration Validation:\n\nTotal checks: ${checks.length}\nValid: ${checks.filter(c => c.status === 'valid').length}\nWarnings: ${warningCount}\nErrors: ${errorCount}\n\nThis validation checks environment variables, API keys, database connections, and file permissions.`);
		}

		// Build table rows with bounded concurrency
		const tbody = document.querySelector('#reportTable tbody');
		for (const lang of languageCodes) {
			// Get data for both dev and prod environments
			const [devData, prodData] = await Promise.all([
				Promise.all([
					itembankStats(lang, 'dev'),
					dashboardStats(lang, 'dev'),
					surveyStats(lang, 'dev'),
					audioStats(lang, 'dev')
				]),
				Promise.all([
					itembankStats(lang, 'prod'),
					dashboardStats(lang, 'prod'),
					surveyStats(lang, 'prod'),
					audioStats(lang, 'prod')
				])
			]);
			
			const [devIb, devDs, devSv, devAu] = devData;
			const [prodIb, prodDs, prodSv, prodAu] = prodData;
			
			const tr = document.createElement('tr');
			tr.innerHTML = `
				<td>${languageDisplayName(lang)}</td>
				<td><span class="code">${lang}</span></td>
				<td>${badge(devIb.exact, devIb.total)} <span class="small">(${devIb.exact}/${devIb.total})</span></td>
				<td class="svcell">${devSv.checked === 0 ? '<span class="badge warn">n/a</span>' : badge(devSv.exact + devSv.withBase, devSv.checked)} <span class="small">(${devSv.exact}/${devSv.checked}, base ${devSv.withBase})</span></td>
				<td>${devDs.exactMatch ? '<span class="badge ok">yes</span>' : (devDs.baseMatch ? '<span class="badge warn">base</span>' : '<span class="badge err">missing</span>')}</td>
				<td>${devAu.present ? '<span class="badge ok">present</span>' : '<span class="badge err">missing</span>'}</td>
				<td>${badge(prodIb.exact, prodIb.total)} <span class="small">(${prodIb.exact}/${prodIb.total})</span></td>
				<td class="svcell">${prodSv.checked === 0 ? '<span class="badge warn">n/a</span>' : badge(prodSv.exact + prodSv.withBase, prodSv.checked)} <span class="small">(${prodSv.exact}/${prodSv.checked}, base ${prodSv.withBase})</span></td>
				<td>${prodDs.exactMatch ? '<span class="badge ok">yes</span>' : (prodDs.baseMatch ? '<span class="badge warn">base</span>' : '<span class="badge err">missing</span>')}</td>
				<td>${prodAu.present ? '<span class="badge ok">present</span>' : '<span class="badge err">missing</span>'}</td>
			`;
			const svCell = tr.querySelector('.svcell');
			if (svCell) {
				const infoBtn = document.createElement('button');
				infoBtn.title = 'Show survey details';
				infoBtn.setAttribute('aria-label', 'Show survey details');
				infoBtn.style.border = 'none';
				infoBtn.style.background = 'none';
				infoBtn.style.cursor = 'pointer';
				infoBtn.style.color = '#0d6efd';
				infoBtn.textContent = 'ℹ️';
				const details = devSv.details || [];
				infoBtn.addEventListener('click', () => {
					const ok = details.filter(x => x.hasExact || x.hasBase).map(x => x.file);
					const missing = details.filter(x => !x.hasExact && !x.hasBase).map(x => x.file);
					alert('Translated (or base):\n- ' + (ok.join('\n- ') || 'None') + '\n\nMissing:\n- ' + (missing.join('\n- ') || 'None'));
				});
				svCell.appendChild(infoBtn);
			}
			tbody.appendChild(tr);
		}

		await refreshVisualAudit();
		await refreshVisualAuditProd();
			await refreshAudioAudit();
			await refreshAudioAuditProd();
			await refreshCoreTasksAudit();
			await refreshCoreTasksAuditProd();
			await refreshCorpusAudit();
			await refreshCorpusAuditProd();
			await refreshTranslationCompletenessAudit();
			await refreshTranslationCompletenessAuditProd();
			await refreshAssetIntegrityAudit();
			await refreshAssetIntegrityAuditProd();
			await refreshConfigValidationAudit();
			await refreshConfigValidationAuditProd();
			
		// Update stoplight buttons after all audits complete
		updateStoplight('visualStoplight', window.visualDevMissing, window.visualProdMissing);
		updateStoplight('audioStoplight', window.audioDevLanguages, window.audioProdLanguages);
		updateStoplight('coreTasksStoplight', window.coreTasksDevCsvs, window.coreTasksProdCsvs);
		updateStoplight('corpusStoplight', window.corpusDevItemIds, window.corpusProdItemIds);
		updateStoplight('translationCompletenessStoplight', window.translationCompletenessDevMissing, window.translationCompletenessProdMissing);
		updateStoplight('assetIntegrityStoplight', window.assetIntegrityDevIssues, window.assetIntegrityProdIssues);
		updateStoplight('configValidationStoplight', window.configValidationDevIssues, window.configValidationProdIssues);

		const fixBtn = document.getElementById('visualFixBtn');
		if (fixBtn) {
			fixBtn.addEventListener('click', async () => {
				const prev = fixBtn.textContent;
				fixBtn.disabled = true; fixBtn.textContent = 'Fixing…';
				try {
					const res = await fetch(`/api/visual-fix?env=dev&prefix=visual/&limit=200`, { method: 'POST' });
					if (res.ok) {
						const data = await res.json();
						const top = Array.isArray(data.topReasons) && data.topReasons.length ? ('\nTop reasons: ' + data.topReasons.map(r=>`${r.reason} (${r.count})`).join(', ')) : '';
						alert(`WEBP created: ${data.created}\nFailed: ${data.failed}\nRemaining (est): ${data.remainingEstimate}${top}`);
						await refreshVisualAudit();
					} else {
						alert('Fix failed: API error');
					}
				} catch (e) {
					alert('Fix failed: ' + (e && e.message ? e.message : 'unknown error'));
				} finally {
					fixBtn.disabled = false; fixBtn.textContent = prev;
				}
			});
		}

		const fixBtnProd = document.getElementById('visualFixBtnProd');
		if (fixBtnProd) {
			fixBtnProd.addEventListener('click', async () => {
				const prev = fixBtnProd.textContent;
				fixBtnProd.disabled = true; fixBtnProd.textContent = 'Fixing…';
				try {
					const res = await fetch(`/api/visual-fix?env=prod&prefix=visual/&limit=200`, { method: 'POST' });
					if (res.ok) {
						const data = await res.json();
						const top = Array.isArray(data.topReasons) && data.topReasons.length ? ('\nTop reasons: ' + data.topReasons.map(r=>`${r.reason} (${r.count})`).join(', ')) : '';
						alert(`(prod) WEBP created: ${data.created}\nFailed: ${data.failed}\nRemaining (est): ${data.remainingEstimate}${top}`);
						await refreshVisualAuditProd();
					} else {
						alert('Fix failed (prod): API error');
					}
				} catch (e) {
					alert('Fix failed (prod): ' + (e && e.message ? e.message : 'unknown error'));
				} finally {
					fixBtnProd.disabled = false; fixBtnProd.textContent = prev;
				}
			});
		}
		}
		
		// Initial load
		await loadReportData();
	})();
	</script>
</body>
</html>
