<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Assets Preflight Readiness Report</title>
	<link rel="icon" type="image/svg+xml" href="./favicon.svg">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<link rel="stylesheet" href="./styles.css">
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; color: #222; }
		h1 { font-size: 20px; margin-bottom: 16px; }
		.table { width: 100%; border-collapse: collapse; }
		.table th, .table td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 13px; text-align: left; }
		.table thead th { background: #f8fafc; position: sticky; top: 0; }
		.badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 12px; font-weight: 600; }
		.ok { background: #e7f7ec; color: #1f7a37; }
		.warn { background: #fff7e6; color: #8a6d1f; }
		.err { background: #fde7ea; color: #842029; }
		.small { color: #374151; font-size: 12px; font-weight: 500; }
		.code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; background: #f3f4f6; padding: 1px 4px; border-radius: 4px; }
		.footer { margin-top: 16px; font-size: 12px; color: #6b7280; }
		.section { margin-top: 20px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
		.link { color: #0d6efd; cursor: pointer; text-decoration: underline; }
	</style>
</head>
<body>
	<h1><i class="fas fa-clipboard-list"></i> Assets Preflight Readiness Report</h1>
	<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
		<label for="envSelect" class="small" style="font-weight: 600;">Environment:</label>
		<select id="envSelect" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white; font-size: 13px;">
			<option value="dev">Dev</option>
			<option value="prod">Prod</option>
		</select>
		<button id="refreshBtn" style="padding: 4px 12px; border: 1px solid #d1d5db; border-radius: 4px; background: #0d6efd; color: white; cursor: pointer; font-size: 13px;">🔄 Refresh</button>
	</div>
	
	<div class="section" id="translationsAuditSection">
		<h2 style="font-size:16px; margin:0 0 8px 0;">Translations Audit</h2>
	</div>
	
	<table class="table" id="reportTable" aria-label="Languages Preflight Readiness table">
		<thead>
			<tr>
				<th>Language</th>
				<th>Code</th>
				<th>From Crowdin</th>
				<th>Surveys</th>
				<th>Dashboard</th>
				<th>Audio</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

	<div class="section" id="visualAuditsSection">
		<h2 style="font-size:16px; margin:0 0 8px 0;">Visual Assets Audit</h2>
		<div id="visualPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="visualAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="visualBucket" class="code"></span> · Prefix: <span id="visualPrefix" class="code">visual/</span></p>
				<p id="visualSummary" class="small">Loading…</p>
				<p class="small"><span id="visualDetails" class="link" style="display:none; margin-right:12px;">Show missing PNG → WEBP list</span><button id="visualFixBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Fix It</button></p>
			</div>
			<div id="visualAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="visualBucketProd" class="code"></span> · Prefix: <span id="visualPrefixProd" class="code">visual/</span></p>
				<p id="visualSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="visualDetailsProd" class="link" style="display:none; margin-right:12px;">Show missing PNG → WEBP list</span><button id="visualFixBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Fix It</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="audioAuditsSection">
		<h2 style="font-size:16px; margin:0 0 8px 0;">Audio Assets Audit</h2>
		<div id="audioPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="audioAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="audioBucket" class="code"></span> · Prefix: <span id="audioPrefix" class="code">audio/</span></p>
				<p id="audioSummary" class="small">Loading…</p>
				<p class="small"><span id="audioDetails" class="link" style="display:none; margin-right:12px;">Show audio coverage details</span><button id="audioCoverageBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">View Coverage</button></p>
			</div>
			<div id="audioAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="audioBucketProd" class="code"></span> · Prefix: <span id="audioPrefixProd" class="code">audio/</span></p>
				<p id="audioSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="audioDetailsProd" class="link" style="display:none; margin-right:12px;">Show audio coverage details</span><button id="audioCoverageBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">View Coverage</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="coreTasksAuditsSection">
		<h2 style="font-size:16px; margin:0 0 8px 0;">Core Tasks Audit</h2>
		<div id="coreTasksPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="coreTasksAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="coreTasksBucket" class="code"></span> · Prefix: <span id="coreTasksPrefix" class="code">corpus/</span></p>
				<p id="coreTasksSummary" class="small">Loading…</p>
				<p class="small"><span id="coreTasksDetails" class="link" style="display:none; margin-right:12px;">Show corpus details</span><button id="coreTasksValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="coreTasksAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="coreTasksBucketProd" class="code"></span> · Prefix: <span id="coreTasksPrefixProd" class="code">corpus/</span></p>
				<p id="coreTasksSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="coreTasksDetailsProd" class="link" style="display:none; margin-right:12px;">Show corpus details</span><button id="coreTasksValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<div class="section" id="coreAssetsAuditsSection">
		<h2 style="font-size:16px; margin:0 0 8px 0;">Core Assets Audit</h2>
		<div id="coreAssetsPanels" style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
			<div id="coreAssetsAudit" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Dev</h3>
				<p class="small">Bucket: <span id="coreAssetsBucket" class="code"></span> · Prefix: <span id="coreAssetsPrefix" class="code">core-assets/</span></p>
				<p id="coreAssetsSummary" class="small">Loading…</p>
				<p class="small"><span id="coreAssetsDetails" class="link" style="display:none; margin-right:12px;">Show core-assets details</span><button id="coreAssetsValidateBtn" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
			<div id="coreAssetsAuditProd" style="flex:1; min-width:280px;">
				<h3 style="font-size:14px; margin:0 0 6px 0; color:#374151;">Prod</h3>
				<p class="small">Bucket: <span id="coreAssetsBucketProd" class="code"></span> · Prefix: <span id="coreAssetsPrefixProd" class="code">core-assets/</span></p>
				<p id="coreAssetsSummaryProd" class="small">Loading…</p>
				<p class="small"><span id="coreAssetsDetailsProd" class="link" style="display:none; margin-right:12px;">Show core-assets details</span><button id="coreAssetsValidateBtnProd" style="display:none; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#0d6efd; color:white; cursor:pointer;">Validate</button></p>
			</div>
		</div>
	</div>

	<div class="footer">
		Color legend: <span class="badge ok">100%</span> <span class="badge warn">&gt; 0%</span> <span class="badge err">0%</span>
		<div class="small" style="margin-top:6px;">
			- <span class="badge ok">yes</span>: exact locale file exists in levante-dashboard (e.g., de-CH)
			- <span class="badge warn">base</span>: only base language file exists (e.g., de)
			- <span class="badge err">missing</span>: neither exact nor base locale file exists
			- Surveys %: percentage of survey JSONs that include the locale (or base for fallback; English counts implicit defaults)
			- From Crowdin: coverage of Item Bank CSV translations
		</div>
	</div>

	<script>
	(async function() {
		// Environment handling
		let env = 'dev';
		
		// Initialize from URL parameters
		const urlParams = new URLSearchParams(window.location.search);
		const urlEnv = urlParams.get('env');
		if (urlEnv === 'prod' || urlEnv === 'dev') {
			env = urlEnv.toLowerCase();
		}
		
		// Set up environment selector
		const envSelect = document.getElementById('envSelect');
		const refreshBtn = document.getElementById('refreshBtn');
		
		envSelect.value = env;
		
		// Environment change handler
		envSelect.addEventListener('change', () => {
			env = envSelect.value;
			refreshReport();
		});
		
		// Refresh button handler
		refreshBtn.addEventListener('click', () => {
			refreshReport();
		});
		
		// Function to refresh the entire report
		async function refreshReport() {
			// Clear existing content
			document.querySelector('#reportTable tbody').innerHTML = '';
			document.getElementById('visualSummary').textContent = 'Loading…';
			document.getElementById('visualSummaryProd').textContent = 'Loading…';
			document.getElementById('audioSummary').textContent = 'Loading…';
			document.getElementById('audioSummaryProd').textContent = 'Loading…';
			document.getElementById('coreTasksSummary').textContent = 'Loading…';
			document.getElementById('coreTasksSummaryProd').textContent = 'Loading…';
			document.getElementById('coreAssetsSummary').textContent = 'Loading…';
			document.getElementById('coreAssetsSummaryProd').textContent = 'Loading…';
			
			// Reload all data
			await loadReportData();
		}
		
		// Main data loading function
		async function loadReportData() {

		// Load dashboard config and CSV data
		const cfg = await fetch('./config.js').then(r => r.text()).then(js => { const m = {}; const f = new Function('module', js + '; return module.exports;'); return f(m); }).catch(() => ({}));
		const CONFIG = (cfg && cfg.CONFIG) || (window.CONFIG || {});
		let csvText = '';
		// Prefer remote CSV first
		const primaryUrl = (CONFIG && CONFIG.dataSources && CONFIG.dataSources.remoteCSV) || 'https://raw.githubusercontent.com/levante-framework/levante_translations/l10n_pending/item-bank-translations.csv';
		try {
			const resRemote = await fetch(primaryUrl, { cache: 'no-cache' });
			if (resRemote.ok) csvText = await resRemote.text();
		} catch (e) {}
		// Fallback to local complete CSV
		if (!csvText) {
			try {
				const res = await fetch('./translation_text/complete_translations.csv', { cache: 'no-cache' });
				if (res.ok) csvText = await res.text();
			} catch (e) {}
		}

		function parseCSVWithEmbeddedNewlines(csvText) {
			const rows = []; let currentRow = []; let currentField = ''; let inQuotes = false; let i = 0;
			while (i < csvText.length) {
				const ch = csvText[i]; const next = i + 1 < csvText.length ? csvText[i + 1] : '';
				if (ch === '"') { if (inQuotes && next === '"') { currentField += '"'; i += 2; } else { inQuotes = !inQuotes; i++; } }
				else if (ch === ',' && !inQuotes) { currentRow.push(currentField.trim()); currentField = ''; i++; }
				else if ((ch === '\n' || ch === '\r') && !inQuotes) { if (currentField.trim() || currentRow.length > 0) { currentRow.push(currentField.trim()); if (currentRow.some(f => f.length > 0)) rows.push(currentRow); currentRow = []; currentField = ''; } if (ch === '\r' && next === '\n') i += 2; else i++; }
				else { currentField += ch; i++; }
			}
			if (currentField.trim() || currentRow.length > 0) { currentRow.push(currentField.trim()); if (currentRow.some(f => f.length > 0)) rows.push(currentRow); }
			return rows.filter(r => r.length > 0 && r.some(f => f && f.trim().length > 0));
		}
		function csvToObjects(csvText) {
			const rows = parseCSVWithEmbeddedNewlines(csvText); if (rows.length === 0) return [];
			const headers = rows[0]; const data = [];
			for (let i = 1; i < rows.length; i++) { const row = rows[i]; if (row.length < headers.length) continue; const obj = {}; headers.forEach((h, idx) => obj[h] = (row[idx] || '').trim()); data.push(obj); }
			return data;
		}
		const items = csvToObjects(csvText);
		// Discover languages from header
		const headers = (parseCSVWithEmbeddedNewlines(csvText)[0] || []);
		const knownNonLang = new Set(['item_id','identifier','labels','task','context','en']);
		const languageCodes = headers.filter(h => !knownNonLang.has(h) && /^[a-z]{2}(-[A-Z]{2})?$/.test(h));
		if (!languageCodes.includes('en')) languageCodes.unshift('en');

		function toBase(lang) { return lang.includes('-') ? lang.split('-')[0] : lang; }
		function pct(n, d) { return d ? Math.round((n / d) * 10000)/100 : 0; }
		function badge(n, d) {
			const p = pct(n, d);
			const cls = p === 100 ? 'ok' : (p > 0 ? 'warn' : 'err');
			return `<span class="badge ${cls}">${p}%</span>`;
		}
		function capitalize(s) { return (s && s.length) ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
		function languageDisplayName(code) {
			// Prefer CONFIG mapping, but append region if code includes one and name doesn't already include it
			const match = Object.entries(CONFIG.languages || {}).find(([name, cfg]) => cfg.lang_code === code);
			const parts = code.split('-');
			const langPart = parts[0];
			const regionPart = parts[1];
			if (match) {
				const [fallbackName, cfg] = match;
				const baseName = cfg.display_name || fallbackName;
				if (regionPart) {
					if (baseName.includes('(')) return baseName; // already includes region
					try {
						const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
						const regionName = regionNames.of(regionPart.toUpperCase()) || regionPart.toUpperCase();
						return `${baseName} (${regionName})`;
					} catch (e) {
						return `${baseName} (${regionPart.toUpperCase()})`;
					}
				}
				return baseName;
			}
			// Fallback via Intl
			try {
				const langNames = new Intl.DisplayNames(['en'], { type: 'language' });
				const languageName = langNames.of(langPart) || langPart;
				if (regionPart) {
					const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
					const regionName = regionNames.of(regionPart.toUpperCase()) || regionPart.toUpperCase();
					return `${capitalize(languageName)} (${regionName})`;
				}
				return capitalize(languageName);
			} catch (e) {
				return regionPart ? `${langPart} (${regionPart.toUpperCase()})` : langPart;
			}
		}

		// ItemBank readiness per language
		function itembankStats(lang) {
			const exact = items.filter(r => (r[lang] || '').trim().length > 0).length;
			const base = toBase(lang);
			const withBase = items.filter(r => ((r[lang] || r[base] || '').trim().length > 0)).length;
			return { total: items.length, exact, withBase };
		}

		// Dashboard translations: fetch from levante-dashboard repo JSONs (componentTranslations)
		async function fetchDashboardJsonPath(code) {
			const lower = code.toLowerCase();
			const parts = lower.split('-');
			if (parts.length === 2) {
				return `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/${parts[0]}/${parts[1]}/${lower}-componentTranslations.json`;
			}
			// Special handling for 'en' - try both en and en-US paths
			if (lower === 'en') {
				// First try the standard path
				const standardPath = `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/${lower}/${lower}-componentTranslations.json`;
				// Also try en-US as fallback
				const enUSPath = `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/en/us/en-US-componentTranslations.json`;
				return standardPath; // We'll handle the fallback in the calling function
			}
			return `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/${lower}/${lower}-componentTranslations.json`;
		}
		async function fetchDashboardJson(code) {
			const url = await fetchDashboardJsonPath(code);
			try { const r = await fetch(url, { cache: 'no-cache' }); if (r.ok) return await r.json(); } catch (e) {}
			return null;
		}
		function countLeafStrings(obj) {
			if (!obj || typeof obj !== 'object') return 0;
			let count = 0;
			for (const k of Object.keys(obj)) {
				const v = obj[k];
				if (v && typeof v === 'object') count += countLeafStrings(v);
				else if (typeof v === 'string') count += 1;
			}
			return count;
		}
		async function dashboardStats(lang) {
			const exactUrl = await fetchDashboardJsonPath(lang);
			let exactMatch = false;
			let baseMatch = false;
			try { const r = await fetch(exactUrl, { method: 'HEAD', cache: 'no-cache' }); if (r.ok) exactMatch = true; } catch (e) {}
			
			// Special handling for 'en' - try en-US fallback
			if (!exactMatch && lang === 'en') {
				const enUSUrl = `https://raw.githubusercontent.com/levante-framework/levante-dashboard/main/src/translations/en/us/en-US-componentTranslations.json`;
				try { const r = await fetch(enUSUrl, { method: 'HEAD', cache: 'no-cache' }); if (r.ok) baseMatch = true; } catch (e) {}
			}
			
			if (!exactMatch && !baseMatch && lang.includes('-')) {
				const baseUrl = await fetchDashboardJsonPath(toBase(lang));
				try { const r2 = await fetch(baseUrl, { method: 'HEAD', cache: 'no-cache' }); if (r2.ok) baseMatch = true; } catch (e) {}
			}
			return { exactMatch, baseMatch };
		}

		// Survey translations: list JSONs from levante-dashboard-dev and check for keys
		async function surveyStats(lang) {
			try {
				// Static list based on known files in bucket (as exposed in repo), adjust if endpoint exists later
				const candidates = ['child_survey.json','parent_survey_child.json','parent_survey_family.json','teacher_survey_classroom.json','teacher_survey_general.json'];
				const base = toBase(lang);
				let checked = 0, exact = 0, withBase = 0;
				const details = [];
				for (const name of candidates) {
					try {
						const url = `https://storage.googleapis.com/levante-dashboard-dev/${name}`;
						const res = await fetch(url, { cache: 'no-cache' });
						if (!res.ok) continue;
						const txt = await res.text();
						checked++;
						let hasExact = txt.includes(`"${lang}"`) || txt.includes(`'${lang}'`);
						let hasBase = !hasExact && (txt.includes(`"${base}"`) || txt.includes(`'${base}'`));
						// Treat implicit English as coverage when no explicit locale keys are present
						// - exact for 'en'
						// - base for any 'en-*' variant
						if (!hasExact && !hasBase && base === 'en') {
							if (lang === 'en') { hasExact = true; } else { hasBase = true; }
						}
						if (hasExact) exact++; if (hasBase) withBase++;
						details.push({ file: name, hasExact, hasBase });
					} catch {}
				}
				return { checked, exact, withBase, details };
			} catch { return { checked: 0, exact: 0, withBase: 0, details: [] }; }
		}

		// Audio presence: ping api/read-tags in strict mode for a subset, but here aggregate presence by listing top-level prefixes from bucket via API list=1
		async function audioStats(lang) {
			try {
				const res = await fetch('/api/read-tags?list=1', { cache: 'no-cache' });
				if (!res.ok) return { present: false };
				const data = await res.json();
				const present = Array.isArray(data.languages) && data.languages.includes(lang);
				return { present };
			} catch { return { present: false }; }
		}

		// Build table rows with bounded concurrency
		const tbody = document.querySelector('#reportTable tbody');
		for (const lang of languageCodes) {
			const ib = itembankStats(lang);
			const ds = await dashboardStats(lang);
			const [sv, au] = await Promise.all([surveyStats(lang), audioStats(lang)]);
			const tr = document.createElement('tr');
			tr.innerHTML = `
				<td>${languageDisplayName(lang)}</td>
				<td><span class="code">${lang}</span></td>
				<td>${badge(ib.exact, ib.total)} <span class="small">(${ib.exact}/${ib.total})</span></td>
				<td class="svcell">${sv.checked === 0 ? '<span class="badge warn">n/a</span>' : badge(sv.exact + sv.withBase, sv.checked)} <span class="small">(${sv.exact}/${sv.checked}, base ${sv.withBase})</span></td>
				<td>${ds.exactMatch ? '<span class="badge ok">yes</span>' : (ds.baseMatch ? '<span class="badge warn">base</span>' : '<span class="badge err">missing</span>')}</td>
				<td>${au.present ? '<span class="badge ok">present</span>' : '<span class="badge err">missing</span>'}</td>
			`;
			const svCell = tr.querySelector('.svcell');
			if (svCell) {
				const infoBtn = document.createElement('button');
				infoBtn.title = 'Show survey details';
				infoBtn.setAttribute('aria-label', 'Show survey details');
				infoBtn.style.border = 'none';
				infoBtn.style.background = 'none';
				infoBtn.style.cursor = 'pointer';
				infoBtn.style.color = '#0d6efd';
				infoBtn.textContent = 'ℹ️';
				const details = sv.details || [];
				infoBtn.addEventListener('click', () => {
					const ok = details.filter(x => x.hasExact || x.hasBase).map(x => x.file);
					const missing = details.filter(x => !x.hasExact && !x.hasBase).map(x => x.file);
					alert('Translated (or base):\n- ' + (ok.join('\n- ') || 'None') + '\n\nMissing:\n- ' + (missing.join('\n- ') || 'None'));
				});
				svCell.appendChild(infoBtn);
			}
			tbody.appendChild(tr);
		}

		// Visual assets audit (env-selected) + Fix It
		async function refreshVisualAudit() {
			try {
				const res = await fetch(`/api/visual-audit?env=${encodeURIComponent(env)}&prefix=visual/`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('visualSummary').textContent = 'Visual audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('visualBucket').textContent = data.bucket || '';
				const missing = Array.isArray(data.missing) ? data.missing : [];
				const pngCount = data.pngCount || 0;
				const webpCount = data.webpCount || 0;
				const missingCount = data.missingCount || missing.length;
				const summary = document.getElementById('visualSummary');
				summary.innerHTML = `PNGs: <span class="code">${pngCount}</span> · WEBPs: <span class="code">${webpCount}</span> · Missing WEBP: <span class="badge ${missingCount===0?'ok':'err'}">${missingCount}</span>`;
				const detailsLink = document.getElementById('visualDetails');
				const fixBtn = document.getElementById('visualFixBtn');
				if (missingCount > 0) {
					detailsLink.style.display = '';
					fixBtn.style.display = '';
					detailsLink.onclick = () => { alert('PNGs without WEBP (first 200 shown):\n- ' + missing.slice(0,200).join('\n- ')); };
				} else {
					detailsLink.style.display = 'none';
					fixBtn.style.display = 'none';
				}
			} catch (e) {
				document.getElementById('visualSummary').textContent = 'Visual audit unavailable';
			}
		}

		// Visual assets audit (prod) + Fix It
		async function refreshVisualAuditProd() {
			try {
				const res = await fetch(`/api/visual-audit?env=prod&prefix=visual/`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('visualSummaryProd'); if (el) el.textContent = 'Visual audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('visualBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || '';
				const missing = Array.isArray(data.missing) ? data.missing : [];
				const pngCount = data.pngCount || 0;
				const webpCount = data.webpCount || 0;
				const missingCount = data.missingCount || missing.length;
				const summary = document.getElementById('visualSummaryProd');
				if (summary) summary.innerHTML = `PNGs: <span class=\"code\">${pngCount}</span> · WEBPs: <span class=\"code\">${webpCount}</span> · Missing WEBP: <span class=\"badge ${missingCount===0?'ok':'err'}\">${missingCount}</span>`;
				const detailsLink = document.getElementById('visualDetailsProd');
				const fixBtn = document.getElementById('visualFixBtnProd');
				if (missingCount > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (fixBtn) fixBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { alert('PNGs without WEBP (first 200 shown):\n- ' + missing.slice(0,200).join('\n- ')); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (fixBtn) fixBtn.style.display = 'none';
				}
			} catch (e) {
				const el = document.getElementById('visualSummaryProd'); if (el) el.textContent = 'Visual audit (prod) unavailable';
			}
		}

		// Audio assets audit (dev) + View Coverage
		async function refreshAudioAudit() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-dev`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('audioSummary').textContent = 'Audio audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('audioBucket').textContent = data.bucket || 'levante-assets-dev';
				const languages = Array.isArray(data.languages) ? data.languages : [];
				const totalLanguages = languages.length;
				const summary = document.getElementById('audioSummary');
				summary.innerHTML = `Languages: <span class="code">${totalLanguages}</span> · Available: <span class="badge ${totalLanguages > 0 ? 'ok' : 'err'}">${totalLanguages}</span>`;
				const detailsLink = document.getElementById('audioDetails');
				const coverageBtn = document.getElementById('audioCoverageBtn');
				if (totalLanguages > 0) {
					detailsLink.style.display = '';
					coverageBtn.style.display = '';
					detailsLink.onclick = () => { alert('Available languages:\n- ' + languages.join('\n- ')); };
					coverageBtn.onclick = () => { window.open('./audio-coverage.html?env=dev', '_blank'); };
				} else {
					detailsLink.style.display = 'none';
					coverageBtn.style.display = 'none';
				}
			} catch (e) {
				document.getElementById('audioSummary').textContent = 'Audio audit unavailable';
			}
		}

		// Audio assets audit (prod) + View Coverage
		async function refreshAudioAuditProd() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-prod`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('audioSummaryProd'); if (el) el.textContent = 'Audio audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('audioBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || 'levante-assets-prod';
				const languages = Array.isArray(data.languages) ? data.languages : [];
				const totalLanguages = languages.length;
				const summary = document.getElementById('audioSummaryProd');
				if (summary) summary.innerHTML = `Languages: <span class="code">${totalLanguages}</span> · Available: <span class="badge ${totalLanguages > 0 ? 'ok' : 'err'}">${totalLanguages}</span>`;
				const detailsLink = document.getElementById('audioDetailsProd');
				const coverageBtn = document.getElementById('audioCoverageBtnProd');
				if (totalLanguages > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (coverageBtn) coverageBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { alert('Available languages:\n- ' + languages.join('\n- ')); };
					if (coverageBtn) coverageBtn.onclick = () => { window.open('./audio-coverage.html?env=prod', '_blank'); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (coverageBtn) coverageBtn.style.display = 'none';
				}
			} catch (e) {
				const el = document.getElementById('audioSummaryProd'); if (el) el.textContent = 'Audio audit (prod) unavailable';
			}
		}

		// Core Tasks audit (dev) + Validate
		async function refreshCoreTasksAudit() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-dev&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('coreTasksSummary').textContent = 'Core tasks audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('coreTasksBucket').textContent = data.bucket || 'levante-assets-dev';
				const files = Array.isArray(data.files) ? data.files : [];
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				const totalFiles = files.length;
				const csvCount = csvFiles.length;
				const summary = document.getElementById('coreTasksSummary');
				summary.innerHTML = `Files: <span class="code">${totalFiles}</span> · CSVs: <span class="code">${csvCount}</span> · Status: <span class="badge ${csvCount > 0 ? 'ok' : 'err'}">${csvCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('coreTasksDetails');
				const validateBtn = document.getElementById('coreTasksValidateBtn');
				if (totalFiles > 0) {
					detailsLink.style.display = '';
					validateBtn.style.display = '';
					detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more files` : '';
						alert(`Corpus files (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					validateBtn.onclick = () => { validateCoreTasks('dev'); };
				} else {
					detailsLink.style.display = 'none';
					validateBtn.style.display = 'none';
				}
			} catch (e) {
				document.getElementById('coreTasksSummary').textContent = 'Core tasks audit unavailable';
			}
		}

		// Core Tasks audit (prod) + Validate
		async function refreshCoreTasksAuditProd() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-prod&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('coreTasksSummaryProd'); if (el) el.textContent = 'Core tasks audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('coreTasksBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || 'levante-assets-prod';
				const files = Array.isArray(data.files) ? data.files : [];
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				const totalFiles = files.length;
				const csvCount = csvFiles.length;
				const summary = document.getElementById('coreTasksSummaryProd');
				if (summary) summary.innerHTML = `Files: <span class="code">${totalFiles}</span> · CSVs: <span class="code">${csvCount}</span> · Status: <span class="badge ${csvCount > 0 ? 'ok' : 'err'}">${csvCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('coreTasksDetailsProd');
				const validateBtn = document.getElementById('coreTasksValidateBtnProd');
				if (totalFiles > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (validateBtn) validateBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more files` : '';
						alert(`Corpus files (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					if (validateBtn) validateBtn.onclick = () => { validateCoreTasks('prod'); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (validateBtn) validateBtn.style.display = 'none';
				}
			} catch (e) {
				const el = document.getElementById('coreTasksSummaryProd'); if (el) el.textContent = 'Core tasks audit (prod) unavailable';
			}
		}

		// Validate Core Tasks CSV contents
		async function validateCoreTasks(environment) {
			try {
				const bucket = environment === 'prod' ? 'levante-assets-prod' : 'levante-assets-dev';
				
				// Get corpus files
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}&prefix=corpus/`, { cache: 'no-cache' });
				if (!res.ok) { alert(`Failed to fetch corpus files from ${bucket}`); return; }
				const data = await res.json();
				const files = Array.isArray(data.files) ? data.files : [];
				const csvFiles = files.filter(f => f.toLowerCase().endsWith('.csv'));
				
				if (csvFiles.length === 0) {
					alert(`No CSV files found in ${bucket}/corpus/`);
					return;
				}
				
				// Get current core tasks from item bank
				const currentItems = await getCurrentCoreTasks();
				
				// Validate each CSV
				let validationResults = [];
				for (const csvFile of csvFiles) {
					try {
						const csvUrl = `https://storage.googleapis.com/${bucket}/${csvFile}`;
						const csvRes = await fetch(csvUrl, { cache: 'no-cache' });
						if (!csvRes.ok) continue;
						
						const csvText = await csvRes.text();
						const csvData = parseCSVWithEmbeddedNewlines(csvText);
						
						if (csvData.length === 0) continue;
						
						const header = csvData[0].map(h => h.trim());
						const idIndex = header.findIndex(h => h.toLowerCase().includes('id') || h.toLowerCase().includes('item'));
						
						if (idIndex === -1) continue;
						
						const csvItems = new Set();
						for (let i = 1; i < csvData.length; i++) {
							const itemId = (csvData[i][idIndex] || '').toString().trim();
							if (itemId) csvItems.add(itemId);
						}
						
						// Compare with current items
						const missing = currentItems.filter(id => !csvItems.has(id));
						const extra = Array.from(csvItems).filter(id => !currentItems.includes(id));
						const matching = currentItems.filter(id => csvItems.has(id));
						
						validationResults.push({
							file: csvFile.split('/').pop(),
							total: csvItems.size,
							matching: matching.length,
							missing: missing.length,
							extra: extra.length,
							coverage: currentItems.length > 0 ? Math.round((matching.length / currentItems.length) * 100) : 0
						});
					} catch (e) {
						console.warn(`Failed to validate ${csvFile}:`, e);
					}
				}
				
				// Display results
				if (validationResults.length === 0) {
					alert(`No valid CSV files found in ${bucket}/corpus/`);
					return;
				}
				
				const resultsText = validationResults.map(r => 
					`${r.file}:\n` +
					`  Coverage: ${r.coverage}% (${r.matching}/${currentItems.length} items)\n` +
					`  Missing: ${r.missing} items\n` +
					`  Extra: ${r.extra} items\n` +
					`  Total in CSV: ${r.total}`
				).join('\n\n');
				
				alert(`Core Tasks Validation Results (${environment.toUpperCase()}):\n\nCurrent Items: ${currentItems.length}\n\n${resultsText}`);
				
			} catch (e) {
				alert(`Validation failed: ${e.message}`);
			}
		}
		
		// Get current core tasks from item bank
		async function getCurrentCoreTasks() {
			try {
				// Use the same CSV loading logic as the main report
				const csvUrl = (CONFIG && CONFIG.dataSources && CONFIG.dataSources.remoteCSV) || 'https://raw.githubusercontent.com/levante-framework/levante_translations/l10n_pending/item-bank-translations.csv';
				const res = await fetch(csvUrl, { cache: 'no-cache' });
				if (!res.ok) return [];
				
				const csvText = await res.text();
				const rows = parseCSVWithEmbeddedNewlines(csvText);
				if (rows.length === 0) return [];
				
				const header = rows[0].map(h => h.trim());
				const idIndex = header.findIndex(h => h.toLowerCase().includes('item_id') || h.toLowerCase().includes('identifier'));
				const taskIndex = header.findIndex(h => h.toLowerCase().includes('task') || h.toLowerCase().includes('label'));
				
				if (idIndex === -1) return [];
				
				const coreTasks = [];
				for (let i = 1; i < rows.length; i++) {
					const row = rows[i];
					const itemId = (row[idIndex] || '').toString().trim();
					const task = taskIndex >= 0 ? (row[taskIndex] || '').toString().trim().toLowerCase() : '';
					
					// Filter for core tasks (you may need to adjust this logic based on your data)
					if (itemId && (task.includes('core') || task.includes('task') || task === '')) {
						coreTasks.push(itemId);
					}
				}
				
				return coreTasks;
			} catch (e) {
				console.warn('Failed to load current core tasks:', e);
				return [];
			}
		}

		// Core Assets audit (dev) + Validate
		async function refreshCoreAssetsAudit() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-dev&prefix=core-assets/`, { cache: 'no-cache' });
				if (!res.ok) { document.getElementById('coreAssetsSummary').textContent = 'Core assets audit unavailable (API error)'; return; }
				const data = await res.json();
				document.getElementById('coreAssetsBucket').textContent = data.bucket || 'levante-assets-dev';
				const files = Array.isArray(data.files) ? data.files : [];
				const textFiles = files.filter(f => f.toLowerCase().endsWith('.txt') || f.toLowerCase().endsWith('.json'));
				const totalFiles = files.length;
				const textCount = textFiles.length;
				const summary = document.getElementById('coreAssetsSummary');
				summary.innerHTML = `Files: <span class="code">${totalFiles}</span> · Text/JSON: <span class="code">${textCount}</span> · Status: <span class="badge ${textCount > 0 ? 'ok' : 'err'}">${textCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('coreAssetsDetails');
				const validateBtn = document.getElementById('coreAssetsValidateBtn');
				if (totalFiles > 0) {
					detailsLink.style.display = '';
					validateBtn.style.display = '';
					detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more files` : '';
						alert(`Core assets files (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					validateBtn.onclick = () => { validateCoreAssets('dev'); };
				} else {
					detailsLink.style.display = 'none';
					validateBtn.style.display = 'none';
				}
			} catch (e) {
				document.getElementById('coreAssetsSummary').textContent = 'Core assets audit unavailable';
			}
		}

		// Core Assets audit (prod) + Validate
		async function refreshCoreAssetsAuditProd() {
			try {
				const res = await fetch(`/api/read-tags?list=1&bucket=levante-assets-prod&prefix=core-assets/`, { cache: 'no-cache' });
				if (!res.ok) { const el = document.getElementById('coreAssetsSummaryProd'); if (el) el.textContent = 'Core assets audit (prod) unavailable (API error)'; return; }
				const data = await res.json();
				const bucketEl = document.getElementById('coreAssetsBucketProd'); if (bucketEl) bucketEl.textContent = data.bucket || 'levante-assets-prod';
				const files = Array.isArray(data.files) ? data.files : [];
				const textFiles = files.filter(f => f.toLowerCase().endsWith('.txt') || f.toLowerCase().endsWith('.json'));
				const totalFiles = files.length;
				const textCount = textFiles.length;
				const summary = document.getElementById('coreAssetsSummaryProd');
				if (summary) summary.innerHTML = `Files: <span class="code">${totalFiles}</span> · Text/JSON: <span class="code">${textCount}</span> · Status: <span class="badge ${textCount > 0 ? 'ok' : 'err'}">${textCount > 0 ? 'Available' : 'Missing'}</span>`;
				const detailsLink = document.getElementById('coreAssetsDetailsProd');
				const validateBtn = document.getElementById('coreAssetsValidateBtnProd');
				if (totalFiles > 0) {
					if (detailsLink) detailsLink.style.display = '';
					if (validateBtn) validateBtn.style.display = '';
					if (detailsLink) detailsLink.onclick = () => { 
						const fileList = files.slice(0, 50).join('\n- ');
						const moreText = files.length > 50 ? `\n... and ${files.length - 50} more files` : '';
						alert(`Core assets files (${files.length} total):\n- ${fileList}${moreText}`); 
					};
					if (validateBtn) validateBtn.onclick = () => { validateCoreAssets('prod'); };
				} else {
					if (detailsLink) detailsLink.style.display = 'none';
					if (validateBtn) validateBtn.style.display = 'none';
				}
			} catch (e) {
				const el = document.getElementById('coreAssetsSummaryProd'); if (el) el.textContent = 'Core assets audit (prod) unavailable';
			}
		}

		// Validate Core Assets text content
		async function validateCoreAssets(environment) {
			try {
				const bucket = environment === 'prod' ? 'levante-assets-prod' : 'levante-assets-dev';
				
				// Get core-assets files
				const res = await fetch(`/api/read-tags?list=1&bucket=${bucket}&prefix=core-assets/`, { cache: 'no-cache' });
				if (!res.ok) { alert(`Failed to fetch core-assets files from ${bucket}`); return; }
				const data = await res.json();
				const files = Array.isArray(data.files) ? data.files : [];
				const textFiles = files.filter(f => f.toLowerCase().endsWith('.txt') || f.toLowerCase().endsWith('.json'));
				
				if (textFiles.length === 0) {
					alert(`No text/JSON files found in ${bucket}/core-assets/`);
					return;
				}
				
				// Analyze each text file
				let validationResults = [];
				for (const textFile of textFiles) {
					try {
						const fileUrl = `https://storage.googleapis.com/${bucket}/${textFile}`;
						const fileRes = await fetch(fileUrl, { cache: 'no-cache' });
						if (!fileRes.ok) continue;
						
						const fileText = await fileRes.text();
						const fileName = textFile.split('/').pop();
						
						// Basic text analysis
						const lines = fileText.split('\n').filter(line => line.trim().length > 0);
						const words = fileText.split(/\s+/).filter(word => word.trim().length > 0);
						const chars = fileText.length;
						
						// Check for translation indicators
						const hasTranslationKeys = /"[a-zA-Z_][a-zA-Z0-9_]*"\s*:/.test(fileText);
						const hasLanguageCodes = /[a-z]{2}(-[A-Z]{2})?/.test(fileText);
						const hasUnicode = /[\u0080-\uFFFF]/.test(fileText);
						
						validationResults.push({
							file: fileName,
							lines: lines.length,
							words: words.length,
							characters: chars,
							hasTranslationKeys,
							hasLanguageCodes,
							hasUnicode,
							fileType: fileName.toLowerCase().endsWith('.json') ? 'JSON' : 'TXT'
						});
					} catch (e) {
						console.warn(`Failed to validate ${textFile}:`, e);
					}
				}
				
				// Display results
				if (validationResults.length === 0) {
					alert(`No valid text/JSON files found in ${bucket}/core-assets/`);
					return;
				}
				
				const resultsText = validationResults.map(r => 
					`${r.file} (${r.fileType}):\n` +
					`  Lines: ${r.lines} · Words: ${r.words} · Characters: ${r.characters}\n` +
					`  Translation Keys: ${r.hasTranslationKeys ? 'Yes' : 'No'}\n` +
					`  Language Codes: ${r.hasLanguageCodes ? 'Yes' : 'No'}\n` +
					`  Unicode Content: ${r.hasUnicode ? 'Yes' : 'No'}`
				).join('\n\n');
				
				alert(`Core Assets Validation Results (${environment.toUpperCase()}):\n\n${resultsText}`);
				
			} catch (e) {
				alert(`Validation failed: ${e.message}`);
			}
		}

			await refreshVisualAudit();
			await refreshVisualAuditProd();
			await refreshAudioAudit();
			await refreshAudioAuditProd();
			await refreshCoreTasksAudit();
			await refreshCoreTasksAuditProd();
			await refreshCoreAssetsAudit();
			await refreshCoreAssetsAuditProd();

			const fixBtn = document.getElementById('visualFixBtn');
			if (fixBtn) {
				fixBtn.addEventListener('click', async () => {
					const prev = fixBtn.textContent;
					fixBtn.disabled = true; fixBtn.textContent = 'Fixing…';
					try {
						const res = await fetch(`/api/visual-fix?env=${encodeURIComponent(env)}&prefix=visual/&limit=200`, { method: 'POST' });
						if (res.ok) {
							const data = await res.json();
							const top = Array.isArray(data.topReasons) && data.topReasons.length ? ('\nTop reasons: ' + data.topReasons.map(r=>`${r.reason} (${r.count})`).join(', ')) : '';
							alert(`WEBP created: ${data.created}\nFailed: ${data.failed}\nRemaining (est): ${data.remainingEstimate}${top}`);
							await refreshVisualAudit();
						} else {
							alert('Fix failed: API error');
						}
					} catch (e) {
						alert('Fix failed: ' + (e && e.message ? e.message : 'unknown error'));
					} finally {
						fixBtn.disabled = false; fixBtn.textContent = prev;
					}
				});
			}

			const fixBtnProd = document.getElementById('visualFixBtnProd');
			if (fixBtnProd) {
				fixBtnProd.addEventListener('click', async () => {
					const prev = fixBtnProd.textContent;
					fixBtnProd.disabled = true; fixBtnProd.textContent = 'Fixing…';
					try {
						const res = await fetch(`/api/visual-fix?env=prod&prefix=visual/&limit=200`, { method: 'POST' });
						if (res.ok) {
							const data = await res.json();
							const top = Array.isArray(data.topReasons) && data.topReasons.length ? ('\nTop reasons: ' + data.topReasons.map(r=>`${r.reason} (${r.count})`).join(', ')) : '';
							alert(`(prod) WEBP created: ${data.created}\nFailed: ${data.failed}\nRemaining (est): ${data.remainingEstimate}${top}`);
							await refreshVisualAuditProd();
						} else {
							alert('Fix failed (prod): API error');
						}
					} catch (e) {
						alert('Fix failed (prod): ' + (e && e.message ? e.message : 'unknown error'));
					} finally {
						fixBtnProd.disabled = false; fixBtnProd.textContent = prev;
					}
				});
			}
		}
		
		// Initial load
		await loadReportData();
	})();
	</script>
</body>
</html>
