<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Review Alternative Audio Clips</title>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background:
                radial-gradient(circle at top, rgba(255, 150, 34, 0.18), rgba(15, 23, 42, 0.96)),
                linear-gradient(190deg, #020617 0%, #0b1220 100%);
            color: #e2e8f0;
            margin: 0;
            padding: 0;
        }

        .share-container {
            max-width: 1040px;
            margin: 0 auto;
            padding: 40px 20px 60px;
        }

        header {
            margin-bottom: 28px;
        }

        h1 {
            font-size: 2.3rem;
            margin: 0 0 10px;
            font-weight: 600;
            letter-spacing: 0.03em;
            color: #f8fafc;
        }

        .actions-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 14px;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .action-button {
            border: none;
            border-radius: 999px;
            padding: 10px 22px;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            white-space: nowrap;
        }

        .action-button:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            box-shadow: none;
        }

        .approve-button {
            background: linear-gradient(135deg, #ff6f00 0%, #ffb347 100%);
            color: #0b1220;
            box-shadow: 0 15px 35px rgba(255, 123, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .approve-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 22px 45px rgba(255, 123, 0, 0.45);
        }

        .delete-button {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.92) 0%, rgba(127, 29, 29, 0.95) 100%);
            color: #fef2f2;
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.32);
            border: 1px solid rgba(248, 113, 113, 0.4);
        }

        .delete-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 22px 45px rgba(239, 68, 68, 0.45);
        }

        .folder-info {
            font-size: 0.95rem;
            color: rgba(148, 198, 255, 0.75);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .status {
            border-radius: 16px;
            padding: 14px 20px;
            margin-bottom: 22px;
            font-size: 0.95rem;
            background: rgba(3, 12, 28, 0.85);
            color: #38bdf8;
            border: 1px solid rgba(56, 189, 248, 0.35);
            box-shadow: 0 18px 45px rgba(2, 6, 23, 0.45);
        }

        .status.error {
            background: rgba(76, 29, 36, 0.75);
            color: #fca5a5;
            border-color: rgba(248, 113, 113, 0.4);
        }

        .status.success {
            background: rgba(13, 148, 136, 0.22);
            color: #5eead4;
            border-color: rgba(45, 212, 191, 0.4);
        }

        .status.loading {
            background: rgba(120, 53, 15, 0.35);
            color: #fdba74;
            border-color: rgba(251, 191, 36, 0.35);
        }

        .share-content {
            background: rgba(4, 11, 24, 0.82);
            border-radius: 18px;
            box-shadow: 0 28px 70px rgba(2, 6, 23, 0.55);
            padding: 24px 28px;
            overflow-x: auto;
            border: 1px solid rgba(56, 189, 248, 0.25);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th, td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid rgba(56, 189, 248, 0.12);
        }

        th:first-child,
        td:first-child {
            text-align: center;
        }

        .file-select-checkbox,
        thead input[type="checkbox"] {
            transform: scale(1.15);
            cursor: pointer;
        }

        th {
            background: rgba(56, 189, 248, 0.12);
            font-weight: 600;
            color: #f8fafc;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.12);
        }

        code {
            background: rgba(15, 23, 42, 0.8);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #93c5fd;
        }

        .empty-state {
            padding: 36px 0;
            text-align: center;
            color: rgba(148, 163, 184, 0.75);
        }

        .download-link {
            color: #38bdf8;
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .download-link:hover {
            text-decoration: underline;
        }

        .site-approval-cell { text-align: center; }
.site-approval-pill,
.status-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            background: rgba(148, 163, 184, 0.18);
            color: rgba(203, 213, 225, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }
        .site-approval-pill.is-approved,
.status-pill.status-approved {
            background: rgba(250, 204, 21, 0.22);
            color: #fef08a;
            border-color: rgba(250, 204, 21, 0.4);
            box-shadow: 0 8px 18px rgba(250, 204, 21, 0.25);
        }
        .site-approval-pill.is-stale,
        .status-pill.status-stale {
            background: rgba(251, 191, 36, 0.22);
            color: #fde68a;
            border-color: rgba(251, 191, 36, 0.4);
            box-shadow: 0 8px 18px rgba(251, 191, 36, 0.25);
        }
        .status-pill.status-not-approved {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            border-color: rgba(239, 68, 68, 0.35);
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.25);
        }
        .status-pill.status-ready {
            background: rgba(34, 197, 94, 0.22);
            color: #bbf7d0;
            border-color: rgba(34, 197, 94, 0.38);
            box-shadow: 0 8px 18px rgba(34, 197, 94, 0.25);
        }

        audio {
            width: 240px;
            max-width: 100%;
            filter: saturate(1.2);
        }

        .approval-note {
            margin-top: 26px;
            font-size: 0.9rem;
            color: rgba(148, 163, 184, 0.85);
            letter-spacing: 0.04em;
            text-transform: none;
        }

        @media (max-width: 640px) {
            .share-container {
                padding: 28px 16px 36px;
            }

            .actions-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            h1 {
                font-size: 1.9rem;
            }

            th, td {
                padding: 10px;
            }

            audio {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="share-container">
        <header>
            <h1>Review Alternative Audio Clips</h1>
            <div class="actions-bar">
                <div id="folderInfo" class="folder-info">Preparing share view…</div>
                <div class="action-buttons">
                    <button id="deleteSelected" class="action-button delete-button" disabled>Delete Selected</button>
                    <button id="approveSelected" class="action-button approve-button" disabled>Approve Selected</button>
                </div>
            </div>
        </header>

        <div id="status" class="status loading">Loading draft audio…</div>

        <div id="content" class="share-content">
            <div class="empty-state">Fetching draft audio files…</div>
        </div>
        <p class="approval-note">By approving these updated translations you&apos;re agreeing that they are acceptable for your Levante Project site.</p>
    </div>

    <script>
        (function () {
            const statusEl = document.getElementById('status');
            const contentEl = document.getElementById('content');
            const folderInfoEl = document.getElementById('folderInfo');

            const params = new URLSearchParams(window.location.search);
            const modeParam = (params.get('mode') || '').toLowerCase();
            const isSiteMode = modeParam === 'site';
            const isAdminMode = !isSiteMode;

            const headingEl = document.querySelector('header h1');
            const noteEl = document.querySelector('.approval-note');
            if (headingEl) {
                headingEl.textContent = isSiteMode ? 'Review Alternative Audio Clips' : 'Promote Site-Approved Audio Clips';
            }
            if (noteEl) {
                noteEl.textContent = isSiteMode
                    ? 'By approving these updated translations you\'re agreeing that they are acceptable for your Levante Project site.'
                    : 'Mark site-approved clips that are ready for promotion; downstream scripts will copy flagged audio into the repo and levante-assets-dev.';
            }

            const approveButton = document.getElementById('approveSelected');
            const deleteButton = document.getElementById('deleteSelected');
            if (approveButton) {
                approveButton.textContent = isSiteMode ? 'Approve Selected' : 'Okay to Push';
            }
            if (deleteButton) {
                deleteButton.textContent = isSiteMode ? 'Delete Selected' : 'Remove Selected';
            }

            const selectedPaths = new Set();
            let deployQueue = {};

            function normalizePath(value) {
                return (value || '')
                    .replace(/\\/g, '/')
                    .split('/')
                    .filter(Boolean)
                    .join('/');
            }

            async function refreshQueue() {
                if (!isAdminMode) {
                    deployQueue = {};
                    return;
                }
                try {
                    const response = await fetch(`/api/flag-deploy-audio?bucket=${encodeURIComponent(bucket)}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    deployQueue = data && data.entries ? data.entries : {};
                } catch (error) {
                    console.warn('Failed to load deploy queue', error);
                    deployQueue = {};
                }
            }

            function updateActionButtons() {
                const count = selectedPaths.size;
                const disabled = count === 0;
                if (approveButton) {
                    const label = isSiteMode ? 'Approve' : 'Okay to Push';
                    approveButton.disabled = disabled;
                    approveButton.textContent = disabled ? `${label} Selected` : `${label} ${count} Selected`;
                }
                if (deleteButton) {
                    const label = isSiteMode ? 'Delete' : 'Remove';
                    deleteButton.disabled = disabled;
                    deleteButton.textContent = disabled ? `${label} Selected` : `${label} ${count} Selected`;
                }
            }

            function toggleSelection(path, checked) {
                if (!path) return;
                if (checked) {
                    selectedPaths.add(path);
                } else {
                    selectedPaths.delete(path);
                }
                const checkboxes = Array.from(document.querySelectorAll('.file-select-checkbox')).filter(cb => !cb.disabled);
                const master = document.querySelector('.master-select-checkbox');
                if (master && checkboxes.length) {
                    const checkedCount = checkboxes.filter(cb => cb.checked).length;
                    master.checked = checkedCount === checkboxes.length;
                }
                updateActionButtons();
            }

            async function approveSelectedFiles() {
                if (selectedPaths.size === 0) return;

                if (isSiteMode) {
                    const confirmMessage = 'Let the Levante Partner group know that you approve this new version of the selected audio clips.';
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }

                const selectionCount = selectedPaths.size;

                try {
                    setStatus(isSiteMode ? 'Approving selected files…' : 'Flagging selected files…', 'loading');
                    if (approveButton) {
                        approveButton.disabled = true;
                        approveButton.textContent = isSiteMode ? 'Approving…' : 'Flagging…';
                    }
                    if (deleteButton) {
                        deleteButton.disabled = true;
                    }

                    const files = Array.from(selectedPaths).map(path => ({ bucket, path }));
                    let finalMessage = '';
                    let finalType = 'success';

                    if (isSiteMode) {
                        const response = await fetch('/api/site-approve-audio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files })
                        });

                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || `HTTP ${response.status}`);
                        }

                        const result = await response.json();
                        const resultsArray = Array.isArray(result.results) ? result.results : [];
                        const deployedEntries = resultsArray.filter(entry => entry.status === 'deployed');
                        const errorEntries = resultsArray.filter(entry => entry.status === 'error');
                        const skippedEntries = resultsArray.filter(entry => entry.status === 'skipped');

                        let approvedCount = deployedEntries.length;
                        if (approvedCount === 0) {
                            const fallbackCount = Number(result.deployed);
                            approvedCount = Number.isFinite(fallbackCount) && fallbackCount > 0 ? fallbackCount : selectionCount;
                        }

                        if (approvedCount > 0) {
                            finalMessage = `Let the Levante Partner group know you approve ${approvedCount} file${approvedCount === 1 ? '' : 's'}.`;
                            finalType = 'success';
                        } else {
                            finalMessage = 'No files were approved — please verify the selection or retry.';
                            finalType = 'warning';
                        }

                        if (errorEntries.length || skippedEntries.length) {
                            console.warn('Some files could not be moved to deploy', { errorEntries, skippedEntries });
                        }
                    } else {
                        const response = await fetch('/api/flag-deploy-audio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files })
                        });

                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || `HTTP ${response.status}`);
                        }

                        const result = await response.json();
                        const processed = Number(result.flagged || 0);
                        if (processed > 0) {
                            finalMessage = `Marked ${processed} file${processed === 1 ? '' : 's'} as ready to push.`;
                            finalType = 'success';
                        } else {
                            finalMessage = 'No files were marked as ready — please verify the selection.';
                            finalType = 'warning';
                        }
                    }

                    selectedPaths.clear();
                    document.querySelectorAll('.file-select-checkbox').forEach(cb => { cb.checked = false; });
                    const master = document.querySelector('.master-select-checkbox');
                    if (master) master.checked = false;
                    await loadFiles();
                    if (finalMessage) {
                        setStatus(finalMessage, finalType);
                    }
                } catch (error) {
                    console.error('Approve/Flag failed', error);
                    const failureText = isSiteMode
                        ? `Failed to approve files: ${error.message}`
                        : `Failed to mark files as ready: ${error.message}`;
                    setStatus(failureText, 'error');
                } finally {
                    updateActionButtons();
                }
            }

            async function deleteSelectedFiles() {
                if (selectedPaths.size === 0) return;
                const confirmMessage = isSiteMode
                    ? `Delete ${selectedPaths.size} selected file${selectedPaths.size === 1 ? '' : 's'} from ${bucket}? This cannot be undone.`
                    : `Remove ${selectedPaths.size} selected file${selectedPaths.size === 1 ? '' : 's'} from deploy?`;
                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    setStatus(isSiteMode ? 'Deleting selected files…' : 'Removing selected files…', 'loading');
                    if (deleteButton) {
                        deleteButton.disabled = true;
                        deleteButton.textContent = isSiteMode ? 'Deleting…' : 'Removing…';
                    }
                    if (approveButton) {
                        approveButton.disabled = true;
                    }

                    const files = Array.from(selectedPaths).map(path => ({ bucket, path }));
                    const response = await fetch('/api/delete-draft-audio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files })
                    });

                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(text || `HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    const resultsArray = Array.isArray(result.results) ? result.results : [];
                    const deletedEntries = resultsArray.filter(entry => entry.status === 'deleted');
                    const missingEntries = resultsArray.filter(entry => entry.status === 'missing');
                    const errorEntries = resultsArray.filter(entry => entry.status === 'error');
                    const deletedCount = deletedEntries.length || Number(result.deleted || 0);
                    const plural = (count) => (count === 1 ? '' : 's');

                    if (!isSiteMode && files.length) {
                        try {
                            await fetch('/api/flag-deploy-audio', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ files, action: 'clear' })
                            });
                        } catch (flagError) {
                            console.warn('Failed to clear deploy queue entries', flagError);
                        }
                    }

                    if (missingEntries.length) {
                        console.info('Remove Selected: some files were already missing', { missingEntries });
                    }
                    if (errorEntries.length) {
                        console.warn('Remove Selected: failed to remove some files', { errorEntries });
                    }

                    const labelPast = isSiteMode ? 'Deleted' : 'Removed';
                    const labelVerb = isSiteMode ? 'delete' : 'remove';
                    let finalMessage = '';
                    let finalType = 'success';

                    if (errorEntries.length) {
                        finalType = 'error';
                        finalMessage = `${labelPast} ${deletedCount} file${plural(deletedCount)}, but failed to ${labelVerb} ${errorEntries.length} file${plural(errorEntries.length)}. Check the console for details.`;
                    } else if (deletedCount > 0) {
                        finalType = 'success';
                        finalMessage = `${labelPast} ${deletedCount} file${plural(deletedCount)}.`;
                        if (missingEntries.length) {
                            finalMessage += ` ${missingEntries.length} file${plural(missingEntries.length)} were already missing.`;
                        }
                    } else if (missingEntries.length) {
                        finalType = 'warning';
                        finalMessage = 'No files were removed — they may already be missing from deploy.';
                    } else {
                        finalType = 'warning';
                        finalMessage = `No files were ${labelVerb}d — please verify the selection.`;
                    }

                    selectedPaths.clear();
                    document.querySelectorAll('.file-select-checkbox').forEach(cb => { cb.checked = false; });
                    const master = document.querySelector('.master-select-checkbox');
                    if (master) master.checked = false;
                    await loadFiles();
                    if (finalMessage) {
                        setStatus(finalMessage, finalType);
                    }
                } catch (error) {
                    console.error('Delete failed', error);
                    const label = isSiteMode ? 'delete' : 'remove';
                    setStatus(`Failed to ${label} files: ${error.message}`, 'error');
                } finally {
                    updateActionButtons();
                }
            }

            if (approveButton) {
                approveButton.addEventListener('click', approveSelectedFiles);
            }
            if (deleteButton) {
                deleteButton.addEventListener('click', deleteSelectedFiles);
            }

            updateActionButtons();

            const bucketParam = params.get('bucket') || 'levante-assets-draft';
            const folderParam = params.get('folder');

            const bucket = bucketParam.replace(/[^a-z0-9\-_.]/gi, '').toLowerCase() || 'levante-assets-draft';
            const fallbackFolder = isSiteMode ? 'audio/' : 'deploy/';
            const sanitizedFolder = (folderParam || fallbackFolder)
                .replace(/\.+/g, '')
                .replace(/^\/+/g, '')
                .replace(/\/+$/g, '');
            const prefix = sanitizedFolder ? `${sanitizedFolder}/` : fallbackFolder;

            document.title = sanitizedFolder
                ? `${isAdminMode ? 'Promote Site-Approved Audio' : 'Review Alternative Audio Clips'} • ${sanitizedFolder}`
                : `${isAdminMode ? 'Promote Site-Approved Audio' : 'Review Alternative Audio Clips'} • ${isSiteMode ? 'audio' : 'deploy'}`;

            folderInfoEl.textContent = `Bucket: ${bucket} • Folder: ${prefix}`;

            function setStatus(message, type) {
                statusEl.textContent = message;
                statusEl.className = `status ${type || ''}`.trim();
            }

            function formatBytes(bytes) {
                const value = Number(bytes);
                if (!Number.isFinite(value) || value <= 0) return '0 bytes';
                const units = ['bytes', 'KB', 'MB', 'GB', 'TB'];
                let index = 0;
                let display = value;
                while (display >= 1024 && index < units.length - 1) {
                    display /= 1024;
                    index += 1;
                }
                const precision = display >= 10 || index === 0 ? 0 : 1;
                return `${display.toFixed(precision)} ${units[index]}`;
            }

            function formatDate(value) {
                if (!value) return '—';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString();
            }

            function buildPublicUrl(path) {
                const safeSegments = path.split('/').map(segment => encodeURIComponent(segment));
                return `https://storage.googleapis.com/${bucket}/${safeSegments.join('/')}`;
            }

            function renderFiles(items) {
                if (!items.length) {
                    contentEl.innerHTML = '<div class="empty-state">No audio files found for this folder.</div>';
                    setStatus(isSiteMode ? 'No draft audio files were found for the selected folder.' : 'No site-approved audio found in deploy/.', 'error');
                    return;
                }

                const visiblePaths = new Set(items.map(item => item.path || ''));
                Array.from(selectedPaths).forEach(path => {
                    if (!visiblePaths.has(path)) {
                        selectedPaths.delete(path);
                    }
                });

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');

                const getStatusInfo = (itemEntry, objectPath) => {
                    const normalized = normalizePath(objectPath);
                    const approvalState = itemEntry?.siteApproval?.status
                        || (itemEntry && itemEntry.approvedBySite ? 'approved' : 'not_approved');

                    if (!normalized) {
                        return { label: 'Not approved', className: 'status-not-approved' };
                    }

                    const isFlagged = deployQueue && Object.prototype.hasOwnProperty.call(deployQueue, normalized);
                    if (isFlagged) {
                        if (approvalState === 'approved') {
                            return { label: 'Ready to push', className: 'status-ready' };
                        }
                        return { label: 'Needs re-approval', className: 'status-stale' };
                    }

                    if (approvalState === 'approved') {
                        return { label: 'Approved by Site', className: 'status-approved' };
                    }
                    if (approvalState === 'stale') {
                        return { label: 'Needs re-approval', className: 'status-stale' };
                    }
                    return { label: 'Not approved', className: 'status-not-approved' };
                };
                const headerLabels = isSiteMode
                    ? ['Select', 'Item ID', 'Language', 'Version', 'Approved by Site', 'Size', 'Updated', 'Preview', 'Download']
                    : ['Select', 'Item ID', 'Language', 'Version', 'Push Status', 'Size', 'Updated', 'Preview', 'Download'];
                headerLabels.forEach((label, idx) => {
                    const th = document.createElement('th');
                    th.textContent = label;
                    if (idx === 0) {
                        th.style.width = '56px';
                        const masterCheckbox = document.createElement('input');
                        masterCheckbox.type = 'checkbox';
                        masterCheckbox.className = 'master-select-checkbox';
                        masterCheckbox.title = 'Select all files';
                        masterCheckbox.addEventListener('change', (event) => {
                            const checked = event.target.checked;
                            document.querySelectorAll('.file-select-checkbox').forEach(cb => {
                                if (cb.disabled) return;
                                cb.checked = checked;
                                toggleSelection(cb.dataset.path, checked);
                            });
                        });
                        th.innerHTML = '';
                        th.appendChild(masterCheckbox);
                    }
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                items.forEach(item => {
                    const row = document.createElement('tr');
                    const objectPath = item.path || '';
                    const fileName = objectPath.split('/').pop() || '';
                    const itemId = item.itemId || (fileName ? fileName.replace(/\.mp3$/i, '') : '—');
                    const languageCode = (() => {
                        const parts = objectPath.split('/').filter(Boolean);
                        if (parts.length >= 2) {
                            return parts[parts.length - 2];
                        }
                        return '—';
                    })();
                    const versionLabel = item.version ? `v${String(item.version).padStart(3, '0')}` : '—';
                    const sizeLabel = formatBytes(item.size || 0);
                    const updatedLabel = formatDate(item.updated || item.timeCreated || item.generation);
                    const publicUrl = objectPath ? buildPublicUrl(objectPath) : null;

                    const selectCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'file-select-checkbox';
                    checkbox.dataset.path = objectPath;
                    checkbox.checked = selectedPaths.has(objectPath);
                    if (!objectPath) {
                        checkbox.disabled = true;
                    } else {
                        checkbox.addEventListener('change', (event) => {
                            toggleSelection(objectPath, event.target.checked);
                        });
                    }
                    selectCell.appendChild(checkbox);
                    row.appendChild(selectCell);

                    const itemCell = document.createElement('td');
                    const codeEl = document.createElement('code');
                    codeEl.textContent = itemId;
                    itemCell.appendChild(codeEl);
                    row.appendChild(itemCell);

                    const languageCell = document.createElement('td');
                    languageCell.textContent = languageCode;
                    row.appendChild(languageCell);

                    const versionCell = document.createElement('td');
                    versionCell.textContent = versionLabel;
                    row.appendChild(versionCell);

                    const approvalCell = document.createElement('td');
                    approvalCell.className = 'site-approval-cell';
                    const siteApproval = item.siteApproval || null;
                    const approvalState = siteApproval?.status || (item.approvedBySite ? 'approved' : 'not_approved');
                    if (siteApproval && (siteApproval.deployUpdated || siteApproval.draftUpdated)) {
                        const deployDate = siteApproval.deployUpdated ? new Date(siteApproval.deployUpdated) : null;
                        const draftDate = siteApproval.draftUpdated ? new Date(siteApproval.draftUpdated) : null;
                        const deployLabel = deployDate && !Number.isNaN(deployDate.getTime()) ? deployDate.toLocaleString() : '—';
                        const draftLabel = draftDate && !Number.isNaN(draftDate.getTime()) ? draftDate.toLocaleString() : '—';
                        approvalCell.title = `Site approval: ${deployLabel}\nLatest draft: ${draftLabel}`;
                    }
                    if (isAdminMode) {
                        const statusInfo = getStatusInfo(item, objectPath);
                        approvalCell.innerHTML = `<span class="status-pill ${statusInfo.className}">${statusInfo.label}</span>`;
                    } else {
                        if (approvalState === 'approved') {
                            approvalCell.innerHTML = '<span class="site-approval-pill is-approved">YES</span>';
                        } else if (approvalState === 'stale') {
                            approvalCell.innerHTML = '<span class="site-approval-pill is-stale">Needs re-approval</span>';
                        } else {
                            approvalCell.innerHTML = '<span class="site-approval-pill">NO</span>';
                        }
                    }
                    row.appendChild(approvalCell);

                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = sizeLabel;
                    row.appendChild(sizeCell);

                    const updatedCell = document.createElement('td');
                    updatedCell.textContent = updatedLabel;
                    row.appendChild(updatedCell);

                    const previewCell = document.createElement('td');
                    if (publicUrl) {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.preload = 'none';
                        audio.src = publicUrl;
                        previewCell.appendChild(audio);
                    } else {
                        previewCell.textContent = '—';
                    }
                    row.appendChild(previewCell);

                    const downloadCell = document.createElement('td');
                    if (publicUrl) {
                        const link = document.createElement('a');
                        link.href = publicUrl;
                        link.textContent = 'Download';
                        link.className = 'download-link';
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                        downloadCell.appendChild(link);
                    } else {
                        downloadCell.textContent = '—';
                    }
                    row.appendChild(downloadCell);

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                contentEl.innerHTML = '';
                contentEl.appendChild(table);

                const masterCheckbox = table.querySelector('.master-select-checkbox');
                if (masterCheckbox) {
                    const totalSelectable = items.filter(item => item.path).length;
                    const selectedCount = items.filter(item => selectedPaths.has(item.path || '')).length;
                    masterCheckbox.checked = totalSelectable > 0 && selectedCount === totalSelectable;
                }

                if (isSiteMode) {
                    setStatus(`Loaded ${items.length} ${items.length === 1 ? 'draft audio file' : 'draft audio files'}.`, 'success');
                } else {
                    setStatus(`Loaded ${items.length} site-approved clip${items.length === 1 ? '' : 's'}. Use the stoplight column to review status.`, 'success');
                }
                updateActionButtons();
            }

            async function loadFiles() {
                try {
                    const url = `/api/list-draft-audio?bucket=${encodeURIComponent(bucket)}&prefix=${encodeURIComponent(prefix)}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(text || `HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    const items = Array.isArray(data.items) ? data.items.slice() : [];
                    items.sort((a, b) => {
                        const dateA = new Date(a.updated || a.timeCreated || 0).getTime();
                        const dateB = new Date(b.updated || b.timeCreated || 0).getTime();
                        return dateB - dateA;
                    });
                    await refreshQueue();
                    renderFiles(items);
                } catch (error) {
                    console.error('Failed to load draft audio list', error);
                    setStatus(`Unable to load audio files: ${error.message}`, 'error');
                    contentEl.innerHTML = '<div class="empty-state">We could not load the audio files. Please try again later.</div>';
                }
            }

            loadFiles();
        })();
    </script>
</body>
</html>
