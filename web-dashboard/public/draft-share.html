<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Approved Patched Audio to Deploy</title>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background:
                radial-gradient(circle at top, rgba(255, 150, 34, 0.18), rgba(15, 23, 42, 0.96)),
                linear-gradient(190deg, #020617 0%, #0b1220 100%);
            color: #e2e8f0;
            margin: 0;
            padding: 0;
        }

        .share-container {
            max-width: 1040px;
            margin: 0 auto;
            padding: 40px 20px 60px;
        }

        header {
            margin-bottom: 28px;
        }

        h1 {
            font-size: 2.3rem;
            margin: 0 0 10px;
            font-weight: 600;
            letter-spacing: 0.03em;
            color: #f8fafc;
        }

        .folder-info {
            font-size: 0.95rem;
            color: rgba(148, 198, 255, 0.75);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .status {
            border-radius: 16px;
            padding: 14px 20px;
            margin-bottom: 22px;
            font-size: 0.95rem;
            background: rgba(3, 12, 28, 0.85);
            color: #38bdf8;
            border: 1px solid rgba(56, 189, 248, 0.35);
            box-shadow: 0 18px 45px rgba(2, 6, 23, 0.45);
        }

        .status.error {
            background: rgba(76, 29, 36, 0.75);
            color: #fca5a5;
            border-color: rgba(248, 113, 113, 0.4);
        }

        .status.success {
            background: rgba(13, 148, 136, 0.22);
            color: #5eead4;
            border-color: rgba(45, 212, 191, 0.4);
        }

        .status.loading {
            background: rgba(120, 53, 15, 0.35);
            color: #fdba74;
            border-color: rgba(251, 191, 36, 0.35);
        }

        .share-content {
            background: rgba(4, 11, 24, 0.82);
            border-radius: 18px;
            box-shadow: 0 28px 70px rgba(2, 6, 23, 0.55);
            padding: 24px 28px;
            overflow-x: auto;
            border: 1px solid rgba(56, 189, 248, 0.25);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th, td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid rgba(56, 189, 248, 0.12);
        }

        th {
            background: rgba(56, 189, 248, 0.12);
            font-weight: 600;
            color: #f8fafc;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(59, 130, 246, 0.12);
        }

        code {
            background: rgba(15, 23, 42, 0.8);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #93c5fd;
        }

        .empty-state {
            padding: 36px 0;
            text-align: center;
            color: rgba(148, 163, 184, 0.75);
        }

        .download-link {
            color: #38bdf8;
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .download-link:hover {
            text-decoration: underline;
        }

        audio {
            width: 240px;
            max-width: 100%;
            filter: saturate(1.2);
        }

        @media (max-width: 640px) {
            .share-container {
                padding: 28px 16px 36px;
            }

            h1 {
                font-size: 1.9rem;
            }

            th, td {
                padding: 10px;
            }

            audio {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="share-container">
        <header>
            <h1>Approved Patched Audio to Deploy</h1>
            <div id="folderInfo" class="folder-info">Preparing share view…</div>
        </header>

        <div id="status" class="status loading">Loading draft audio…</div>

        <div id="content" class="share-content">
            <div class="empty-state">Fetching draft audio files…</div>
        </div>
    </div>

    <script>
        (function () {
            const statusEl = document.getElementById('status');
            const contentEl = document.getElementById('content');
            const folderInfoEl = document.getElementById('folderInfo');

            const params = new URLSearchParams(window.location.search);
            const bucketParam = params.get('bucket') || 'levante-assets-draft';
            const folderParam = params.get('folder') || 'audio/';

            const bucket = bucketParam.replace(/[^a-z0-9\-_.]/gi, '').toLowerCase() || 'levante-assets-draft';
            const sanitizedFolder = folderParam
                .replace(/\.\.+/g, '')
                .replace(/^\/+/, '')
                .replace(/\/+$/, '');
            const prefix = sanitizedFolder ? `${sanitizedFolder}/` : 'audio/';

            document.title = sanitizedFolder
                ? `Draft Audio • ${sanitizedFolder}`
                : 'Draft Audio • All';

            folderInfoEl.textContent = `Bucket: ${bucket} • Folder: ${prefix}`;

            function setStatus(message, type) {
                statusEl.textContent = message;
                statusEl.className = `status ${type || ''}`.trim();
            }

            function formatBytes(bytes) {
                const value = Number(bytes);
                if (!Number.isFinite(value) || value <= 0) return '0 bytes';
                const units = ['bytes', 'KB', 'MB', 'GB', 'TB'];
                let index = 0;
                let display = value;
                while (display >= 1024 && index < units.length - 1) {
                    display /= 1024;
                    index += 1;
                }
                const precision = display >= 10 || index === 0 ? 0 : 1;
                return `${display.toFixed(precision)} ${units[index]}`;
            }

            function formatDate(value) {
                if (!value) return '—';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString();
            }

            function buildPublicUrl(path) {
                const safeSegments = path.split('/').map(segment => encodeURIComponent(segment));
                return `https://storage.googleapis.com/${bucket}/${safeSegments.join('/')}`;
            }

            function renderFiles(items) {
                if (!items.length) {
                    contentEl.innerHTML = '<div class="empty-state">No audio files found for this folder.</div>';
                    setStatus('No draft audio files were found for the selected folder.', 'error');
                    return;
                }

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Item ID', 'Language', 'Version', 'Size', 'Updated', 'Preview', 'Download'].forEach(label => {
                    const th = document.createElement('th');
                    th.textContent = label;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                items.forEach(item => {
                    const row = document.createElement('tr');
                    const itemId = item.itemId || (item.path || '').split('/').pop()?.replace(/\.mp3$/i, '') || '—';
                    const languageCode = (() => {
                        const path = item.path || '';
                        const parts = path.split('/').filter(Boolean);
                        const audioIndex = parts.indexOf('audio');
                        if (audioIndex >= 0 && parts.length > audioIndex + 1) {
                            return parts[audioIndex + 1];
                        }
                        if (parts.length >= 2) {
                            return parts[parts.length - 2];
                        }
                        return '—';
                    })();
                    const versionLabel = item.version ? `v${String(item.version).padStart(3, '0')}` : '—';
                    const sizeLabel = formatBytes(item.size || 0);
                    const updatedLabel = formatDate(item.updated || item.timeCreated || item.generation);
                    const publicUrl = item.path ? buildPublicUrl(item.path) : null;

                    const itemCell = document.createElement('td');
                    const codeEl = document.createElement('code');
                    codeEl.textContent = itemId;
                    itemCell.appendChild(codeEl);
                    row.appendChild(itemCell);

                    const languageCell = document.createElement('td');
                    languageCell.textContent = languageCode;
                    row.appendChild(languageCell);

                    const versionCell = document.createElement('td');
                    versionCell.textContent = versionLabel;
                    row.appendChild(versionCell);

                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = sizeLabel;
                    row.appendChild(sizeCell);

                    const updatedCell = document.createElement('td');
                    updatedCell.textContent = updatedLabel;
                    row.appendChild(updatedCell);

                    const previewCell = document.createElement('td');
                    if (publicUrl) {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.preload = 'none';
                        audio.src = publicUrl;
                        previewCell.appendChild(audio);
                    } else {
                        previewCell.textContent = '—';
                    }
                    row.appendChild(previewCell);

                    const downloadCell = document.createElement('td');
                    if (publicUrl) {
                        const link = document.createElement('a');
                        link.href = publicUrl;
                        link.textContent = 'Download';
                        link.className = 'download-link';
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                        downloadCell.appendChild(link);
                    } else {
                        downloadCell.textContent = '—';
                    }
                    row.appendChild(downloadCell);

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                contentEl.innerHTML = '';
                contentEl.appendChild(table);
                setStatus(`Loaded ${items.length} draft audio file${items.length === 1 ? '' : 's'}.`, 'success');
            }

            async function loadFiles() {
                try {
                    const url = `/api/list-draft-audio?bucket=${encodeURIComponent(bucket)}&prefix=${encodeURIComponent(prefix)}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(text || `HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    const items = Array.isArray(data.items) ? data.items.slice() : [];
                    items.sort((a, b) => {
                        const dateA = new Date(a.updated || a.timeCreated || 0).getTime();
                        const dateB = new Date(b.updated || b.timeCreated || 0).getTime();
                        return dateB - dateA;
                    });
                    renderFiles(items);
                } catch (error) {
                    console.error('Failed to load draft audio list', error);
                    setStatus(`Unable to load draft audio files: ${error.message}`, 'error');
                    contentEl.innerHTML = '<div class="empty-state">We could not load the draft audio files. Please try again later.</div>';
                }
            }

            loadFiles();
        })();
    </script>
</body>
</html>
