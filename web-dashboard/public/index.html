<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levante Translation & Audio Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1><i class="fas fa-microphone"></i> Levante Translation & Audio Dashboard</h1>
            <div class="header-actions">
                <div class="dropdown help-dropdown" tabindex="0">
                    <button class="btn btn-secondary dropdown-toggle" title="Help and documentation">
                        <i class="fas fa-question-circle"></i> Help
                    </button>
                    <div class="dropdown-menu">
                        <a href="#" onclick="openHelp('docs/README_WebDashboard.md'); return false;">
                            <i class="fas fa-book"></i> Web Dashboard README
                        </a>
                        <a href="#" onclick="openHelp('docs/README_ADD_LANGUAGE.md'); return false;">
                            <i class="fas fa-language"></i> Add Language Guide
                        </a>
                        <a href="#" onclick="openHelp('docs/README_VALIDATION.md'); return false;">
                            <i class="fas fa-clipboard-check"></i> Validation Guide
                        </a>
                        <a href="#" onclick="openAudioCoverage(); return false;">
                            <i class="fas fa-table"></i> Audio Coverage Report
                        </a>
                        <a href="#" onclick="openPreflightReport(); return false;">
                            <i class="fas fa-clipboard-list"></i> Preflight Readiness Report
                        </a>
                        <a href="#" onclick="openSlides(); return false;">
                            <i class="fas fa-sitemap"></i> Translation Pipeline Architecture
                        </a>
                        <a href="#" onclick="openMermaidSlides(); return false;">
                            <i class="fas fa-project-diagram"></i> Pipeline Architecture (Interactive)
                        </a>
                    </div>
                </div>
            </div>
            <p>Multi-language Translation Validation and TTS audio generation</p>
        </div>
        <div class="main-content">
            <div class="controls-section">
                <div class="control-group">
                    <label><i class="fas fa-volume-up"></i> Voice Comparison Tools:</label>
                    <div class="voice-controls">
                        <div class="voice-control">
                            <label for="playhtVoice">PlayHT Voice</label>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <select id="playhtVoice" class="voice-select">
                                    <option value="">Select PlayHT Voice...</option>
                                </select>
                                <button id="copyPlayhtVoice" class="btn btn-secondary" style="padding: 8px 12px; min-width: auto;" title="Copy selected voice name to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="voice-control">
                            <label for="elevenlabsVoice">ElevenLabs Voice</label>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <select id="elevenlabsVoice" class="voice-select">
                                    <option value="">Select ElevenLabs Voice...</option>
                                </select>
                                <button id="copyElevenlabsVoice" class="btn btn-secondary" style="padding: 8px 12px; min-width: auto;" title="Copy selected voice name to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <button id="refreshVoices" class="btn btn-info">
                            <i class="fas fa-sync-alt"></i> Refresh Voices
                        </button>
                        <button id="manageCredentials" class="btn btn-secondary" onclick="openCredentialsModal()" title="Manage API credentials for TTS services">
                            <i class="fas fa-key"></i> Manage Credentials
                        </button>
                        <button id="editLanguageConfig" class="btn btn-warning btn-compact" onclick="openLanguageConfigModal()" title="Edit shared language configuration">
                            <i class="fas fa-language"></i> Edit Language Config
                        </button>
                    </div>
                </div>
                
                <!-- Text Generation Section -->
                <div class="control-group">
                    <label><i class="fas fa-edit"></i> Text to Speech Generation:</label>
                    <div style="display: flex; gap: 15px; width: 100%; align-items: flex-start;">
                        <textarea id="textInput" placeholder="Enter text to convert to speech, or select an item from the table below..." 
                                  style="flex: 1; min-height: 100px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 180px;">
                            <button id="generateAudio" class="btn btn-success">
                                <i class="fas fa-play"></i> Generate Audio
                            </button>
                            <button id="populateSelected" class="btn btn-primary">
                                <i class="fas fa-arrow-down"></i> Use Selected Item
                            </button>
                            <button id="clearText" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear Text
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Translation Validation Panel -->
            <div class="validation-panel">
                <div class="validation-header" onclick="toggleValidationPanel()">
                    <span><i class="fas fa-check-circle"></i> Translation Validation</span>
                    <span class="collapse-icon">▲</span>
                </div>
                <div class="validation-content expanded" id="validationContent">
                    <!-- Validation Controls -->
                    <div class="validation-controls" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <button id="validateSelected" class="btn validation-button btn-compact" onclick="validateSelected()">
                            <i class="fas fa-check-double"></i> Validate Selected
                        </button>
                        <button id="validateAll" class="btn validation-button btn-compact" onclick="validateAll()">
                            <i class="fas fa-check-circle"></i> Validate All
                        </button>
                        <button id="saveValidations" class="btn btn-success btn-compact" onclick="saveValidationsManually()" title="Save validation results to browser storage and shared team storage">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button id="loadValidations" class="btn btn-info btn-compact" onclick="loadValidationsFromShared()" title="Load latest validation results from shared team storage">
                            <i class="fas fa-cloud-download-alt"></i> Load
                        </button>
                        <button id="exportValidations" class="btn btn-secondary btn-compact" onclick="exportValidationsToJSONFile()" title="Download validation results as JSON file for backup">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button id="viewValidations" class="btn btn-info btn-compact" onclick="showValidationSummaryReport()" title="View summary of all validation results">
                            <i class="fas fa-chart-bar"></i> View
                        </button>
                        <button class="btn btn-warning btn-compact" onclick="clearCacheAndReload()" title="Clear localStorage cache and reload data">
                            <i class="fas fa-trash"></i> Clear Cache
                        </button>
                    </div>
                    
                    <!-- Validation Summary -->
                    <div id="validationSummary" style="border-top: 1px solid #e0e0e0; padding-top: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                            <h4 style="margin: 0; color: #333; font-size: 1.1em;"><i class="fas fa-chart-bar"></i> Validation Summary</h4>
                            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #28a745;" id="goodCount">0</span>
                                    <span style="color: #6c757d; font-size: 0.9em;">Good</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #ffc107;" id="warningCount">0</span>
                                    <span style="color: #6c757d; font-size: 0.9em;">Warning</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #dc3545;" id="errorCount">0</span>
                                    <span style="color: #6c757d; font-size: 0.9em;">Review</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 18px; font-weight: bold; color: #6c757d;" id="pendingCount">0</span>
                                    <span style="color: #6c757d; font-size: 0.9em;">Pending</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab-buttons" id="tabButtons"></div>
            </div>
            <div id="tabContent"></div>
        </div>
        <div class="status-bar" id="statusBar">
            <i class="fas fa-circle status-icon loading"></i>
            <span>Loading dashboard...</span>
        </div>
    </div>
    
    <!-- Load Modals -->
    <div id="modals-container"></div>
    
    <!-- Scripts -->
    <script src="./config.js"></script>
    <script>
        async function openHelp(docPath) {
            const helpModal = document.getElementById('helpModal');
            const helpLoading = document.getElementById('helpLoading');
            const helpContent = document.getElementById('helpContent');
            helpContent.innerHTML = '';
            helpLoading.style.display = 'block';
            helpModal.style.display = 'block';

            try {
                const resp = await fetch(docPath);
                const md = await resp.text();
                helpContent.innerHTML = window.marked ? window.marked.parse(md) : md;
            } catch (e) {
                helpContent.innerHTML = '<p style="color:#dc3545;">Failed to load documentation.</p>';
            } finally {
                helpLoading.style.display = 'none';
            }
        }
        function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }
        
        function showValidationResults(itemId, langCode, result, scoreEmoji, score, statusClass) {
            const modal = document.getElementById('validationResultsModal');
            
            // Update title and score
            document.getElementById('validationModalTitle').innerHTML = `<i class="fas fa-clipboard-check"></i> Validation Results - ${itemId}`;
            document.getElementById('validationScoreEmoji').textContent = scoreEmoji;
            document.getElementById('validationScoreText').textContent = `${score}% Similarity`;
            
            // Update status badge
            const statusBadge = document.getElementById('validationStatusBadge');
            statusBadge.className = `validation-status-badge ${statusClass === 'status-good' ? 'excellent' : statusClass === 'status-warning' ? 'warning' : 'poor'}`;
            statusBadge.textContent = statusClass === 'status-good' ? 'Excellent' : statusClass === 'status-warning' ? 'Good (Review)' : 'Poor Quality';
            
            // Update language info
            const languageNames = {
                'en': 'English',
                'es-CO': 'Spanish (Colombia)', 
                'es': 'Spanish',
                'de': 'German',
                'fr-CA': 'French (Canada)',
                'fr': 'French',
                'nl': 'Dutch'
            };
            document.getElementById('validationTargetLang').textContent = languageNames[langCode] || langCode;
            
            // Update text content
            document.getElementById('validationOriginalText').textContent = result.originalText;
            document.getElementById('validationTranslatedText').textContent = result.translatedText;
            document.getElementById('validationBackTranslation').textContent = result.backTranslation;
            document.getElementById('validationNotes').textContent = result.notes;
            
            // Update metadata
            document.getElementById('validationItemId').textContent = itemId;
            document.getElementById('validationLangCode').textContent = langCode;
            document.getElementById('validationTimestamp').textContent = new Date(result.timestamp).toLocaleString();
            
            modal.style.display = 'block';
        }
        
        function closeValidationResultsModal() { 
            document.getElementById('validationResultsModal').style.display = 'none'; 
        }
        
        function closeValidationSummaryModal() {
            document.getElementById('validationSummaryModal').style.display = 'none';
        }
        function openAudioCoverage() {
            window.open('./audio-coverage.html', '_blank');
        }
        function openPreflightReport() {
            window.open('./preflight-report.html', '_blank');
        }
        function openSlides() {
            window.open('./levante-slides.html', '_blank');
        }
        function openMermaidSlides() {
            window.open('./levante-slides-with-mermaid.html', '_blank');
        }
        
        function showValidationSummaryReport() {
            const modal = document.getElementById('validationSummaryModal');
            const header = document.getElementById('validationSummaryHeader');
            const body = document.getElementById('validationSummaryBody');
            const results = window.dashboard?.validation_results || {};
            const languages = window.dashboard?.languages || {};
            
            // Build header chips per language
            header.innerHTML = '';
            const langCodes = Object.values(languages).map(cfg => cfg.lang_code);
            const uniqueLangs = Array.from(new Set(langCodes));
            uniqueLangs.forEach(code => {
                // Count statuses for this language across items
                let good = 0, warning = 0, error = 0, pending = 0;
                Object.keys(results).forEach(itemId => {
                    const r = results[itemId][code];
                    if (!r) { pending++; return; }
                    const score = Math.round((r.score || 0) * 100);
                    if (score >= 85) good++; else if (score >= 70) warning++; else error++;
                });
                const chip = document.createElement('div');
                chip.className = 'summary-chip';
                const total = good + warning + error + pending || 1;
                const goodPct = Math.round((good / total) * 100);
                const warnPct = Math.round((warning / total) * 100);
                const errPct = Math.round((error / total) * 100);
                const pendPct = 100 - goodPct - warnPct - errPct;
                chip.innerHTML = `
                    <div class="summary-line">
                        <span class="label">${code.toUpperCase()}</span>
                        <span class="value">✅ ${good}  ⚠️ ${warning}  ❌ ${error}  ⏳ ${pending}</span>
                    </div>
                    <div class="bar" aria-hidden="true">
                        <div class="bar-seg bar-good" style="width:${goodPct}%"></div>
                        <div class="bar-seg bar-warning" style="width:${warnPct}%"></div>
                        <div class="bar-seg bar-error" style="width:${errPct}%"></div>
                        <div class="bar-seg bar-pending" style="width:${pendPct}%"></div>
                    </div>`;
                header.appendChild(chip);
            });
            
            // Build table of items with per-language dots
            const allItemIds = Object.keys(results);
            const langList = uniqueLangs;
            const table = document.createElement('table');
            table.className = 'summary-table';
            const thead = document.createElement('thead');
            thead.innerHTML = `<tr><th>Item</th>${langList.map(c => `<th>${c.toUpperCase()}</th>`).join('')}</tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            
            allItemIds.forEach(itemId => {
                const tr = document.createElement('tr');
                const tdItem = document.createElement('td');
                tdItem.textContent = itemId;
                tr.appendChild(tdItem);
                
                langList.forEach(code => {
                    const td = document.createElement('td');
                    const r = results[itemId][code];
                    let cls = 'dot-pending';
                    if (r) {
                        const score = Math.round((r.score || 0) * 100);
                        if (score >= 85) cls = 'dot-good'; else if (score >= 70) cls = 'dot-warning'; else cls = 'dot-error';
                        td.title = `${score}% - ${r.notes || ''}`;
                        td.style.cursor = 'pointer';
                        td.onclick = () => showValidationResults(itemId, code, r, score >= 85 ? '✅' : score >= 70 ? '⚠️' : '❌', score, score >= 85 ? 'status-good' : score >= 70 ? 'status-warning' : 'status-error');
                    } else {
                        td.title = 'Pending - Not validated';
                    }
                    td.innerHTML = `<span class="status-dot ${cls}"></span>`;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            body.innerHTML = '';
            body.appendChild(table);
            
            modal.style.display = 'block';
        }
    </script>
    <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="./js-compiled/utils.js"></script>
    <script src="./js-compiled/credentials.js"></script>
    <script src="./js/validation.js"></script>
    <script src="./js-compiled/audio.js"></script>
    <script src="./js-compiled/language-config.js"></script>
    <script src="./dashboard.js"></script>
    <script src="./js-compiled/bootstrap.js"></script>
    
    <script>
        // Load modals dynamically
        fetch('./modals.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modals-container').innerHTML = html;
            })
            .catch(error => console.warn('Could not load modals:', error));
    </script>
</body>
</html>
