name: Deploy and Test

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-cloud-storage pandas
        
    - name: Install Node dependencies
      run: npm install
      
    - name: Validate CSV files exist
      run: |
        if [ -f "translation_text/item_bank_translations.csv" ]; then
          echo "âœ… Translation file found"
          wc -l translation_text/item_bank_translations.csv
        else
          echo "âŒ Translation file missing"
          exit 1
        fi
      
    - name: Test Levante deployment (dry run)
      run: npm run deploy:levante-dev-dry
      env:
        # Mock credentials for testing
        GOOGLE_APPLICATION_CREDENTIALS_JSON: '{"type":"service_account","project_id":"test"}'
      
    - name: Test CSV utilities
      run: npm run fix:csv
      continue-on-error: true  # May fail without actual CSV issues
      
    - name: Validate npm scripts
      run: |
        npm run help
        echo "âœ… All npm scripts are properly configured"
    
    # Check if credentials are available
    - name: Check deployment credentials
      id: check-creds
      run: |
        # Check dev credentials
        if [ -n "$DEV_CREDS" ]; then
          echo "dev-credentials-available=true" >> $GITHUB_OUTPUT
          echo "âœ… Dev deployment credentials are configured"
        else
          echo "dev-credentials-available=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Dev deployment credentials not configured"
        fi
        
        # Check prod credentials  
        if [ -n "$PROD_CREDS" ]; then
          echo "prod-credentials-available=true" >> $GITHUB_OUTPUT
          echo "âœ… Prod deployment credentials are configured"
        else
          echo "prod-credentials-available=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Prod deployment credentials not configured"
        fi
        
        # Set overall credentials flag
        if [ -n "$DEV_CREDS" ] || [ -n "$PROD_CREDS" ]; then
          echo "credentials-available=true" >> $GITHUB_OUTPUT
        else
          echo "credentials-available=false" >> $GITHUB_OUTPUT
          echo "To enable deployment, add GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV and/or GOOGLE_APPLICATION_CREDENTIALS_JSON_PROD secrets"
        fi
      env:
        DEV_CREDS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV }}
        PROD_CREDS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON_PROD }}
    
    # Deploy to dev bucket on PR for testing
    - name: Deploy to dev bucket (PR)
      if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.check-creds.outputs.dev-credentials-available == 'true'
      run: |
        echo "ğŸš€ Deploying to dev environment..."
        npm run deploy:levante-dev
        echo "âœ… Dev deployment completed"
      env:
        GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV }}
      
    - name: Skip dev deployment (no credentials)
      if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && steps.check-creds.outputs.dev-credentials-available == 'false'
      run: |
        echo "â­ï¸ Skipping dev deployment - no dev credentials configured"
        echo "To enable dev deployment, add GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV secret"
      
    # Deploy to dev bucket on main branch merge (for testing before prod)
    - name: Deploy to dev (main branch)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.check-creds.outputs.dev-credentials-available == 'true'
      run: |
        echo "ğŸš€ Deploying to dev environment..."
        npm run deploy:levante-dev
        echo "âœ… Dev deployment completed"
      env:
        GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV }}
        
    - name: Skip dev deployment (no credentials)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.check-creds.outputs.dev-credentials-available == 'false'
      run: |
        echo "â­ï¸ Skipping dev deployment - no dev credentials configured"
        echo "To enable dev deployment, add GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV secret"
        
    # Generate GitHub App token for cross-repo access
    - name: Generate GitHub App Token
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      id: app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.GITHUB_APP_ID }}
        private-key: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}
        owner: levante-framework
        repositories: core-tasks
    
    # Check if we can trigger core-tasks e2e tests
    - name: Check e2e test trigger availability
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      id: check-e2e-trigger
      run: |
        if [ -n "${{ secrets.GITHUB_APP_ID }}" ] && [ -n "${{ secrets.GITHUB_APP_PRIVATE_KEY }}" ]; then
          echo "e2e-trigger-available=true" >> $GITHUB_OUTPUT
          echo "âœ… E2E test triggering is configured (GitHub App)"
        elif [ -n "${{ secrets.REPO_DISPATCH_TOKEN }}" ]; then
          echo "e2e-trigger-available=true" >> $GITHUB_OUTPUT
          echo "âœ… E2E test triggering is configured (PAT - fallback)"
        else
          echo "e2e-trigger-available=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ E2E test triggering not configured - GitHub App or REPO_DISPATCH_TOKEN secrets missing"
        fi
    
    # Trigger core-tasks e2e tests after successful main branch push
    - name: Trigger core-tasks e2e tests
      if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.check-e2e-trigger.outputs.e2e-trigger-available == 'true'
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ steps.app-token.outputs.token || secrets.REPO_DISPATCH_TOKEN }}
        repository: levante-framework/core-tasks
        event-type: translations-updated
        client-payload: |
          {
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "repository": "${{ github.repository }}",
            "deployment_environment": "dev",
            "translations_bucket": "levante-dashboard-dev",
            "triggered_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
      
    - name: Summary
      run: |
        echo "ğŸ‰ Workflow completed successfully!"
        echo "ğŸ“Š Summary:"
        echo "   - Event: ${{ github.event_name }}"
        echo "   - Branch: ${{ github.ref }}"
        echo "   - Dev Credentials: ${{ steps.check-creds.outputs.dev-credentials-available == 'true' && 'âœ… Configured' || 'âš ï¸ Missing' }}"
        echo "   - Prod Credentials: ${{ steps.check-creds.outputs.prod-credentials-available == 'true' && 'âœ… Configured' || 'âš ï¸ Missing' }}"
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ steps.check-creds.outputs.dev-credentials-available }}" = "true" ]; then
            echo "   - Action: âœ… Tested and deployed to dev"
          else
            echo "   - Action: âœ… Tested (dev deployment skipped - no dev credentials)"
          fi
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          dev_deployed="${{ steps.check-creds.outputs.dev-credentials-available == 'true' && 'âœ… deployed to dev' || 'âš ï¸ dev deployment skipped' }}"
          e2e_triggered="${{ steps.check-e2e-trigger.outputs.e2e-trigger-available == 'true' && 'âœ… triggered e2e tests' || 'âš ï¸ e2e trigger skipped' }}"
          echo "   - Action: âœ… Tested, $dev_deployed, $e2e_triggered"
        else
          echo "   - Action: âœ… Testing only"
        fi
        
        if [ "${{ steps.check-creds.outputs.dev-credentials-available }}" = "false" ] || [ "${{ steps.check-creds.outputs.prod-credentials-available }}" = "false" ]; then
          echo ""
          echo "ğŸ’¡ To enable automatic deployment:"
          echo "   1. Go to repository Settings â†’ Secrets and variables â†’ Actions"
          if [ "${{ steps.check-creds.outputs.dev-credentials-available }}" = "false" ]; then
            echo "   2. Add secret: GOOGLE_APPLICATION_CREDENTIALS_JSON_DEV"
          fi
          if [ "${{ steps.check-creds.outputs.prod-credentials-available }}" = "false" ]; then
            echo "   3. Add secret: GOOGLE_APPLICATION_CREDENTIALS_JSON_PROD"
          fi
          echo "   4. Value: Complete JSON from your service account key"
        fi
        
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo ""
          echo "ğŸ”— Core-tasks e2e tests:"
          if [ "${{ steps.check-e2e-trigger.outputs.e2e-trigger-available }}" = "true" ]; then
            echo "   âœ… Will trigger automatically after main branch merge"
          else
            echo "   âš ï¸ Requires REPO_DISPATCH_TOKEN secret to trigger core-tasks e2e tests"
            echo "   ğŸ’¡ Create a GitHub PAT with 'repo' scope and add as REPO_DISPATCH_TOKEN secret"
          fi
        fi
    - name: Test CSV fix utility
      run: npm run fix:csv
      continue-on-error: true  # May fail without actual CSV issues
      
    - name: Validate package.json scripts
      run: |
        npm run help
        echo "âœ… All npm scripts are properly configured"
